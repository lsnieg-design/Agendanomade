<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raspanti Docente</title>
    
    <meta name="theme-color" content="#800020">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        raspanti: {
                            bordo: '#800020',
                            crema: '#FFFDD0',
                            dorado: '#C5B358',
                            doradoDark: '#A08F30',
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .fab { transition: all 0.2s; }
        .fab:active { transform: scale(0.95); }

        /* Prioridades Tareas */
        .priority-high { border-left: 4px solid #EF4444; }
        .priority-normal { border-left: 4px solid #F59E0B; }
        .priority-low { border-left: 4px solid #10B981; }

        /* Estilos Tablas */
        .table-header { @apply px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0 border-b border-gray-200; }
        .table-cell { @apply px-3 py-3 whitespace-nowrap text-sm text-gray-700 border-b border-gray-100; }
        .input-nota { @apply w-12 p-2 text-center rounded-lg border border-gray-200 font-bold focus:outline-none focus:border-raspanti-dorado focus:ring-1 focus:ring-raspanti-dorado transition; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 font-sans bg-slate-50">

    <div id="loading-screen" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-raspanti-bordo mb-4"></div>
        <p class="text-raspanti-bordo font-bold animate-pulse tracking-widest">RASPANTI APP</p>
    </div>

    <div id="auth-screen" class="fixed inset-0 bg-gradient-to-br from-raspanti-bordo to-red-900 z-50 flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-[35px] shadow-2xl p-8 w-full max-w-md border-t-8 border-raspanti-dorado relative">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center border-4 border-raspanti-dorado mb-4 shadow-inner">
                    <span class="text-4xl font-black text-raspanti-bordo">R</span>
                </div>
                <h1 class="text-2xl font-extrabold text-raspanti-bordo uppercase leading-none">INSTITUTO<br><span class="text-raspanti-dorado">RASPANTI</span></h1>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="relative"><i data-lucide="user" class="absolute left-4 top-3.5 text-raspanti-dorado w-5 h-5"></i><input type="email" id="email" class="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-raspanti-dorado" placeholder="Email" required></div>
                <div class="relative"><i data-lucide="lock" class="absolute left-4 top-3.5 text-raspanti-dorado w-5 h-5"></i><input type="password" id="password" class="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-raspanti-dorado" placeholder="ContraseÃ±a" required></div>
                <button type="submit" class="w-full bg-gradient-to-r from-raspanti-bordo to-red-800 text-white py-4 rounded-2xl font-bold text-lg shadow-xl mt-6 flex justify-center gap-2 items-center">INGRESAR <i data-lucide="arrow-right" class="w-5 h-5"></i></button>
            </form>
        </div>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden">
        
        <header class="bg-raspanti-bordo text-white shadow-lg px-6 py-4 flex justify-between items-center z-20 rounded-b-[30px]">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-1 rounded-lg shadow-sm"><span class="font-black text-raspanti-bordo px-2">R</span></div>
                <div><h1 class="font-bold text-sm uppercase tracking-wide">Raspanti Digital</h1><p class="text-[10px] text-raspanti-dorado uppercase font-bold">Docente</p></div>
            </div>
            <button onclick="logout()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center"><i data-lucide="log-out" class="text-white w-5 h-5"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto pb-28 px-4 pt-6 w-full max-w-md mx-auto no-scrollbar relative">
            
            <div id="view-dashboard" class="fade-in space-y-5">
                <div class="bg-white p-6 rounded-[35px] shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-raspanti-bordo tracking-tight">Â¡Hola! ðŸ‘‹</h2>
                    <p class="text-sm text-gray-500">Resumen Semanal</p>
                </div>

                <div class="bg-white p-5 rounded-[30px] shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="check-square" class="text-raspanti-dorado"></i> Tareas</h3>
                        <button onclick="openModal('modal-tarea')" class="bg-raspanti-crema text-raspanti-bordo p-1.5 rounded-lg hover:bg-raspanti-dorado hover:text-white transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div id="lista-tareas" class="space-y-2">
                        <p class="text-xs text-gray-400 text-center py-2">Cargando...</p>
                    </div>
                    <div id="empty-tareas" class="hidden text-center text-xs text-gray-400 py-2">Â¡Todo al dÃ­a! ðŸŽ‰</div>
                </div>

                <div class="bg-raspanti-bordo text-white p-5 rounded-[30px] shadow-lg relative overflow-hidden">
                    <h3 class="font-bold text-lg mb-1">Tu Agenda Hoy</h3>
                    <p class="text-[10px] uppercase font-bold opacity-80 mb-4" id="dia-dashboard">--</p>
                    <div id="lista-clases-hoy" class="space-y-2 relative z-10"><p class="text-xs opacity-70">Cargando agenda...</p></div>
                    <i data-lucide="calendar" class="absolute -right-4 -bottom-4 opacity-10 w-32 h-32"></i>
                </div>
            </div>

            <div id="view-materias" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-raspanti-bordo">Mis Materias</h2>
                    <button onclick="openModal('modal-materia')" class="bg-raspanti-bordo text-white p-3 rounded-xl shadow-lg fab"><i data-lucide="plus" class="w-6 h-6"></i></button>
                </div>
                <div id="materias-container" class="space-y-3 pb-20"></div>
                <div id="empty-state" class="hidden text-center py-10 opacity-60"><p>Sin materias aÃºn.</p></div>
            </div>

            <div id="view-aula" class="hidden fade-in space-y-4">
                <button onclick="navigate('materias')" class="flex items-center gap-2 text-gray-500 font-bold text-xs uppercase mb-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver a materias</button>
                <div class="bg-white p-6 rounded-[35px] shadow-sm border border-gray-100">
                    <h2 id="aula-titulo" class="text-2xl font-black text-raspanti-bordo leading-none">Materia</h2>
                    <p id="aula-info" class="text-sm text-gray-500 mt-2 font-medium">--</p>
                </div>

                <div class="flex p-1 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-x-auto">
                    <button onclick="cambiarTabAula('alumnos')" id="tab-alumnos" class="flex-1 py-3 px-2 rounded-xl text-[10px] font-bold uppercase transition-all bg-gray-100 text-raspanti-bordo whitespace-nowrap">Alumnos</button>
                    <button onclick="cambiarTabAula('asistencia')" id="tab-asistencia" class="flex-1 py-3 px-2 rounded-xl text-[10px] font-bold uppercase text-gray-400 transition-all whitespace-nowrap">Asistencia</button>
                    <button onclick="cambiarTabAula('notas')" id="tab-notas" class="flex-1 py-3 px-2 rounded-xl text-[10px] font-bold uppercase text-gray-400 transition-all whitespace-nowrap">Notas</button>
                    <button onclick="cambiarTabAula('planilla')" id="tab-planilla" class="flex-1 py-3 px-2 rounded-xl text-[10px] font-bold uppercase text-gray-400 transition-all whitespace-nowrap">Reporte</button>
                </div>

                <div id="content-alumnos" class="aula-tab-content">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h3 class="font-bold text-gray-700">PadrÃ³n</h3>
                        <button onclick="openModal('modal-alumno')" class="text-xs bg-raspanti-dorado text-white px-3 py-2 rounded-lg font-bold shadow fab flex gap-1 items-center"><i data-lucide="user-plus" class="w-3 h-3"></i> AGREGAR</button>
                    </div>
                    <div id="lista-alumnos" class="space-y-2"></div>
                </div>

                <div id="content-asistencia" class="aula-tab-content hidden">
                    <div id="vista-lista-clases">
                        <div class="flex justify-between items-center mb-4 px-2">
                            <h3 class="font-bold text-gray-700">Historial</h3>
                            <button onclick="openModal('modal-fecha')" class="text-xs bg-raspanti-bordo text-white px-3 py-2 rounded-lg font-bold shadow fab flex gap-1 items-center"><i data-lucide="calendar-plus" class="w-3 h-3"></i> NUEVA CLASE</button>
                        </div>
                        <div id="container-clases" class="space-y-2"></div>
                        <div id="empty-clases" class="text-center py-8 opacity-50 text-sm hidden">Sin clases registradas.</div>
                    </div>
                    <div id="vista-tomar-lista" class="hidden">
                         <button onclick="volverAListaClases()" class="mb-3 text-xs font-bold text-gray-400 flex items-center gap-1"><i data-lucide="chevron-left" class="w-3 h-3"></i> Volver</button>
                         <div class="flex justify-between items-center mb-4 px-2 bg-white p-3 rounded-2xl border border-raspanti-dorado">
                            <div><p class="text-[10px] text-gray-400 font-bold uppercase">ASISTENCIA</p><h3 class="font-bold text-raspanti-bordo text-lg" id="titulo-fecha-activa">--/--/--</h3></div>
                            <button onclick="guardarAsistencia()" class="text-xs bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow fab flex gap-2 items-center"><i data-lucide="save" class="w-3 h-3"></i> GUARDAR</button>
                        </div>
                        <div id="lista-check-alumnos" class="space-y-2 pb-10"></div>
                    </div>
                </div>

                <div id="content-notas" class="aula-tab-content hidden">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h3 class="font-bold text-gray-700">Libro de Notas</h3>
                        <button onclick="openModal('modal-columna')" class="text-xs bg-raspanti-bordo text-white px-3 py-2 rounded-lg font-bold shadow fab flex gap-1 items-center"><i data-lucide="plus-circle" class="w-3 h-3"></i> COLUMNA</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto pb-4">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead><tr id="header-notas"><th class="table-header">Alumno</th><th class="table-header text-center w-16 bg-gray-100">Prom.</th></tr></thead>
                            <tbody id="body-notas" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="empty-notas" class="p-6 text-center text-sm text-gray-400 hidden">Crea una columna (ej: TP 1) para empezar.</div>
                    </div>
                </div>

                <div id="content-planilla" class="aula-tab-content hidden">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h3 class="font-bold text-gray-700">SituaciÃ³n AcadÃ©mica</h3>
                        <button onclick="cargarPlanilla()" class="p-2 bg-gray-100 rounded-lg"><i data-lucide="refresh-cw" class="w-4 h-4 text-gray-500"></i></button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead><tr><th class="table-header">Alumno</th><th class="table-header text-center">Asist. %</th><th class="table-header text-center">Nota Prom.</th></tr></thead>
                            <tbody id="tabla-planilla-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <nav id="bottom-nav" class="fixed bottom-0 w-full bg-white border-t border-gray-100 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-30 rounded-t-[30px]">
            <div class="flex justify-around items-center h-20 max-w-md mx-auto px-2">
                <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-btn active flex flex-col items-center justify-center w-full h-full pt-2">
                    <div class="icon-p bg-gray-100 text-raspanti-bordo p-1.5 rounded-xl transition mb-1"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-gray-600">Inicio</span>
                </button>
                <button onclick="navigate('materias')" id="nav-materias" class="nav-btn opacity-50 flex flex-col items-center justify-center w-full h-full pt-2">
                    <div class="icon-p p-1.5 rounded-xl transition mb-1"><i data-lucide="book" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-gray-400">Materias</span>
                </button>
            </div>
        </nav>
    </div>

    <div id="modal-materia" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden fade-in">
        <div class="bg-white rounded-[35px] w-full max-w-sm p-6 shadow-2xl relative">
            <button onclick="closeModal('modal-materia')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-black text-raspanti-bordo mb-4">Nueva Materia</h3>
            <form id="form-materia" class="space-y-4">
                <input type="text" id="materia-nombre" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" placeholder="Nombre (Ej: MatemÃ¡tica)" required>
                <div class="grid grid-cols-2 gap-3">
                    <select id="materia-dia" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none"><option>Lunes</option><option>Martes</option><option>MiÃ©rcoles</option><option>Jueves</option><option>Viernes</option></select>
                    <select id="materia-asistencia" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none"><option value="75">75%</option><option value="60">60%</option></select>
                </div>
                <button type="submit" class="w-full bg-raspanti-bordo text-white py-4 rounded-2xl font-black shadow-lg">GUARDAR</button>
            </form>
        </div>
    </div>

    <div id="modal-alumno" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden fade-in">
        <div class="bg-white rounded-[35px] w-full max-w-sm p-6 shadow-2xl relative">
            <button onclick="closeModal('modal-alumno')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-black text-raspanti-bordo mb-4">Nuevo Alumno</h3>
            <form id="form-alumno" class="space-y-4">
                <input type="text" id="alumno-apellido" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" placeholder="Apellido" required>
                <input type="text" id="alumno-nombre" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" placeholder="Nombre" required>
                <button type="submit" class="w-full bg-raspanti-dorado text-raspanti-bordo py-4 rounded-2xl font-black shadow-lg">AGREGAR</button>
            </form>
        </div>
    </div>

    <div id="modal-fecha" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden fade-in">
        <div class="bg-white rounded-[35px] w-full max-w-sm p-6 shadow-2xl relative">
            <button onclick="closeModal('modal-fecha')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-black text-raspanti-bordo mb-4">Nueva Clase</h3>
            <form id="form-fecha" class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-2">Selecciona Fecha</label><input type="date" id="input-fecha-clase" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" required></div>
                <button type="submit" class="w-full bg-raspanti-bordo text-white py-4 rounded-2xl font-black shadow-lg">CREAR</button>
            </form>
        </div>
    </div>

    <div id="modal-columna" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden fade-in">
        <div class="bg-white rounded-[35px] w-full max-w-sm p-6 shadow-2xl relative">
            <button onclick="closeModal('modal-columna')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-black text-raspanti-bordo mb-4">Nueva EvaluaciÃ³n</h3>
            <form id="form-columna" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-2">Nombre</label>
                    <input type="text" id="columna-nombre" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" placeholder="Ej: 1Â° Parcial" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-2">Fecha (Para agenda)</label>
                    <input type="date" id="columna-fecha" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none">
                </div>
                <button type="submit" class="w-full bg-raspanti-bordo text-white py-4 rounded-2xl font-black shadow-lg">CREAR Y AGENDAR</button>
            </form>
        </div>
    </div>

    <div id="modal-tarea" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden fade-in">
        <div class="bg-white rounded-[35px] w-full max-w-sm p-6 shadow-2xl relative">
            <button onclick="closeModal('modal-tarea')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-black text-raspanti-bordo mb-4">Nueva Tarea</h3>
            <form id="form-tarea" class="space-y-4">
                <input type="text" id="tarea-titulo" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" placeholder="TÃ­tulo (Ej: Subir notas)" required>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-2">Vencimiento</label>
                    <input type="date" id="tarea-fecha" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-2">Prioridad</label>
                    <select id="tarea-prioridad" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none">
                        <option value="high">Alta (Urgente)</option>
                        <option value="normal" selected>Normal</option>
                        <option value="low">Baja</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-raspanti-bordo text-white py-4 rounded-2xl font-black shadow-lg">GUARDAR TAREA</button>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBpBjGm2jdqlearWnBiwn4jxjeby3nA0gk",
            authDomain: "raspanti-app.firebaseapp.com",
            projectId: "raspanti-app",
            storageBucket: "raspanti-app.firebasestorage.app",
            messagingSenderId: "898404256450",
            appId: "1:898404256450:web:8ba27e3350b8efb22c095b",
            measurementId: "G-QMMLBB5NJM"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;
        let materiaActivaId = null;
        let alumnosCache = [];
        let columnasNotasCache = [];
        let fechaActiva = null; 
        
        // Listeners
        let unsubscribeAlumnos = null;
        let unsubscribeClases = null;
        let unsubscribeColumnas = null;
        let unsubscribeTareas = null;

        lucide.createIcons();
        
        auth.onAuthStateChanged(user => {
            document.getElementById('loading-screen').classList.add('hidden');
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                initDashboard();
                cargarTareas(); // Cargar tareas al inicio
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await auth.signInWithEmailAndPassword(email, pass); } catch (e) { alert(e.message); }
        });

        window.logout = () => auth.signOut();

        // --- DASHBOARD ---
        function initDashboard() {
            const days = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
            const today = days[new Date().getDay()];
            document.getElementById('dia-dashboard').innerText = today;

            db.collection("materias").where("userId", "==", currentUser.uid).orderBy("createdAt", "desc")
                .onSnapshot(snap => {
                    const cont = document.getElementById('materias-container');
                    const listaHoy = document.getElementById('lista-clases-hoy');
                    cont.innerHTML = ''; listaHoy.innerHTML = '';

                    if(snap.empty) {
                        document.getElementById('empty-state').classList.remove('hidden');
                        listaHoy.innerHTML = '<span class="text-sm opacity-60">Sin materias</span>';
                    } else {
                        document.getElementById('empty-state').classList.add('hidden');
                        let hayClasesHoy = false;
                        snap.forEach(doc => {
                            const d = doc.data();
                            const div = document.createElement('div');
                            div.className = 'bg-white p-5 rounded-[30px] border border-gray-100 shadow-sm flex justify-between items-center fab cursor-pointer mb-2';
                            div.innerHTML = `<div onclick="entrarAula('${doc.id}', '${d.nombre}')" class="flex-1 flex items-center gap-4"><div class="w-12 h-12 bg-raspanti-crema text-raspanti-bordo rounded-2xl flex items-center justify-center font-black border-2 border-white shadow">${d.nombre[0]}</div><div><h3 class="font-bold text-gray-800">${d.nombre}</h3><span class="text-[10px] font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded-lg uppercase">${d.dia}</span></div></div><button onclick="borrarMateria('${doc.id}')"><i data-lucide="trash-2" class="text-gray-300 hover:text-red-500 w-5 h-5"></i></button>`;
                            cont.appendChild(div);

                            if(d.dia === today) {
                                hayClasesHoy = true;
                                const item = document.createElement('div');
                                item.className = 'bg-white/10 p-2 rounded-lg flex items-center gap-2 mb-1';
                                item.innerHTML = `<div class="w-2 h-2 bg-raspanti-dorado rounded-full"></div><span class="text-sm font-bold">${d.nombre}</span>`;
                                listaHoy.appendChild(item);
                            }
                        });
                        if(!hayClasesHoy) listaHoy.innerHTML = '<span class="text-sm opacity-60">Hoy no tienes clases presenciales.</span>';
                        lucide.createIcons();
                    }
                });
        }

        // --- TAREAS (NUEVO) ---
        function cargarTareas() {
            if(unsubscribeTareas) unsubscribeTareas();
            const list = document.getElementById('lista-tareas');
            const empty = document.getElementById('empty-tareas');
            
            // ColecciÃ³n global de tareas del usuario
            unsubscribeTareas = db.collection("usuarios").doc(currentUser.uid).collection("tareas")
                .orderBy("fecha", "asc")
                .onSnapshot(snap => {
                    list.innerHTML = '';
                    if(snap.empty) {
                        empty.classList.remove('hidden');
                    } else {
                        empty.classList.add('hidden');
                        snap.forEach(doc => {
                            const t = doc.data();
                            let priorityClass = 'priority-normal';
                            if(t.prioridad === 'high') priorityClass = 'priority-high';
                            if(t.prioridad === 'low') priorityClass = 'priority-low';
                            
                            // Formatear fecha
                            const [y, m, d] = t.fecha.split('-');

                            const div = document.createElement('div');
                            div.className = `bg-gray-50 p-3 rounded-2xl flex justify-between items-center ${priorityClass} bg-white shadow-sm border border-gray-100`;
                            div.innerHTML = `
                                <div>
                                    <h4 class="text-sm font-bold text-gray-700">${t.titulo}</h4>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase mt-0.5">Vence: ${d}/${m}</p>
                                </div>
                                <button onclick="completarTarea('${doc.id}')" class="w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center hover:bg-green-100 hover:border-green-400 text-transparent hover:text-green-600 transition">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </button>
                            `;
                            list.appendChild(div);
                        });
                        lucide.createIcons();
                    }
                });
        }

        document.getElementById('form-tarea').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Cierre inmediato UI
            const titulo = document.getElementById('tarea-titulo').value;
            const fecha = document.getElementById('tarea-fecha').value;
            const prio = document.getElementById('tarea-prioridad').value;
            
            document.getElementById('form-tarea').reset();
            closeModal('modal-tarea');

            // Guardar BG
            await db.collection("usuarios").doc(currentUser.uid).collection("tareas").add({
                titulo: titulo,
                fecha: fecha,
                prioridad: prio,
                completed: false,
                createdAt: Date.now()
            });
        });

        window.completarTarea = (id) => {
            // Borrar tarea (o marcar completada, aqui la borramos para limpiar)
            db.collection("usuarios").doc(currentUser.uid).collection("tareas").doc(id).delete();
        };

        // --- GESTIÃ“N MODALES (CIERRE INMEDIATO) ---
        document.getElementById('form-materia').addEventListener('submit', async (e) => {
            e.preventDefault();
            // 1. Obtener datos
            const data = {
                userId: currentUser.uid,
                nombre: document.getElementById('materia-nombre').value,
                dia: document.getElementById('materia-dia').value,
                asistenciaReq: parseInt(document.getElementById('materia-asistencia').value),
                createdAt: Date.now()
            };
            // 2. Cerrar YA UI
            document.getElementById('form-materia').reset();
            closeModal('modal-materia');
            // 3. Guardar en background
            await db.collection("materias").add(data);
        });

        document.getElementById('form-alumno').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = { apellido: document.getElementById('alumno-apellido').value, nombre: document.getElementById('alumno-nombre').value, notas: {}, createdAt: Date.now() };
            document.getElementById('form-alumno').reset();
            closeModal('modal-alumno');
            await db.collection("materias").doc(materiaActivaId).collection("estudiantes").add(data);
        });

       document.getElementById('form-columna').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nom = document.getElementById('columna-nombre').value;
            const fecha = document.getElementById('columna-fecha').value; // Capturamos la fecha
            
            document.getElementById('form-columna').reset();
            closeModal('modal-columna');
            
            // Guardamos nombre Y fecha en la base de datos
            await db.collection("materias").doc(materiaActivaId).collection("columnas_notas").add({ 
                nombre: nom, 
                fecha: fecha, 
                createdAt: Date.now() 
            });
            
            // TRUCO EXTRA: Si puso fecha, creamos tambiÃ©n una TAREA automÃ¡tica en el inicio
            if(fecha) {
                // Buscamos el nombre de la materia actual para la alerta
                const nombreMateria = document.getElementById('aula-titulo').innerText;
                await db.collection("usuarios").doc(currentUser.uid).collection("tareas").add({
                    titulo: `Examen: ${nom} (${nombreMateria})`,
                    fecha: fecha,
                    prioridad: 'high', // Prioridad Alta porque es examen
                    completed: false,
                    createdAt: Date.now()
                });
            }
        });
        
        document.getElementById('form-fecha').addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = document.getElementById('input-fecha-clase').value;
            if(!f) return;
            document.getElementById('form-fecha').reset();
            closeModal('modal-fecha');
            // Background process
            await db.collection("materias").doc(materiaActivaId).collection("asistencias").doc(f).set({
                fecha: f, timestamp: Date.now(), totalAlumnos: alumnosCache.length, presentesIds: [], ausentesIds: []
            }, { merge: true });
            abrirClase(f); // Navegar a la clase
        });

        window.borrarMateria = (id) => { if(confirm("Â¿Eliminar?")) db.collection("materias").doc(id).delete(); };

        // --- AULA LOGIC ---
        window.entrarAula = (id, nombre) => {
            materiaActivaId = id;
            document.getElementById('aula-titulo').innerText = nombre;
            navigate('aula');
            cargarAlumnos(id);
            cargarClases(id);
            cargarColumnasNotas(id);
            volverAListaClases();
        };

        function cargarAlumnos(materiaId) {
            if(unsubscribeAlumnos) unsubscribeAlumnos();
            unsubscribeAlumnos = db.collection("materias").doc(materiaId).collection("estudiantes").orderBy("apellido", "asc")
                .onSnapshot(snap => {
                    const list = document.getElementById('lista-alumnos'); list.innerHTML = ''; alumnosCache = [];
                    document.getElementById('aula-info').innerText = snap.size + " Estudiantes";
                    snap.forEach(doc => {
                        const est = doc.data(); est.id = doc.id; alumnosCache.push(est);
                        const row = document.createElement('div');
                        row.className = 'bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center';
                        row.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-raspanti-crema flex items-center justify-center text-xs font-bold text-raspanti-bordo">${est.nombre[0]}${est.apellido[0]}</div><span class="font-bold text-gray-700">${est.apellido}, ${est.nombre}</span></div><button onclick="borrarAlumno('${doc.id}')" class="text-gray-300 hover:text-red-500"><i data-lucide="x-circle" class="w-4 h-4"></i></button>`;
                        list.appendChild(row);
                    });
                    renderTablaNotas();
                    lucide.createIcons();
                });
        }
        window.borrarAlumno = (id) => { if(confirm("Â¿Quitar?")) db.collection("materias").doc(materiaActivaId).collection("estudiantes").doc(id).delete(); };

        // --- ASISTENCIA ---
        function cargarClases(materiaId) {
            if(unsubscribeClases) unsubscribeClases();
            unsubscribeClases = db.collection("materias").doc(materiaId).collection("asistencias").orderBy("fecha", "desc")
                .onSnapshot(snap => {
                    const cont = document.getElementById('container-clases'); cont.innerHTML = '';
                    if(snap.empty) document.getElementById('empty-clases').classList.remove('hidden');
                    else {
                        document.getElementById('empty-clases').classList.add('hidden');
                        snap.forEach(doc => {
                            const d = doc.data(); const [y, m, day] = d.fecha.split('-');
                            const tot = d.totalAlumnos || 0; const pres = d.presentesIds ? d.presentesIds.length : 0; const porc = tot > 0 ? Math.round((pres/tot)*100) : 0;
                            const div = document.createElement('div'); div.className = 'bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm cursor-pointer hover:bg-gray-50';
                            div.innerHTML = `<div onclick="abrirClase('${doc.id}')" class="flex-1"><h4 class="font-bold text-raspanti-bordo text-lg">Clase del ${day}/${m}/${y}</h4><p class="text-xs text-gray-500 font-bold uppercase mt-1">Asistencia: ${porc}%</p></div><i data-lucide="chevron-right" class="text-gray-300"></i>`;
                            cont.appendChild(div);
                        });
                        lucide.createIcons();
                    }
                });
        }
        window.abrirClase = async (fid) => {
            fechaActiva = fid;
            document.getElementById('vista-lista-clases').classList.add('hidden'); document.getElementById('vista-tomar-lista').classList.remove('hidden');
            const [y, m, d] = fid.split('-'); document.getElementById('titulo-fecha-activa').innerText = `${d}/${m}/${y}`;
            const snap = await db.collection("materias").doc(materiaActivaId).collection("asistencias").doc(fid).get();
            const data = snap.exists ? snap.data() : { presentesIds: [] }; const presentes = data.presentesIds || [];
            const list = document.getElementById('lista-check-alumnos'); list.innerHTML = '';
            if(alumnosCache.length===0) { list.innerHTML='<p class="text-center p-4">No hay alumnos.</p>'; return; }
            alumnosCache.forEach(est => {
                const isP = presentes.includes(est.id);
                const div = document.createElement('div'); div.className = 'bg-white p-3 rounded-2xl border border-gray-100 flex items-center justify-between mb-2 shadow-sm';
                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">${est.apellido[0]}</div><span class="font-bold text-gray-700 text-sm truncate w-32">${est.apellido}, ${est.nombre}</span></div><div class="flex items-center gap-2"><span class="text-[10px] font-bold uppercase status-text ${isP?'text-gray-400':'text-red-500'}">${isP?'Presente':'Ausente'}</span><div class="relative inline-block w-10 mr-2"><input type="checkbox" id="asis-${est.id}" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 checked:border-green-400" ${isP?'checked':''} onclick="updateStatusText(this)"/><label for="asis-${est.id}" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div>`;
                list.appendChild(div);
            });
        };
        window.volverAListaClases = () => { document.getElementById('vista-tomar-lista').classList.add('hidden'); document.getElementById('vista-lista-clases').classList.remove('hidden'); fechaActiva = null; };
        window.updateStatusText = (chk) => { const sp = chk.parentElement.previousElementSibling; if(chk.checked){sp.innerText="Presente";sp.classList.remove('text-red-500');sp.classList.add('text-gray-400');}else{sp.innerText="Ausente";sp.classList.add('text-red-500');sp.classList.remove('text-gray-400');} };
        window.guardarAsistencia = async () => {
            if(!fechaActiva) return;
            const p = [], a = []; alumnosCache.forEach(e => { const c=document.getElementById('asis-'+e.id); if(c&&c.checked) p.push(e.id); else a.push(e.id); });
            await db.collection("materias").doc(materiaActivaId).collection("asistencias").doc(fechaActiva).update({ totalAlumnos: alumnosCache.length, presentesIds: p, ausentesIds: a });
            alert("âœ… Asistencia Guardada"); volverAListaClases();
        };

        // --- NOTAS ---
        function cargarColumnasNotas(materiaId) {
            if(unsubscribeColumnas) unsubscribeColumnas();
            unsubscribeColumnas = db.collection("materias").doc(materiaId).collection("columnas_notas").orderBy("createdAt", "asc").onSnapshot(snap => { columnasNotasCache = []; snap.forEach(doc => columnasNotasCache.push({id: doc.id, ...doc.data()})); renderTablaNotas(); });
        }
        function renderTablaNotas() {
            const headerRow = document.getElementById('header-notas'); const body = document.getElementById('body-notas'); const empty = document.getElementById('empty-notas');
            headerRow.innerHTML = '<th class="table-header w-32 sticky left-0 z-10 bg-gray-50 border-r border-gray-200">Alumno</th>';
            // Renderizamos las columnas dinÃ¡micas
            columnasNotasCache.forEach(col => { 
                // Formateamos la fecha si existe para que se vea bonita (dd/mm)
                let fechaDisplay = '';
                if(col.fecha) {
                    const [y, m, d] = col.fecha.split('-');
                    fechaDisplay = `<br><span class="text-[9px] text-gray-400 font-normal bg-gray-50 px-1 rounded border border-gray-200">${d}/${m}</span>`;
                }
                headerRow.innerHTML += `<th class="table-header text-center min-w-[80px] align-top">${col.nombre}${fechaDisplay}</th>`; 
            });
            headerRow.innerHTML += '<th class="table-header text-center w-16 sticky right-0 z-10 bg-gray-100 border-l border-gray-200">Prom.</th>';
            if(columnasNotasCache.length === 0) { empty.classList.remove('hidden'); body.innerHTML = ''; return; }
            empty.classList.add('hidden'); body.innerHTML = '';
            alumnosCache.forEach(est => {
                const notasEst = est.notas || {}; let html = `<td class="table-cell font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-100 z-10 truncate max-w-[120px]">${est.apellido}</td>`;
                let suma = 0; let cant = 0;
                columnasNotasCache.forEach(col => { const val = notasEst[col.id] || ''; if(val !== '') { suma += parseFloat(val); cant++; } html += `<td class="table-cell text-center p-1"><input type="number" class="input-nota ${val < 4 && val !== '' ? 'bg-red-50 text-red-600 border-red-200' : ''}" value="${val}" onchange="guardarNota('${est.id}', '${col.id}', this.value)"></td>`; });
                const prom = cant > 0 ? (suma / cant).toFixed(1) : '-'; const colorProm = prom !== '-' && prom < 4 ? 'text-red-600 font-black' : (prom >= 7 ? 'text-green-600 font-black' : 'text-gray-600 font-bold');
                html += `<td class="table-cell text-center sticky right-0 bg-gray-50 border-l border-gray-100 z-10"><span class="${colorProm}">${prom}</span></td>`;
                const tr = document.createElement('tr'); tr.innerHTML = html; body.appendChild(tr);
            });
        }
        window.guardarNota = async (alumnoId, colId, valor) => { const key = `notas.${colId}`; const updateObj = {}; updateObj[key] = valor; await db.collection("materias").doc(materiaActivaId).collection("estudiantes").doc(alumnoId).update(updateObj); };

        // --- REPORTES ---
        window.cargarPlanilla = async () => {
            const tbody = document.getElementById('tabla-planilla-body'); tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Cargando...</td></tr>';
            try {
                const snapA = await db.collection("materias").doc(materiaActivaId).collection("asistencias").get(); const totalClases = snapA.size; const asistMap = {}; snapA.forEach(d => { const p = d.data().presentesIds || []; p.forEach(id => asistMap[id] = (asistMap[id] || 0) + 1); });
                tbody.innerHTML = '';
                alumnosCache.forEach(est => {
                    const asist = asistMap[est.id] || 0; const porc = totalClases > 0 ? Math.round((asist/totalClases)*100) : 100;
                    const notas = est.notas || {}; let s=0, c=0; Object.values(notas).forEach(v => { if(v){ s+=parseFloat(v); c++; } }); const prom = c>0 ? (s/c).toFixed(1) : '-';
                    tbody.innerHTML += `<tr><td class="table-cell font-bold text-gray-700">${est.apellido}, ${est.nombre}</td><td class="table-cell text-center ${porc<75?'text-red-600 font-bold':'text-green-600'}">${porc}%</td><td class="table-cell text-center font-bold">${prom}</td></tr>`;
                });
            } catch(e) { tbody.innerHTML = 'Error'; }
        };

        // UI HELPERS
        window.cambiarTabAula = (tab) => {
            document.querySelectorAll('.aula-tab-content').forEach(el => el.classList.add('hidden')); document.getElementById('content-'+tab).classList.remove('hidden');
            ['alumnos', 'asistencia', 'notas', 'planilla'].forEach(t => { const btn = document.getElementById('tab-'+t); if(t === tab) { btn.classList.remove('text-gray-400', 'bg-gray-100'); btn.classList.add('bg-raspanti-crema', 'text-raspanti-bordo'); } else { btn.classList.add('text-gray-400'); btn.classList.remove('bg-raspanti-crema', 'text-raspanti-bordo'); } });
            if(tab === 'planilla') cargarPlanilla();
        };
        window.navigate = (view) => { ['dashboard', 'materias', 'aula'].forEach(v => document.getElementById('view-'+v).classList.add('hidden')); document.getElementById('view-'+view).classList.remove('hidden'); if(view === 'aula') document.getElementById('bottom-nav').classList.add('hidden'); else document.getElementById('bottom-nav').classList.remove('hidden'); };
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    </script>
</body>
</html>

