<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nómade | Agenda Docente</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#144E7E">
    <link rel="apple-touch-icon" href="nomade.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nomade: { blue: '#144E7E', green: '#1FA194', cream: '#FAF7F0', white: '#FFFFFF', text: '#2C3E50' },
                        raspanti: { bordo: '#800020', crema: '#FFFDD0', dorado: '#C5B358' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { background-color: #FAF7F0; font-family: 'Segoe UI', system-ui, sans-serif; overscroll-behavior: none; color: #2C3E50; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .login-bg { background-color: #144E7E; }
        .toggle-checkbox:checked { right: 0; border-color: #1FA194; }
        .toggle-checkbox:checked + .toggle-label { background-color: #1FA194; }
        .task-check:checked + div { text-decoration: line-through; opacity: 0.5; color: #1FA194; }
        .input-nota { min-width: 40px; text-align: center; border-radius: 6px; border: 1px solid #e2e8f0; }
        .btn-asist { width: 35px; height: 35px; border-radius: 50%; font-weight: 900; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; transition: all 0.2s; }
        .st-P { background: #DCFCE7; color: #166534; border-color: #166534; }
        .st-T { background: #FEF9C3; color: #854D0E; border-color: #854D0E; }
        .st-J { background: #DBEAFE; color: #1E40AF; border-color: #1E40AF; }
        .st-A { background: #FEE2E2; color: #991B1B; border-color: #991B1B; }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #1FA194; }
        .progress-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { background: white; border-radius: 8px; min-height: 70px; padding: 4px; font-size: 10px; position: relative; border: 1px solid #f1f5f9; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .calendar-day:active { background-color: #f8fafc; border-color: #1FA194; }
        .calendar-day.today { border: 2px solid #1FA194; background: #F0FDFA; }
        .dots-container { display: flex; gap: 2px; flex-wrap: wrap; content-visibility: auto; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; }
        #canvas-container { touch-action: none; background: white; border-radius: 10px; overflow: hidden; height: 60vh; position: relative; border: 1px solid #1FA194; cursor: crosshair; }
        .retro-label { font-size: 9px; font-weight: 800; color: #144E7E; text-transform: uppercase; margin-bottom: 2px; display: block; margin-top: 6px; letter-spacing: 0.5px; }
        .retro-select { width: 100%; padding: 8px 10px; background-color: white; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 12px; font-weight: 500; color: #2C3E50; outline: none; }
        .section-title { font-size: 10px; font-weight: 900; background: #e2e8f0; color: #144E7E; padding: 4px 8px; border-radius: 4px; margin-top: 14px; margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
        
        #cloud-status { position: fixed; top: 10px; right: 10px; z-index: 100; font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.95); padding: 4px 10px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.5s; pointer-events: none; color: #1FA194;}
        
        /* BANNER DE INSTALACIÓN */
        #install-banner { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 2px solid #1FA194; z-index: 100; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* FOTO UPLOAD */
        .avatar-upload { width: 80px; height: 80px; border-radius: 50%; background: #f3f4f6; margin: 0 auto 10px; position: relative; overflow: hidden; border: 2px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
    </style>
</head>
<body class="h-screen flex flex-col text-nomade-text bg-nomade-cream">

    <div id="cloud-status"><i data-lucide="cloud" class="w-3 h-3"></i> <span id="cloud-text">Sincronizado</span></div>

    <div id="auth-screen" class="fixed inset-0 login-bg z-50 flex flex-col items-center justify-center p-6 text-center text-white fade-in">
        <div class="mb-6 drop-shadow-xl"><img src="nomade.png" alt="Nómade" class="w-32 h-32 object-contain mx-auto bg-white rounded-full p-2 border-4 border-nomade-green" onerror="this.src='https://placehold.co/150x150?text=N'"></div>
        <h1 class="text-3xl font-black uppercase mb-1 tracking-widest text-white">NÓMADE</h1>
        <p class="text-nomade-green text-sm mb-10 font-medium tracking-wide uppercase">Agenda Docente</p>
        <div class="w-full max-w-xs space-y-4">
            <div class="relative"><i data-lucide="user" class="absolute left-3 top-3.5 w-5 h-5 text-white/50"></i><input type="text" id="login-user" class="w-full p-3 pl-10 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:border-nomade-green outline-none transition text-center" placeholder="Usuario"></div>
            <div class="relative"><i data-lucide="lock" class="absolute left-3 top-3.5 w-5 h-5 text-white/50"></i><input type="password" id="login-pass" class="w-full p-3 pl-10 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:border-nomade-green outline-none transition text-center" placeholder="Contraseña"></div>
            <button onclick="handleLogin()" class="bg-nomade-green text-white w-full py-4 rounded-xl font-bold shadow-lg hover:bg-teal-600 transition tracking-widest mt-2 transform active:scale-95">INGRESAR</button>
            <p id="login-msg" class="text-xs mt-4 h-4 text-red-300 font-bold text-center"></p>
        </div>
        <div class="mt-auto pb-4"><p class="text-[10px] opacity-60">Creado por</p><a href="https://www.somosnomade.com.ar" target="_blank" class="text-nomade-green font-bold text-xs hover:underline">www.somosnomade.com.ar</a></div>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden relative">
        <header class="bg-nomade-blue text-white p-4 flex justify-between items-center shadow-md z-20 pt-safe-top">
            <div class="flex items-center gap-3"><img src="nomade.png" class="w-8 h-8 bg-white rounded-full p-0.5" onerror="this.style.display='none'"><span class="font-bold text-sm uppercase tracking-wider">Mi Agenda</span></div>
            <div class="flex items-center gap-3">
                <button onclick="nav('admin')" id="btn-admin-panel" class="hidden text-nomade-green animate-pulse"><i data-lucide="crown" class="w-5 h-5"></i></button>
                <button onclick="openSettings()" class="opacity-90 hover:text-nomade-green transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24 max-w-md mx-auto w-full no-scrollbar relative bg-nomade-cream">
            
            <div class="flex justify-end mb-2">
    <button onclick="showTutorial()" class="text-xs font-bold text-nomade-green flex items-center gap-1 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-100">
        <i data-lucide="help-circle" class="w-3 h-3"></i> AYUDA
    </button>
</div>
            <div id="view-dashboard" class="fade-in space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><div class="flex justify-between items-start"><div><h2 class="text-xl font-bold text-nomade-blue flex items-center gap-2 cursor-pointer" onclick="editProfileName()"><span id="dash-name">Hola Profe</span> <i data-lucide="pencil" class="w-3 h-3 text-gray-300"></i></h2><p class="text-nomade-text text-sm opacity-60" id="fecha-hoy">Cargando...</p></div></div></div>
                <div class="bg-nomade-blue text-white p-5 rounded-2xl shadow-lg border-l-4 border-nomade-green"><h3 class="font-bold mb-3 border-b border-white/20 pb-2 text-nomade-green">Tu Día Hoy</h3><div id="lista-hoy" class="text-sm space-y-2"></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
    <h3 class="font-bold text-nomade-blue mb-3 flex items-center gap-2">
        <i data-lucide="calendar-range" class="w-4 h-4 text-nomade-green"></i> Próximos Días
    </h3>
    <div id="lista-semana" class="text-sm space-y-3"></div>
</div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-nomade-blue">Tareas</h3><button onclick="openModal('modal-tarea')" class="text-xs bg-nomade-green text-white px-3 py-1 rounded-full font-bold shadow hover:bg-teal-700">+ NUEVA</button></div><div id="lista-tareas" class="space-y-2"></div><p id="no-tareas" class="text-center text-xs text-gray-400 mt-2 hidden">Sin tareas pendientes.</p></div>
            </div>

            <div id="view-materias" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-nomade-blue">Mis Materias</h2><button onclick="openMateriaModal()" class="bg-nomade-blue text-white p-2 rounded-lg shadow hover:bg-blue-900"><i data-lucide="plus"></i></button></div>
                <div id="lista-materias" class="space-y-3"></div><p id="no-materias" class="text-center text-gray-400 text-sm mt-10 hidden">No hay materias.</p>
            </div>

            <div id="view-calendario" class="hidden fade-in h-full flex flex-col">
                <div class="flex justify-between items-center mb-4"><h2 id="cal-month-year" class="text-xl font-bold text-nomade-blue capitalize">Mes Año</h2><div class="flex gap-2"><button onclick="changeMonth(-1)" class="p-2 bg-white rounded-lg shadow-sm border border-gray-200 active:bg-gray-100"><i data-lucide="chevron-left" class="w-4 text-nomade-blue"></i></button><button onclick="changeMonth(1)" class="p-2 bg-white rounded-lg shadow-sm border border-gray-200 active:bg-gray-100"><i data-lucide="chevron-right" class="w-4 text-nomade-blue"></i></button></div></div>
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400"><div>D</div><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div></div>
                <div id="calendar-grid" class="calendar-grid flex-1"></div>
            </div>

            <div id="view-aula" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <button onclick="nav('materias')" class="text-gray-500 text-xs font-bold flex items-center gap-1"><i data-lucide="arrow-left" class="w-3"></i> VOLVER</button>
                    <div class="flex gap-2">
                        <button onclick="iniciarTomaLista()" class="bg-nomade-blue text-white px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="check-square" class="w-3 h-3"></i> ASIST</button>
                        <button onclick="openExportModal('xls')" class="bg-green-600 text-white px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> XLS</button>
                        <button onclick="openExportModal('pdf')" class="bg-red-600 text-white px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><span id="aula-modalidad" class="text-[10px] bg-nomade-cream text-nomade-text px-2 py-1 rounded font-bold uppercase border border-nomade-text/10">--</span><h2 id="aula-nombre" class="text-2xl font-black text-nomade-blue mt-2 leading-tight">Materia</h2></div>
                
                <div class="flex bg-white p-1 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                    <button onclick="setTab('crono')" id="btn-crono" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg bg-nomade-blue text-white">CRONOGRAMA</button>
                    <button onclick="setTab('alumnos')" id="btn-alumnos" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400">ALUMNOS</button>
                    <button onclick="setTab('notas')" id="btn-notas" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400">NOTAS</button>
                </div>

                <div id="tab-crono" class="space-y-3">
                    <div class="flex justify-between items-center"><p class="text-xs text-gray-500 font-bold ml-1">Planificación</p><button onclick="openImportModal()" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200 font-bold flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> IMPORTAR</button></div>
                    <div id="lista-cronograma" class="space-y-3"></div>
                </div>
                
                <div id="tab-alumnos" class="hidden space-y-3">
                    <div class="flex justify-between items-center px-1"><h3 class="font-bold text-gray-600 text-sm">Padrón</h3><button onclick="openAlumnoModal()" class="text-xs bg-nomade-green text-white px-3 py-1 rounded shadow font-bold">AGREGAR</button></div>
                    <div id="lista-alumnos" class="space-y-2"></div>
                </div>
                
                <div id="tab-notas" class="hidden space-y-3">
                    <div class="flex justify-between items-center px-1"><h3 class="font-bold text-gray-600 text-sm">Libro de Notas</h3><button onclick="openExamModal()" class="text-xs bg-nomade-blue text-white px-3 py-1 rounded shadow font-bold">NUEVO EXAMEN</button></div>
                    <div class="overflow-x-auto bg-white rounded-xl border border-gray-100 shadow-sm"><table class="w-full text-sm"><thead><tr id="head-notas" class="bg-gray-50 text-gray-500 text-left"><th class="p-3">Alumno</th></tr></thead><tbody id="body-notas"></tbody></table></div>
                </div>
            </div>

            <div id="view-lista" class="hidden fade-in space-y-4"><button onclick="cancelarLista()" class="text-gray-500 text-xs font-bold flex items-center gap-1"><i data-lucide="x" class="w-3"></i> CANCELAR</button><div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><div class="flex justify-between items-end mb-2"><p class="text-[10px] font-bold text-gray-400 uppercase">FECHA</p><span id="lista-modalidad-badge" class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">--</span></div><input type="date" id="input-fecha-lista" onchange="cambiarFechaLista(this.value)" class="w-full p-2 bg-gray-50 rounded-lg border font-bold text-nomade-blue text-lg mb-2"><div class="flex justify-center gap-3 text-[10px] font-bold text-gray-400 mb-2"><span><span class="text-green-700">P</span>resente</span><span><span class="text-yellow-700">T</span>arde</span><span><span class="text-blue-700">J</span>ustif</span><span><span class="text-red-700">A</span>usente</span></div><button onclick="guardarLista()" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-600 transition flex justify-center items-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> GUARDAR</button></div><div id="lista-check-container" class="space-y-2 pb-10"></div></div>

            <div id="view-retro" class="hidden fade-in space-y-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3 mb-4 border-b border-gray-100 pb-3"><div class="p-2 bg-nomade-green rounded-full text-white"><i data-lucide="sparkles" class="w-4 h-4"></i></div><div><h2 class="font-bold text-nomade-blue text-md">Retroalimentación</h2><p class="text-[10px] text-gray-500">Evaluación pedagógica (Nómade AI)</p></div></div>
                    <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="retro-label">ESTUDIANTE</label><input id="ia-nombre" class="retro-select" placeholder="Nombre"></div><div><label class="retro-label">FECHA</label><input id="ia-fecha" type="date" class="retro-select"></div></div>
                    <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="retro-label">MATERIA</label><input id="ia-materia" class="retro-select" placeholder="Materia"></div><div><label class="retro-label">INSTANCIA</label><select id="ia-instancia" class="retro-select"><option>Parcial</option><option>TP</option><option>Final</option></select></div></div>
                    <div class="section-title">EVALUACIÓN</div><div class="grid grid-cols-2 gap-2"><div><label class="retro-label">Contenidos</label><select id="crit-contenidos" class="retro-select"><option>Excelente</option><option>Muy Bien</option><option>Bien</option><option>Regular</option></select></div><div><label class="retro-label">Redacción</label><select id="crit-redaccion" class="retro-select"><option>Impecable</option><option>Clara</option><option>Confusa</option></select></div></div><div class="mt-4"><label class="retro-label">OBSERVACIÓN</label><textarea id="ia-obs-extra" class="retro-select h-16 resize-none" placeholder="Detalle..."></textarea></div>
                    <button onclick="generarDevolucion()" id="btn-generar" class="w-full bg-nomade-blue text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 mt-4 hover:bg-blue-900 transition"><i data-lucide="wand-2" class="w-5 h-5"></i> GENERAR</button>
                    <p id="ia-locked-msg" class="hidden text-center text-xs text-red-500 mt-2 font-bold bg-red-100 p-2 rounded border border-red-200"><i data-lucide="lock" class="w-3 inline"></i> Función exclusiva para Administradores</p>
                </div>
                <div id="ia-resultado-container" class="hidden bg-white p-5 rounded-2xl shadow-lg border-2 border-nomade-green relative mt-4"><textarea id="ia-output" class="w-full h-64 p-3 bg-nomade-cream text-nomade-text text-sm leading-relaxed border border-gray-200 rounded-lg outline-none resize-none font-sans"></textarea><button onclick="copiarIA()" class="w-full bg-nomade-text text-white py-3 rounded-lg font-bold text-xs flex justify-center items-center gap-2 mt-3 hover:bg-black"><i data-lucide="copy" class="w-4 h-4"></i> COPIAR TEXTO FINAL</button></div>
            </div>

            <div id="view-admin" class="hidden fade-in space-y-4">
                <div class="bg-nomade-blue text-white p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center gap-3 mb-2"><img src="nomade.png" class="w-10 h-10 bg-white rounded-full p-0.5" onerror="this.style.display='none'"><div><h2 class="text-xl font-black uppercase tracking-widest">NÓMADE</h2><p class="text-xs text-nomade-green font-bold">PANEL DE CONTROL</p></div></div>
                    <div class="mt-4 pt-4 border-t border-white/20"><h3 class="font-bold text-white mb-2 text-sm flex items-center gap-2"><i data-lucide="user-plus" class="w-4"></i> Crear Docente</h3><div class="space-y-2"><input id="new-user-username" class="w-full p-2 rounded bg-white/10 border border-white/20 text-white text-sm" placeholder="Usuario"><input id="new-user-pass" class="w-full p-2 rounded bg-white/10 border border-white/20 text-white text-sm" placeholder="Contraseña"><input id="new-user-fullname" class="w-full p-2 rounded bg-white/10 border border-white/20 text-white text-sm" placeholder="Nombre Completo"><button onclick="crearUsuarioDocente()" class="w-full bg-nomade-green text-white font-bold py-2 rounded mt-2 hover:bg-teal-600 transition">CREAR ACCESO</button></div></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 class="font-bold text-nomade-text mb-3">Docentes Activos</h3><div id="admin-user-list" class="space-y-2 text-xs"></div></div>
            </div>

            <div id="view-cuaderno" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-nomade-blue">Cuaderno</h2><button onclick="openModal('modal-new-nota')" class="bg-nomade-blue text-white p-2 rounded-lg shadow"><i data-lucide="plus"></i></button></div>
                <div id="lista-notas" class="grid grid-cols-2 gap-3"></div>
                <p id="no-notas" class="text-center text-gray-400 text-sm mt-10 hidden">Sin notas guardadas.</p>
                
                <div id="editor-nota" class="hidden fixed inset-0 bg-white z-50 flex flex-col">
                    <div class="p-4 bg-nomade-blue text-white flex justify-between items-center shadow"><button onclick="closeEditor()" class="flex items-center gap-1 font-bold text-xs"><i data-lucide="arrow-left" class="w-4"></i> VOLVER</button><span id="editor-title" class="font-bold">Editar</span><button onclick="saveCurrentNote()" class="bg-white text-nomade-blue px-3 py-1 rounded font-bold text-xs">GUARDAR</button></div>
                    <div class="flex-1 p-4 overflow-y-auto relative">
                        <textarea id="editor-text" class="w-full h-full p-4 bg-nomade-cream text-nomade-text text-lg leading-relaxed outline-none resize-none hidden" placeholder="Escribe aquí..."></textarea>
                        <div id="editor-draw" class="hidden h-full flex flex-col">
                            <div class="flex flex-wrap items-center gap-3 mb-2 p-2 bg-gray-50 rounded-lg shadow-sm border border-gray-100">
                                <input type="color" id="draw-color" value="#000000" onchange="setDrawColor(this.value)" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                                <input type="range" id="draw-size" min="1" max="20" value="2" onchange="setDrawSize(this.value)" class="w-24">
                                <button onclick="setTool('pen')" class="p-2 hover:bg-gray-200 rounded text-gray-600"><i data-lucide="pen-tool" class="w-5"></i></button>
                                <button onclick="setTool('eraser')" class="p-2 hover:bg-gray-200 rounded text-gray-600"><i data-lucide="eraser" class="w-5"></i></button>
                                <button onclick="clearCanvas()" class="ml-auto text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-5"></i></button>
                            </div>
                            <div id="canvas-container"><canvas id="drawing-canvas"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav id="navbar" class="fixed bottom-0 w-full bg-white border-t border-gray-200 h-16 flex justify-around items-center z-30 pb-safe-bottom shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
            <button onclick="nav('dashboard')" id="nav-dash" class="flex flex-col items-center text-nomade-blue w-full justify-center"><i data-lucide="layout-dashboard" class="w-5 mb-1"></i><span class="text-[9px] font-bold">INICIO</span></button>
            <button onclick="nav('materias')" id="nav-mat" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="book" class="w-5 mb-1"></i><span class="text-[9px] font-bold">MATERIAS</span></button>
            <button onclick="nav('retro')" id="nav-ret" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="sparkles" class="w-5 mb-1"></i><span class="text-[9px] font-bold">IA</span></button>
            <button onclick="nav('calendario')" id="nav-cal" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="calendar" class="w-5 mb-1"></i><span class="text-[9px] font-bold">CALENDARIO</span></button>
            <button onclick="nav('cuaderno')" id="nav-cua" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="notebook" class="w-5 mb-1"></i><span class="text-[9px] font-bold">CUADERNO</span></button>
        </nav>
    </div>

    <div id="install-banner" class="hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="nomade.png" class="w-10 h-10 rounded bg-white border border-gray-200" onerror="this.style.display='none'">
                <div>
                    <h3 class="font-bold text-nomade-blue text-sm">Instalar Nómade</h3>
                    <p class="text-xs text-gray-500">Acceso rápido desde tu inicio</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('install-banner').style.display='none'" class="text-xs font-bold text-gray-400 px-2">LUEGO</button>
                <button onclick="installPWA()" class="text-xs font-bold bg-nomade-green text-white px-3 py-1.5 rounded-lg shadow">INSTALAR</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center"><h3 class="text-lg font-black text-nomade-blue mb-6">Configuración</h3><button onclick="showTutorial(); closeModal('modal-settings')" class="w-full py-3 bg-blue-50 text-blue-600 font-bold rounded-lg text-xs mb-2 flex items-center justify-center gap-2">
    <i data-lucide="help-circle"></i> VER TUTORIAL
</button><button onclick="logout()" class="bg-red-50 text-red-600 w-full py-3 rounded-lg font-bold text-sm shadow mb-2">CERRAR SESIÓN</button><button onclick="closeModal('modal-settings')" class="block w-full mt-4 text-gray-400 text-sm font-bold">Cerrar</button></div></div>
    <div id="modal-new-nota" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-nomade-blue mb-4">Nueva Nota</h3><input id="new-nota-title" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Título"><div class="grid grid-cols-2 gap-3 mb-4"><button onclick="createNote('text')" class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex flex-col items-center gap-2 hover:bg-blue-100"><i data-lucide="type" class="w-6 h-6 text-blue-600"></i><span class="text-xs font-bold text-blue-800">TEXTO</span></button><button onclick="createNote('draw')" class="p-4 bg-purple-50 rounded-xl border border-purple-100 flex flex-col items-center gap-2 hover:bg-purple-100"><i data-lucide="pen-tool" class="w-6 h-6 text-purple-600"></i><span class="text-xs font-bold text-purple-800">DIBUJO</span></button></div><button onclick="closeModal('modal-new-nota')" class="w-full text-gray-400 text-sm font-bold">Cancelar</button></div></div>
    <div id="modal-cal-event" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-nomade-blue mb-2" id="event-date-title">--/--</h3><div id="day-events-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div><div class="border-t pt-4"><input id="new-event-text" class="w-full p-2 bg-gray-50 rounded border mb-2" placeholder="Agregar evento..."><div class="flex gap-2"><button onclick="closeModal('modal-cal-event')" class="flex-1 py-2 text-gray-500 font-bold text-xs">CERRAR</button><button onclick="addCalendarEvent()" class="flex-1 py-2 bg-nomade-green text-white rounded font-bold text-xs">AGREGAR</button></div></div></div></div>
    <div id="modal-tarea" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-nomade-blue mb-4">Nueva Tarea</h3><input id="input-tarea-txt" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Descripción"><div class="flex gap-2"><button onclick="closeModal('modal-tarea')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarTarea()" class="flex-1 py-3 bg-nomade-blue text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-materia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-nomade-blue mb-4" id="title-materia">Nueva Materia</h3><input type="hidden" id="edit-mat-id"><label class="text-xs font-bold text-gray-500 ml-1">NOMBRE</label><input id="input-mat-nombre" class="w-full p-2 bg-gray-50 rounded-lg mb-2 border font-bold" placeholder="Ej: Matemática"><div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-gray-500 ml-1">INICIO</label><input type="date" id="input-mat-inicio" class="w-full p-2 bg-gray-50 rounded-lg mb-2 border"></div><div><label class="text-xs font-bold text-gray-500 ml-1">FIN</label><input type="date" id="input-mat-fin" class="w-full p-2 bg-gray-50 rounded-lg mb-2 border"></div></div><label class="text-xs font-bold text-gray-500 ml-1">HORARIO</label><input id="input-mat-horario" class="w-full p-2 bg-gray-50 rounded-lg mb-4 border" placeholder="Ej: 18:00 a 22:00"><div class="grid grid-cols-2 gap-2 mb-4"><div><label class="text-xs font-bold text-gray-500 ml-1">DÍA</label><select id="input-mat-dia" class="w-full p-2 bg-gray-50 rounded-lg border font-bold text-gray-700"><option value="Lunes">Lunes</option><option value="Martes">Martes</option><option value="Miércoles">Miércoles</option><option value="Jueves">Jueves</option><option value="Viernes">Viernes</option><option value="Sábado">Sábado</option></select></div><div><label class="text-xs font-bold text-gray-500 ml-1">MODALIDAD</label><select id="input-mat-mod" class="w-full p-2 bg-gray-50 rounded-lg border font-bold text-gray-700"><option value="Hibrida">Mixta</option><option value="Presencial">Presencial</option><option value="Virtual">Virtual</option></select></div></div><div class="flex gap-2"><button onclick="closeModal('modal-materia')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarMateria()" class="flex-1 py-3 bg-nomade-blue text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
  <div id="modal-tutorial" class="fixed inset-0 z-[90] hidden bg-nomade-blue/95 text-white flex flex-col items-center justify-center p-6 text-center backdrop-blur-sm fade-in">
        <div class="max-w-sm w-full bg-white/10 p-6 rounded-3xl border border-white/20 shadow-2xl relative">
            
            <div id="tut-step-1" class="tut-step">
                <div class="mb-4 bg-white w-16 h-16 rounded-full flex items-center justify-center mx-auto shadow-lg"><img src="nomade.png" class="w-10 h-10" onerror="this.style.display='none'"></div>
                <h2 class="text-2xl font-black mb-2 text-nomade-green">¡Bienvenido/a!</h2>
                <p class="text-sm opacity-90 mb-4">Tu agenda docente digital. Organizate fácil y rápido.</p>
            </div>

            <div id="tut-step-2" class="tut-step hidden">
                <div class="mb-4 text-nomade-green bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto"><i data-lucide="book" class="w-8 h-8"></i></div>
                <h2 class="text-xl font-bold mb-2">1. Materias</h2>
                <p class="text-xs opacity-90 mb-4">Cargá tus materias y horarios. Usá la pestaña <strong>Cronograma</strong> para planificar y <strong>Alumnos</strong> para asistencia.</p>
            </div>

            <div id="tut-step-3" class="tut-step hidden">
                <div class="mb-4 text-purple-300 bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto"><i data-lucide="check-square" class="w-8 h-8"></i></div>
                <h2 class="text-xl font-bold mb-2">2. Asistencia y Notas</h2>
                <p class="text-xs opacity-90 mb-4">Tomá lista rápido desde el botón "ASIST". Cargá notas de exámenes y exportá todo a Excel o PDF.</p>
            </div>

            <div id="tut-step-4" class="tut-step hidden">
                <div class="mb-4 text-yellow-300 bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto"><i data-lucide="pen-tool" class="w-8 h-8"></i></div>
                <h2 class="text-xl font-bold mb-2">3. Cuaderno</h2>
                <p class="text-xs opacity-90 mb-4">Usá el cuaderno para dibujar esquemas o tomar notas rápidas que se guardan automáticamente.</p>
            </div>

            <div class="flex justify-center gap-2 mb-6 mt-4">
                <div class="w-2 h-2 rounded-full bg-nomade-green" id="dot-1"></div>
                <div class="w-2 h-2 rounded-full bg-white/30" id="dot-2"></div>
                <div class="w-2 h-2 rounded-full bg-white/30" id="dot-3"></div>
                <div class="w-2 h-2 rounded-full bg-white/30" id="dot-4"></div>
            </div>

            <button onclick="nextTutorial()" id="btn-tut-next" class="w-full bg-nomade-green text-white py-3 rounded-xl font-bold shadow-lg uppercase text-xs hover:scale-105 transition">Siguiente ➝</button>
        </div>
    </div>
    <div id="modal-alumno" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-black text-nomade-blue mb-4" id="title-alumno">Nuevo Alumno</h3>
            <input type="hidden" id="edit-alum-idx">
            <div class="flex justify-center mb-4">
                <label for="input-alum-foto" class="avatar-upload group">
                    <img id="preview-foto" src="" class="hidden">
                    <div id="placeholder-foto" class="text-gray-400 text-center text-[10px] font-bold">
                        <i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>Foto
                    </div>
                    <input type="file" id="input-alum-foto" class="hidden" accept="image/*" onchange="previewImage(this)">
                </label>
            </div>
            <input id="input-alum-ape" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold" placeholder="Apellido">
            <input id="input-alum-nom" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Nombre">
            <div class="flex gap-2"><button onclick="closeModal('modal-alumno')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarAlumno()" class="flex-1 py-3 bg-nomade-green text-white rounded-lg font-bold shadow">Guardar</button></div>
        </div>
    </div>

    <div id="modal-examen" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-nomade-blue mb-4" id="title-examen">Nuevo Examen/TP</h3><input type="hidden" id="edit-exam-id"><input id="input-exam-nom" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border font-bold" placeholder="Nombre"><input type="date" id="input-exam-date" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold"><div class="flex gap-2"><button onclick="closeModal('modal-examen')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarExamen()" class="flex-1 py-3 bg-nomade-blue text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-obs" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-nomade-blue mb-2">Observación</h3><p id="obs-alum-name" class="text-sm font-bold text-gray-500 mb-3"></p><textarea id="input-obs-txt" class="w-full p-3 bg-gray-50 rounded-lg border h-32 mb-4" placeholder="Escribe una observación..."></textarea><div class="flex gap-2"><button onclick="closeModal('modal-obs')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarObs()" class="flex-1 py-3 bg-nomade-blue text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-import" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative"><button onclick="closeModal('modal-import')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button><h3 class="text-lg font-black text-nomade-blue mb-2">Importar Planificación</h3><p class="text-xs text-gray-500 mb-4">Copia 4 columnas de tu Excel (Fecha, Contenido, Biblio, Actividad) y pega aquí.</p><textarea id="input-import-text" class="w-full p-3 bg-gray-50 rounded-lg border h-40 text-xs font-mono mb-4" placeholder="17/03/2025  Tema 1  Libro A  TP1..."></textarea><button onclick="processImport()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2"><i data-lucide="check" class="w-5 h-5"></i> PROCESAR</button></div></div>
    <div id="modal-clase-detail" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative max-h-[90vh] overflow-y-auto"><h3 class="text-lg font-black text-nomade-blue mb-1" id="detail-date">--/--</h3><input type="hidden" id="detail-iso"><div class="space-y-3 mt-4"><div><label class="text-xs font-bold text-gray-500">CONTENIDO / TEMA</label><textarea id="detail-tema" class="w-full p-2 bg-gray-50 rounded border text-sm font-medium h-20"></textarea></div><div><label class="text-xs font-bold text-gray-500">BIBLIOGRAFÍA</label><textarea id="detail-biblio" class="w-full p-2 bg-gray-50 rounded border text-sm text-gray-600 h-16"></textarea></div><div><label class="text-xs font-bold text-gray-500">ACTIVIDAD CLASE</label><input id="detail-act-clase" class="w-full p-2 bg-gray-50 rounded border text-sm"></div><div><label class="text-xs font-bold text-gray-500">TAREA</label><input id="detail-act-tarea" class="w-full p-2 bg-gray-50 rounded border text-sm"></div></div><div class="flex gap-2 mt-4"><button onclick="closeModal('modal-clase-detail')" class="flex-1 py-3 text-gray-500 font-bold">Cerrar</button><button onclick="saveClaseDetail()" class="flex-1 py-3 bg-nomade-blue text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    
    <div id="modal-export" class="fixed inset-0 bg-black/50 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-black text-nomade-blue mb-4">Exportar Materia</h3>
            <p class="text-xs text-gray-500 mb-4">Seleccioná qué querés incluir:</p>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="checkbox" id="exp-lista" class="w-5 h-5 text-nomade-green" checked><span class="font-bold text-sm text-gray-700">Lista de Alumnos</span></label>
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="checkbox" id="exp-asist" class="w-5 h-5 text-nomade-green" checked><span class="font-bold text-sm text-gray-700">Asistencia</span></label>
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="checkbox" id="exp-notas" class="w-5 h-5 text-nomade-green" checked><span class="font-bold text-sm text-gray-700">Notas</span></label>
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50"><input type="checkbox" id="exp-plan" class="w-5 h-5 text-nomade-green"><span class="font-bold text-sm text-gray-700">Planificación (Temas)</span></label>
            </div>
            <input type="hidden" id="export-type">
            <div class="flex gap-2"><button onclick="closeModal('modal-export')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="executeExport()" class="flex-1 py-3 bg-nomade-blue text-white rounded-lg font-bold shadow">DESCARGAR</button></div>
        </div>
    </div>

    <script>
        // BORRÁ la variable API_KEY suelta, no sirve.
// USÁ ESTA CONFIGURACIÓN CON LA CLAVE ACTUALIZADA:
const firebaseConfig = {
    apiKey: "AIzaSyDS9Tw3_TRLCOu1q7ywcGNHTpY9ta9BzAk", // <--- Puse la clave que tenías arriba
    authDomain: "raspanti-app.firebaseapp.com",
    projectId: "raspanti-app",
    storageBucket: "raspanti-app.firebasestorage.app",
    messagingSenderId: "898404256450",
    appId: "1:898404256450:web:8ba27e3350b8efb22c095b"
};
        const app = firebase.initializeApp(firebaseConfig); const auth = firebase.auth(); const dbCloud = firebase.firestore(); let secondaryApp; try { secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary"); } catch(e) { secondaryApp = firebase.app("Secondary"); }

        const ADMIN_MATERIAS_BASE = [
            { id: 1741000000000, nombre: "Reflexión Filosófica de la Educación", dia: "Lunes", modalidadBase: "Presencial", horario: "18:00 a 20:00", fechaInicio: "2026-03-16", fechaFin: "2026-07-06", planificacion: {}, cronograma: {}, alumnos: [{id:1, ape:'Perez', nom:'Juan', notas:{}}], examenes: [] },
            { id: 1741000000001, nombre: "Cultura Digital y Educación", dia: "Miércoles", modalidadBase: "Virtual", horario: "19:00 a 21:00", fechaInicio: "2026-03-18", fechaFin: "2026-07-08", planificacion: {}, cronograma: {}, alumnos: [], examenes: [] }
        ];

        let currentUser = null; let userData = { materias: [], eventos: {}, notas: [], tareas: [] }; let isOffline = false; let deferredPrompt; let tutStep = 1;

      // --- PARCHE LOGIN ADMIN CONECTADO ---
// --- REEMPLAZAR handleLogin ---
// --- LOGIN BLINDADO ---
async function handleLogin() {
    const u = document.getElementById('login-user').value.trim();
    const p = document.getElementById('login-pass').value.trim();
    const msg = document.getElementById('login-msg');

    if (!u || !p) return alert("Faltan datos");

    // ADMIN LOCAL
    if (u === 'admi' && p === 'adminomade') {
        currentUser = { uid: 'local_admin', email: 'admi@nomade.app' };
        loadAdminUsers(); // Intenta cargar la lista
        startApp();
        return;
    }

    // DOCENTE (NUBE)
    let email = u.includes('@') ? u : u + '@nomade.app';
    msg.innerText = "Verificando...";
    
    try {
        await auth.signInWithEmailAndPassword(email, p);
        msg.innerText = "¡Entrando!";
        // El observer (abajo) se encarga del resto
    } catch (error) {
        console.error(error);
        msg.innerText = "";
        if (error.code === 'auth/wrong-password') alert("⛔ Contraseña incorrecta");
        else if (error.code === 'auth/user-not-found') alert("⛔ Usuario no encontrado");
        else alert("Error: " + error.message);
    }
}

// OBSERVER: DETECTA CUANDO FIREBASE DA EL OK
auth.onAuthStateChanged(async (user) => {
    if (user) {
        if(currentUser && currentUser.uid === 'local_admin') return; 
        currentUser = user;
        
        // Intentamos cargar datos, si falla, iniciamos vacío (Anti-Congelamiento)
        try {
            const doc = await dbCloud.collection('app_data').doc(user.uid).get();
            if(doc.exists) userData = doc.data();
            else userData = { materias: [], eventos: {}, notas: [], tareas: [] };
        } catch(e) {
            console.log("Error cargando data, iniciando vacío:", e);
            userData = { materias: [], eventos: {}, notas: [], tareas: [] };
        }
        startApp();
    }
});

function startApp() {
    try {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
        
        // Nombre en el Dashboard
        const nameDisplay = currentUser.email.split('@')[0];
        document.getElementById('dash-name').innerText = nameDisplay.charAt(0).toUpperCase() + nameDisplay.slice(1);
        
        // Si es admin, mostrar panel
        if(currentUser.email === 'admi@nomade.app') {
            document.getElementById('view-admin').classList.remove('hidden');
            document.getElementById('btn-admin-panel').classList.remove('hidden');
            loadAdminUsers(); // Cargar la lista
            nav('admin'); // Ir directo a admin
        } else {
            nav('dashboard');
        }
        lucide.createIcons();
    } catch(e) {
        alert("Error al iniciar: " + e.message);
    }
}
        function logout() { location.reload(); }
       function saveData() { 
    // Si es el admin de emergencia, guarda local (esto está bien para vos)
    if(currentUser.uid === 'local_admin') {
        localStorage.setItem('nomade_data_admin', JSON.stringify(userData));
        return;
    }

    // PARA USUARIOS REALES: Guardar en Firebase (Nube)
    if (currentUser && dbCloud) {
        const st = document.getElementById('cloud-status');
        st.innerHTML = '<div class="loader w-3 h-3 border-2"></div> Guardando...';
        st.style.opacity = '1';

        dbCloud.collection('app_data').doc(currentUser.uid).set(userData)
            .then(() => {
                st.innerHTML = '<i data-lucide="cloud" class="w-3 h-3"></i> Sincronizado';
                setTimeout(() => st.style.opacity = '0', 2000);
            })
            .catch((error) => {
                console.error("Error al guardar:", error);
                st.innerHTML = '⚠️ Error de Red - No se guardó';
                st.style.color = 'red';
                st.style.opacity = '1';
                alert("¡CUIDADO! No tenés internet. Los cambios no se guardaron en la nube.");
            });
    }
}
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') console.log('User accepted the A2HS prompt');
                    deferredPrompt = null;
                    document.getElementById('install-banner').style.display = 'none';
                });
            }
        }
        // Detect iOS
        const isIos = () => { const userAgent = window.navigator.userAgent.toLowerCase(); return /iphone|ipad|ipod/.test( userAgent ); }
        if (isIos() && !window.navigator.standalone) {
             // Show simple iOS hint alert (simplified for this demo)
             setTimeout(() => alert("Para instalar en iPhone: Tocá el botón Compartir y elegí 'Agregar a Inicio'"), 2000);
        }

        // MATERIAS
        function openMateriaModal(){ document.getElementById('edit-mat-id').value=''; document.getElementById('input-mat-nombre').value=''; document.getElementById('input-mat-inicio').value=''; document.getElementById('input-mat-fin').value=''; document.getElementById('input-mat-horario').value=''; openModal('modal-materia'); }
        function guardarMateria(){
            const nom = document.getElementById('input-mat-nombre').value; const ini = document.getElementById('input-mat-inicio').value; const fin = document.getElementById('input-mat-fin').value;
            if(!nom || !ini || !fin) return alert("Falta nombre o fechas.");
            const mat = { id: Date.now(), nombre: nom, dia: document.getElementById('input-mat-dia').value, modalidadBase: document.getElementById('input-mat-mod').value, horario: document.getElementById('input-mat-horario').value, fechaInicio: ini, fechaFin: fin, planificacion: {}, cronograma: {}, alumnos: [], examenes: [] };
            userData.materias.push(mat); saveData(); closeModal('modal-materia'); renderMaterias();
        }

        // CRONOGRAMA DINÁMICO
        let activeId=null, activeDateISO=null, activeCalISO=null, currentMonth=new Date().getMonth(), currentYear=new Date().getFullYear();
        
        function renderCrono(){
            const m = userData.materias.find(x => x.id === activeId); if (!m) return;
            const l = document.getElementById('lista-cronograma'); l.innerHTML = '';
            const map = { 'Domingo': 0, 'Lunes': 1, 'Martes': 2, 'Miércoles': 3, 'Jueves': 4, 'Viernes': 5, 'Sábado': 6 };
            const targetDay = map[m.dia];
            let d = new Date(m.fechaInicio + 'T12:00:00'); const fin = new Date(m.fechaFin + 'T12:00:00');
            while (d.getDay() !== targetDay) { d.setDate(d.getDate() + 1); }

            while (d <= fin) {
                const iso = d.toISOString().split('T')[0];
                const displayDate = `${d.getDate()}/${d.getMonth() + 1}`;
                let st = m.cronograma?.[iso] || ((m.modalidadBase === 'Hibrida') ? 'Presencial' : m.modalidadBase);
                if (m.modalidadBase === 'Virtual') st = 'Virtual';
                if (st === 'Receso') st = 'Receso';
                let badgeClass = 'bg-gray-100 text-gray-500';
                if (st.startsWith('Presenc')) badgeClass = 'bg-nomade-blue text-white';
                else if (st.startsWith('Virt') || st.startsWith('Sinc')) badgeClass = 'bg-nomade-green text-white';
                else if (st === 'Receso') badgeClass = 'bg-red-100 text-red-500';
                const plan = m.planificacion?.[iso]?.tema || '';
                l.innerHTML += `<div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm mb-3">
                    <div class="flex justify-between items-center mb-2"><span class="font-black text-nomade-blue text-sm w-10">${displayDate}</span><div class="flex gap-1"><button onclick="cycle('${iso}')" class="px-2 py-1 rounded text-[9px] font-bold uppercase ${badgeClass}">${st}</button><button onclick="setReceso('${iso}')" class="text-xs text-gray-300 hover:text-red-500">⛔</button></div></div>
                    <input class="w-full text-sm bg-gray-50 p-2 rounded" placeholder="Tema..." value="${plan}" onchange="saveTema('${iso}',this.value)">
                    <div class="flex justify-end mt-2"><button onclick="openClaseDetail('${iso}')" class="text-nomade-green text-xs font-bold flex items-center gap-1"><i data-lucide="plus-circle" class="w-3"></i> DETALLES</button></div></div>`;
                d.setDate(d.getDate() + 7);
            }
            lucide.createIcons();
        }

        function cycle(iso) { const m = userData.materias.find(x => x.id === activeId); if (!m.cronograma) m.cronograma = {}; const states = ['Presencial', 'Virtual', 'Sincronico', 'Asincronico', 'Receso']; const current = m.cronograma[iso] || m.modalidadBase; m.cronograma[iso] = states[(states.indexOf(current) + 1) % states.length]; saveData(); renderCrono(); }
        function setReceso(iso) { const m = userData.materias.find(x => x.id === activeId); if (!m.cronograma) m.cronograma = {}; m.cronograma[iso] = 'Receso'; saveData(); renderCrono(); }
        function saveTema(iso,val){ const m=userData.materias.find(x=>x.id===activeId); if(!m.planificacion) m.planificacion={}; if(!m.planificacion[iso]) m.planificacion[iso]={}; m.planificacion[iso].tema=val; saveData(); }

    // ==========================================
        // 📓 SECCIÓN CUADERNO (LIMPIA Y CORREGIDA)
        // ==========================================
        let penColor='#000000', penSize=2;
        let canvas, ctx, drawing=false, lastX=0, lastY=0, activeNoteId=null;

        function setDrawColor(c){ penColor=c; penSize=2; } 
        function setDrawSize(s){ penSize=s; }
        function setTool(t){ 
            if(t==='eraser'){ penColor='#FFFFFF'; penSize=20; } 
            else { 
                const colorPicker = document.getElementById('draw-color');
                penColor= colorPicker ? colorPicker.value : '#000000'; 
                const sizePicker = document.getElementById('draw-size');
                penSize= sizePicker ? sizePicker.value : 2;
            } 
        }

        function createNote(type){ 
            if(!userData.notas) userData.notas = [];
            const titleInput = document.getElementById('new-nota-title');
            const title = titleInput.value || 'Nota sin título';
            
            userData.notas.unshift({
                id:Date.now(), 
                title: title, 
                type:type, 
                content:''
            }); 
            
            saveData(); 
            closeModal('modal-new-nota'); 
            titleInput.value = ''; 
            openNoteEditor(0); // Abre directo la nota nueva
        }

        function renderNotesList(){ 
            const l=document.getElementById('lista-notas'); 
            l.innerHTML=''; 
            
            if(!userData.notas || userData.notas.length===0) { 
                document.getElementById('no-notas').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('no-notas').classList.add('hidden');
            
            userData.notas.forEach((n,i)=>{
                const icon = n.type === 'text' ? 'type' : 'pen-tool';
                const border = n.type === 'text' ? 'border-blue-500' : 'border-purple-500';
                l.innerHTML+=`
                <div onclick="openNoteEditor(${i})" class="bg-white p-4 shadow rounded-xl cursor-pointer border-l-4 ${border} relative group">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="${icon}" class="w-4 h-4 text-gray-400"></i>
                        <span class="font-bold text-sm text-gray-700 truncate w-32">${n.title}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteNote(${i})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 p-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`; 
            });
            lucide.createIcons();
        }

        function deleteNote(i){ 
            if(confirm("¿Borrar nota?")) { 
                userData.notas.splice(i,1); 
                saveData(); 
                renderNotesList(); 
            } 
        }

        function openNoteEditor(i){ 
            const n=userData.notas[i]; 
            activeNoteId=n.id; 
            document.getElementById('editor-title').innerText=n.title; 
            const t=document.getElementById('editor-text');
            const d=document.getElementById('editor-draw'); 
            
            document.getElementById('editor-nota').classList.remove('hidden'); 
            
            if(n.type==='draw'){ 
                t.classList.add('hidden'); 
                d.classList.remove('hidden'); 
                // Delay clave para que el canvas tome tamaño real
                setTimeout(()=>initCanvas(n.content), 100); 
            } else { 
                t.classList.remove('hidden'); 
                d.classList.add('hidden'); 
                t.value=n.content||''; 
            } 
        }

        function closeEditor(){ 
            document.getElementById('editor-nota').classList.add('hidden'); 
            renderNotesList(); 
        }

        function saveCurrentNote(){ 
            const i=userData.notas.findIndex(n=>n.id===activeNoteId); 
            if(i===-1)return; 
            
            if(userData.notas[i].type==='text'){ 
                userData.notas[i].content=document.getElementById('editor-text').value; 
            } else { 
                userData.notas[i].content=canvas.toDataURL(); 
            } 
            saveData(); 
            alert('✅ Guardado'); 
        }

        function initCanvas(src){ 
            canvas=document.getElementById('drawing-canvas'); 
            ctx=canvas.getContext('2d'); 
            const p=document.getElementById('canvas-container'); 
            
            canvas.width=p.clientWidth; 
            canvas.height=p.clientHeight; 
            ctx.fillStyle="white"; 
            ctx.fillRect(0,0,canvas.width,canvas.height); 
            
            if(src){
                const i=new Image(); 
                i.onload=()=>ctx.drawImage(i,0,0); 
                i.src=src;
            } 
            
            // Eventos Mouse y Touch unificados
            const start = (e) => { 
                drawing = true; 
                const r = canvas.getBoundingClientRect(); 
                // Soporte dual: Mouse o Touch
                const cx = e.clientX || e.touches[0].clientX;
                const cy = e.clientY || e.touches[0].clientY;
                lastX = cx - r.left; 
                lastY = cy - r.top; 
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                e.preventDefault(); 
            };
            
            const move = (e) => { 
                if (!drawing) return; 
                const r = canvas.getBoundingClientRect(); 
                const cx = e.clientX || e.touches[0].clientX;
                const cy = e.clientY || e.touches[0].clientY;
                const x = cx - r.left; 
                const y = cy - r.top; 
                
                ctx.beginPath(); 
                ctx.moveTo(lastX, lastY); 
                ctx.lineTo(x, y); 
                ctx.strokeStyle = penColor; 
                ctx.lineWidth = penSize; 
                ctx.lineCap = 'round'; 
                ctx.stroke(); 
                
                lastX = x; 
                lastY = y; 
                e.preventDefault(); 
            };
            
            const end = () => { drawing = false; };
            
            canvas.onmousedown = start; canvas.onmousemove = move; canvas.onmouseup = end;
            canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = end;
        }

        function clearCanvas(){ 
            if(confirm("¿Limpiar todo el dibujo?")) { 
                ctx.fillStyle="white"; 
                ctx.fillRect(0,0,canvas.width,canvas.height); 
            } 
        }

        // ==========================================
        // 📋 SECCIÓN ASISTENCIA (LISTA DIARIA)
        // ==========================================
        function iniciarTomaLista(){ 
            if(!activeId) return alert("Seleccioná una materia primero"); 
            const h=new Date().toISOString().split('T')[0]; 
            const inputF = document.getElementById('input-fecha-lista');
            if(inputF) inputF.value=h; 
            cambiarFechaLista(h); 
            nav('lista'); 
        }

        function cambiarFechaLista(iso){
            activeDateISO=iso; 
            const m=userData.materias.find(x=>x.id===activeId);
            const c=document.getElementById('lista-check-container'); 
            c.innerHTML=''; 
            
            if(!m || !m.alumnos || m.alumnos.length === 0) { 
                c.innerHTML='<p class="text-center text-gray-400 mt-10">No hay alumnos.</p>'; 
                return; 
            }
            
            const map = (m.asistencias && m.asistencias[iso]) ? m.asistencias[iso] : {};
            
            m.alumnos.forEach(al=>{
                const st = map[al.id] || 'P';
                let cls = '';
                if(st==='P') cls='bg-green-100 text-green-700 border-green-200';
                else if(st==='A') cls='bg-red-100 text-red-700 border-red-200';
                else if(st==='T') cls='bg-yellow-100 text-yellow-700 border-yellow-200';
                else cls='bg-blue-100 text-blue-700 border-blue-200';

                c.innerHTML+=`
                <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm mb-2">
                    <span class="font-bold text-gray-700 text-sm">${al.ape}, ${al.nom}</span>
                    <button id="btn-as-${al.id}" onclick="cycleAsist(${al.id})" 
                        class="w-10 h-10 rounded-full font-bold border-2 flex items-center justify-center transition-all ${cls}">
                        ${st}
                    </button>
                </div>`;
            });
        }

        function cycleAsist(uid){ 
            const btn=document.getElementById(`btn-as-${uid}`); 
            const sts=['P','A','T','J'];
            const n=sts[(sts.indexOf(btn.innerText)+1)%sts.length]; 
            
            btn.innerText=n; 
            
            let cls = 'w-10 h-10 rounded-full font-bold border-2 flex items-center justify-center transition-all ';
            if(n==='P') cls+='bg-green-100 text-green-700 border-green-200';
            else if(n==='A') cls+='bg-red-100 text-red-700 border-red-200';
            else if(n==='T') cls+='bg-yellow-100 text-yellow-700 border-yellow-200';
            else cls+='bg-blue-100 text-blue-700 border-blue-200';
            
            btn.className=cls; 
        }

        function guardarLista(){ 
            const m=userData.materias.find(x=>x.id===activeId); 
            if(!m.asistencias) m.asistencias={}; 
            const map={}; 
            m.alumnos.forEach(al=>{ 
                const b=document.getElementById(`btn-as-${al.id}`); 
                if(b) map[al.id]=b.innerText; 
            }); 
            m.asistencias[activeDateISO]=map; 
            saveData(); 
            alert('✅ Asistencia guardada'); 
            nav('aula'); 
            setTab('alumnos'); 
        }

        function cancelarLista(){ nav('aula'); }

        // ==========================================
        // 📤 SECCIÓN EXPORTACIÓN (DETALLADA)
        // ==========================================
        function openExportModal(type){ 
            document.getElementById('export-type').value=type; 
            openModal('modal-export'); 
        }

        function executeExport(){
            const type = document.getElementById('export-type').value;
            const m = userData.materias.find(x=>x.id===activeId);
            
            const incList = document.getElementById('exp-lista').checked;
            const incAsist = document.getElementById('exp-asist').checked;
            const incNotas = document.getElementById('exp-notas').checked;
            const incPlan = document.getElementById('exp-plan').checked;
            
            // Obtener fechas ordenadas
            const fechas = m.asistencias ? Object.keys(m.asistencias).sort() : [];

            // --- EXCEL (CSV) ---
            if(type === 'xls'){
                let csv = "data:text/csv;charset=utf-8,";
                if(incList) csv += "APELLIDO,NOMBRE";
                if(incAsist) { 
                    fechas.forEach(f => csv += `,${f.split('-').reverse().slice(0,2).join('/')}`); 
                    csv += ",% FINAL"; 
                }
                if(incNotas) m.examenes.forEach(e => csv += "," + e.nombre);
                csv += "\n";
                
                m.alumnos.forEach(a => {
                    if(incList) csv += `${a.ape},${a.nom}`;
                    if(incAsist) {
                        let pres=0, tot=0;
                        fechas.forEach(f => { 
                            let s=m.asistencias[f][a.id]||'-'; 
                            if(s==='T') s='P'; // Tarde cuenta como presente
                            csv += `,${s}`; 
                            if(s!=='-') tot++; 
                            if(s==='P') pres++; 
                        });
                        csv += `,${tot>0 ? Math.round((pres/tot)*100) : 0}%`;
                    }
                    if(incNotas) m.examenes.forEach(e => csv += `,${a.notas[e.id]||''}`);
                    csv += "\n";
                });
                
                const link = document.createElement("a"); 
                link.setAttribute("href", encodeURI(csv)); 
                link.setAttribute("download", `Reporte_${m.nombre}.csv`); 
                document.body.appendChild(link); 
                link.click(); 
                link.remove();
            } 
            // --- PDF ---
            else {
                const { jsPDF } = window.jspdf; 
                const doc = new jsPDF('l');
                doc.setFontSize(18); doc.text(`Planilla: ${m.nombre}`, 14, 15);
                
                const head = []; const rowH = [];
                if(incList) rowH.push('Estudiante');
                if(incAsist) { 
                    fechas.forEach(f => rowH.push(f.split('-').reverse().slice(0,2).join('/'))); 
                    rowH.push('%'); 
                }
                if(incNotas) m.examenes.forEach(e => rowH.push(e.nombre));
                head.push(rowH);

                const body = m.alumnos.map(a => {
                    const row = [];
                    if(incList) row.push(`${a.ape}, ${a.nom}`);
                    if(incAsist) {
                        let pres=0, tot=0;
                        fechas.forEach(f => { 
                            let s=m.asistencias[f][a.id]||'-'; 
                            if(s==='T') s='P'; 
                            row.push(s); 
                            if(s!=='-') tot++; 
                            if(s==='P') pres++; 
                        });
                        row.push(tot>0 ? Math.round((pres/tot)*100)+'%' : '-');
                    }
                    if(incNotas) m.examenes.forEach(e => row.push(a.notas[e.id]||'-'));
                    return row;
                });

                if(incList||incAsist||incNotas) {
                    doc.autoTable({ 
                        startY: 25, 
                        head: head, 
                        body: body, 
                        styles: { fontSize: 8 }, 
                        headStyles: { fillColor: [20, 78, 126] } 
                    });
                }
                
                // Tabla Planificación
                if(incPlan && m.planificacion){
                    doc.addPage();
                    doc.text("Planificación", 14, 15);
                    const bodyPlan = Object.entries(m.planificacion).sort().map(([k,v]) => {
                         return [k.split('-').reverse().join('/'), v.tema || '-', v.actClase || '-'];
                    });
                    doc.autoTable({
                        head: [['Fecha', 'Tema', 'Actividad']],
                        body: bodyPlan,
                        startY: 20
                    });
                }
                doc.save(`Planilla_${m.nombre}.pdf`);
            }
            closeModal('modal-export');
        }

        // ==========================================
        // 🚀 ARRANQUE SEGURO
        // ==========================================
        window.onload = function() {
            console.log("Sistema Nómade V48 Iniciado");
            
            // Intentar cargar iconos
            if(typeof lucide !== 'undefined') lucide.createIcons();
            
            // Si el usuario ya estaba logueado en modo local, mostrar app
            const localData = localStorage.getItem('nomade_local_data') || localStorage.getItem('nomade_data_admin');
            
            // Detectar si hay sesión activa (simulada)
            if (localData && document.getElementById('auth-screen').classList.contains('hidden')) {
                // Ya estaba dentro
            }
        };

        // OTROS
// --- GESTIÓN DE USUARIOS ---
async function crearUsuarioDocente() {
    const uInput = document.getElementById('new-user-username').value.trim();
    const pass = document.getElementById('new-user-pass').value;
    const name = document.getElementById('new-user-fullname').value;

    if(!uInput || !pass) return alert("Faltan datos");
    if(pass.length < 6) return alert("Contraseña muy corta");

    let email = uInput.includes('@') ? uInput : uInput + '@nomade.app';
    
    const btn = document.querySelector('#view-admin button');
    const txt = btn.innerText;
    btn.innerText = "⏳"; btn.disabled = true;

    try {
        // Usar app secundaria
        let adminAuth;
        try {
            const app2 = firebase.apps.find(a=>a.name==="Secondary") || firebase.initializeApp(firebaseConfig, "Secondary");
            adminAuth = app2.auth();
        } catch(e) { throw e; }

        const cred = await adminAuth.createUserWithEmailAndPassword(email, pass);
        
        // Escribir en la lista de usuarios
        await dbCloud.collection('users').doc(cred.user.uid).set({
            email: email, 
            name: name || uInput, 
            created: new Date().toISOString()
        });
        
        // Inicializar agenda vacía
        await dbCloud.collection('app_data').doc(cred.user.uid).set({ materias: [], eventos: {}, notas: [], tareas: [] });
        
        await adminAuth.signOut();
        
        alert(`✅ ¡LISTO!\nUsuario: ${uInput}\nContraseña: ${pass}`);
        
        // Limpiar
        document.getElementById('new-user-username').value = '';
        document.getElementById('new-user-pass').value = '';
        document.getElementById('new-user-fullname').value = '';
        
        // Recargar lista
        loadAdminUsers();

    } catch(e) {
        console.error(e);
        if(e.code === 'auth/email-already-in-use') alert("⛔ EL USUARIO YA EXISTE.");
        else alert("Error: " + e.message);
    } finally {
        btn.innerText = txt; btn.disabled = false;
    }
}

async function loadAdminUsers() {
    const list = document.getElementById('admin-user-list');
    list.innerHTML = '<div class="text-center text-gray-400 mt-2">Cargando...</div>';
    
    try {
        const snap = await dbCloud.collection('users').orderBy('created', 'desc').get();
        list.innerHTML = '';
        
        if(snap.empty) { list.innerHTML='<p class="text-center text-xs mt-2">Sin usuarios.</p>'; return; }
        
        snap.forEach(doc => {
            const u = doc.data();
            list.innerHTML += `
            <div class="bg-white p-3 rounded-lg border border-gray-100 flex justify-between items-center mb-2 shadow-sm">
                <div class="overflow-hidden">
                    <span class="font-bold block text-nomade-blue text-sm truncate">${u.name}</span>
                    <span class="text-[10px] text-gray-500 truncate block">${u.email}</span>
                </div>
                <button onclick="deleteUser('${doc.id}')" class="bg-red-50 text-red-500 p-2 rounded hover:bg-red-100 ml-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>`;
        });
        lucide.createIcons();
    } catch(e) {
        console.error(e);
        list.innerHTML = '<p class="text-center text-red-400 text-xs mt-2">Error de Permisos. Revisá Firebase.</p>';
    }
}

async function deleteUser(uid) {
    if(!confirm("¿Eliminar visualmente? (El acceso Google seguirá activo)")) return;
    await dbCloud.collection('users').doc(uid).delete();
    loadAdminUsers();
}

// ESTA TAMBIÉN ES NUEVA (PARA BORRAR)
async function deleteUser(uid) {
    if(!confirm("¿Borrar usuario de la lista? (El acceso seguirá existiendo en Google, pero se borrarán sus datos)")) return;
    await dbCloud.collection('users').doc(uid).delete();
    await dbCloud.collection('app_data').doc(uid).delete();
    loadAdminUsers(); // Recargar lista
}
        function nav(v){ ['dashboard','materias','aula','lista','calendario','cuaderno','retro','admin'].forEach(id=>document.getElementById('view-'+id)?.classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); ['dash','mat','cal','cua','ret'].forEach(k => document.getElementById('nav-'+k).className = 'flex flex-col items-center text-gray-400 w-full justify-center'); const map = {dashboard:'dash', materias:'mat', calendario:'cal', cuaderno:'cua', retro:'ret'}; if(map[v]) document.getElementById('nav-'+map[v]).className = 'flex flex-col items-center text-nomade-green w-full justify-center scale-110 transition'; if(v==='dashboard') initDash(); if(v==='materias') renderMaterias(); if(v==='calendario') renderCalendar(currentMonth, currentYear); lucide.createIcons(); }
       function initDash(){ 
    const d=new Date();
    const dias=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
    const h=d.toISOString().split('T')[0]; // Fecha de hoy

    // 1. CABECERA (Fecha de hoy)
    document.getElementById('fecha-hoy').innerText=`${dias[d.getDay()]}, ${d.getDate()}/${d.getMonth()+1}`; 
    
    // 2. LISTA DE HOY (Tu Día Hoy)
    const lHoy=document.getElementById('lista-hoy'); 
    lHoy.innerHTML=''; 
    let hayClase=false; 
    
    if(userData.materias) userData.materias.forEach(m=>{ 
        if(m.dia === dias[d.getDay()]){ 
            hayClase=true; 
            const temaHoy = m.planificacion?.[h]?.tema || 'Sin tema asignado';
            
            lHoy.innerHTML+=`
            <div class="bg-white p-3 rounded-lg border-l-4 border-nomade-blue shadow-sm mb-2">
                <div class="flex justify-between items-start">
                    <strong class="block text-nomade-blue text-sm uppercase">${m.nombre}</strong>
                    <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500 font-bold">${m.horario||''}</span>
                </div>
                <div class="mt-2 text-xs text-gray-700">
                    <span class="font-bold">HOY:</span> ${temaHoy}
                </div>
            </div>`; 
        } 
    });
    
    if(userData.eventos?.[h]) userData.eventos[h].forEach(ev=>{ 
        hayClase=true; 
        lHoy.innerHTML+=`<div class="bg-white p-3 rounded-lg border-l-4 border-nomade-green shadow-sm mb-2"><span class="text-sm font-bold text-gray-700">${ev}</span></div>`; 
    }); 
    
    if(!hayClase) lHoy.innerHTML='<span class="text-xs text-gray-400 italic">Hoy no tenés actividades agendadas.</span>'; 


    // 3. PRÓXIMOS DÍAS (PLANIFICACIÓN SEMANAL) - ¡MODIFICADO!
    const lSem = document.getElementById('lista-semana');
    if(lSem) {
        lSem.innerHTML = '';
        let haySemana = false;
        
        // Revisamos los próximos 7 días
        for(let i=1; i<=7; i++){
            const next = new Date();
            next.setDate(d.getDate() + i); 
            
            const nextDayName = dias[next.getDay()]; // Ej: Lunes
            const nextDateShort = `${next.getDate()}/${next.getMonth()+1}`; // Ej: 2/2
            const nextIso = next.toISOString().split('T')[0]; // Para buscar en la DB

            if(userData.materias) {
                userData.materias.forEach(m => {
                    // Si el día de la materia coincide con el día que estamos revisando
                    if(m.dia === nextDayName){
                        haySemana = true;
                        
                        // Buscamos si hay un tema planificado para esa fecha específica
                        // Si no hay tema, pone "Sin contenido detallado" para que sepas que falta cargar
                        const temaFuturo = m.planificacion?.[nextIso]?.tema || 'Sin contenido detallado';
                        
                        // Renderizado formato: LUNES 2/2 MATERIA: Contenido
                        lSem.innerHTML += `
                        <div class="mb-3 border-b border-gray-100 pb-2 last:border-0">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-wider mb-0.5">
                                ${nextDayName} ${nextDateShort}
                            </div>
                            <div class="text-xs text-gray-800 leading-snug">
                                <strong class="text-nomade-blue uppercase">${m.nombre}:</strong> 
                                <span class="text-gray-600">${temaFuturo}</span>
                            </div>
                        </div>`;
                    }
                });
            }
        }
        if(!haySemana) lSem.innerHTML = '<span class="text-xs text-gray-400 italic">Nada programado para los próximos días.</span>';
    }

    renderTareas(); 
    lucide.createIcons();
}
        function renderMaterias(){ const l=document.getElementById('lista-materias'); l.innerHTML=''; if(!userData.materias || userData.materias.length === 0){document.getElementById('no-materias').classList.remove('hidden'); return;} document.getElementById('no-materias').classList.add('hidden'); userData.materias.forEach(m=>{ l.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center mb-2" onclick="abrirAula(${m.id})"><div><h3 class="font-bold text-nomade-blue">${m.nombre}</h3><div class="text-xs text-gray-400 uppercase">${m.dia} • ${m.modalidadBase}</div></div><i data-lucide="chevron-right" class="text-gray-300"></i></div>`; }); lucide.createIcons(); }
        function abrirAula(id){ activeId=id; const m=userData.materias.find(x=>x.id===id); document.getElementById('aula-nombre').innerText=m.nombre; document.getElementById('aula-modalidad').innerText=m.modalidadBase; nav('aula'); setTab('crono'); }
        function openDayEvents(iso){ activeCalISO = iso; const list = document.getElementById('day-events-list'); list.innerHTML = ''; document.getElementById('event-date-title').innerText = iso.split('-').reverse().slice(0,2).join('/'); const d = new Date(iso + 'T12:00:00'); const dayName = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'][d.getDay()]; if(userData.materias) { userData.materias.forEach(m => { if(m.dia === dayName) { list.innerHTML += `<div class="bg-gray-100 p-2 rounded text-xs font-bold text-gray-700 mb-1 border-l-4 border-nomade-blue">${m.nombre} <span class="block font-normal text-gray-500">${m.horario||''}</span></div>`; } }); } if(userData.eventos && userData.eventos[iso]) { userData.eventos[iso].forEach((ev, idx) => { list.innerHTML += `<div class="bg-white p-2 rounded text-xs flex justify-between mb-1 border border-gray-200"><span>${ev}</span><button onclick="delEvent('${iso}',${idx})" class="text-red-500 font-bold">X</button></div>`; }); } openModal('modal-cal-event'); }
        function changeMonth(step){currentMonth+=step; if(currentMonth>11){currentMonth=0;currentYear++}else if(currentMonth<0){currentMonth=11;currentYear--} renderCalendar(currentMonth,currentYear);}
        function renderCalendar(m,y){const months=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]; document.getElementById('cal-month-year').innerText=`${months[m]} ${y}`; const first=new Date(y,m,1).getDay(), days=new Date(y,m+1,0).getDate(), g=document.getElementById('calendar-grid'); g.innerHTML=''; for(let i=0;i<first;i++)g.innerHTML+='<div></div>'; for(let i=1;i<=days;i++){const iso=new Date(y,m,i).toISOString().split('T')[0]; let dots=''; if(userData.eventos?.[iso]) dots+=`<div class="w-1.5 h-1.5 bg-nomade-green rounded-full"></div>`; if(userData.materias) userData.materias.forEach(mt=>{const map=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado']; if(mt.dia===map[new Date(y,m,i).getDay()]) dots+=`<div class="w-1.5 h-1.5 bg-nomade-blue rounded-full"></div>`;}); g.innerHTML+=`<div onclick="openDayEvents('${iso}')" class="calendar-day flex flex-col items-center justify-between border rounded-lg cursor-pointer hover:bg-gray-50"><span class="text-xs font-bold">${i}</span><div class="flex gap-0.5">${dots}</div></div>`;}}
        function addCalendarEvent(){const t=document.getElementById('new-event-text').value; if(!userData.eventos) userData.eventos={}; if(!userData.eventos[activeCalISO]) userData.eventos[activeCalISO]=[]; userData.eventos[activeCalISO].push(t); saveData(); closeModal('modal-cal-event'); renderCalendar(currentMonth,currentYear); initDash();}
        function delEvent(iso,idx){userData.eventos[iso].splice(idx,1); saveData(); openDayEvents(iso); renderCalendar(currentMonth,currentYear); initDash();}
        function renderTareas(){const l=document.getElementById('lista-tareas'); l.innerHTML=''; userData.tareas.forEach((t,i)=>l.innerHTML+=`<div class="flex items-center gap-2 p-2 border-b"><input type="checkbox" ${t.done?'checked':''} onchange="toggleTarea(${i})"><span class="${t.done?'line-through opacity-50':''}">${t.text}</span><button onclick="delTarea(${i})" class="ml-auto text-red-500">X</button></div>`);}
        function guardarTarea(){userData.tareas.push({text:document.getElementById('input-tarea-txt').value, done:false}); saveData(); closeModal('modal-tarea'); renderTareas();}
        function toggleTarea(i){userData.tareas[i].done=!userData.tareas[i].done; saveData(); renderTareas();}
        function delTarea(i){userData.tareas.splice(i,1); saveData(); renderTareas();}
        function openSettings(){document.getElementById('modal-settings').classList.remove('hidden');} function closeModal(id){document.getElementById(id).classList.add('hidden');} function openModal(id){document.getElementById(id).classList.remove('hidden');} function setTab(t){['crono','alumnos','notas'].forEach(x=>{document.getElementById('tab-'+x).classList.add('hidden'); document.getElementById('btn-'+x).className='flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400';}); document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('btn-'+t).className='flex-1 py-2 px-1 text-[10px] font-bold rounded-lg bg-nomade-blue text-white'; if(t==='crono')renderCrono(); if(t==='alumnos')renderAlum(); if(t==='notas')renderNotas();}
        function openClaseDetail(iso){activeDateISO=iso; const m=userData.materias.find(x=>x.id===activeId), p=m.planificacion?.[iso]||{}; document.getElementById('detail-date').innerText=iso; document.getElementById('detail-tema').value=p.tema||''; document.getElementById('detail-biblio').value=p.biblio||''; document.getElementById('detail-act-clase').value=p.actClase||''; document.getElementById('detail-act-tarea').value=p.actTarea||''; openModal('modal-clase-detail');}
        function saveClaseDetail(){const m=userData.materias.find(x=>x.id===activeId); if(!m.planificacion) m.planificacion={}; m.planificacion[activeDateISO]={tema:document.getElementById('detail-tema').value, biblio:document.getElementById('detail-biblio').value, actClase:document.getElementById('detail-act-clase').value, actTarea:document.getElementById('detail-act-tarea').value}; saveData(); closeModal('modal-clase-detail'); renderCrono();}
        function openImportModal(){document.getElementById('modal-import').classList.remove('hidden'); document.getElementById('input-import-text').value='';}
        function processImport(){const raw=document.getElementById('input-import-text').value; if(!raw.trim()){alert("Pega el contenido.");return;} const lines=raw.split('\n'); const m=userData.materias.find(x=>x.id===activeId); if(!m.planificacion) m.planificacion={}; let count=0; lines.forEach(line=>{const parts=line.split('\t'); if(parts.length>=1){const dateRaw=parts[0].trim(); const match=dateRaw.match(/^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/); if(match){const day=match[1].padStart(2,'0'); const month=match[2].padStart(2,'0'); const year=match[3].length===2?'20'+match[3]:match[3]; const isoDate=`${year}-${month}-${day}`; let idx=1; if(parts[idx]&&parts[idx].trim().length<3&&!isNaN(parseInt(parts[idx]))) idx++; const tema=parts[idx]?parts[idx].trim():""; const biblio=parts[idx+1]?parts[idx+1].trim():""; const actClase=parts[idx+2]?parts[idx+2].trim():""; const actTarea=parts[idx+3]?parts[idx+3].trim():""; if(tema){m.planificacion[isoDate]={tema,biblio,actClase,actTarea}; count++;}}}}); saveData(); alert(`✅ Se importaron ${count} clases.`); closeModal('modal-import'); renderCrono();}
        function renderAlum(){const m=userData.materias.find(x=>x.id===activeId), l=document.getElementById('lista-alumnos'); l.innerHTML=''; m.alumnos.forEach((al,i)=>{l.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center mb-2 shadow-sm"><div class="flex items-center gap-3"><div class="avatar-small overflow-hidden"><img src="${al.foto||'https://via.placeholder.com/40'}" class="w-full h-full object-cover"></div><span class="font-bold text-gray-700">${al.ape}, ${al.nom}</span></div><button onclick="delAlum(${i})" class="text-red-400"><i data-lucide="trash-2" class="w-4"></i></button></div>`;}); lucide.createIcons();}
        function guardarAlumno(){const m=userData.materias.find(x=>x.id===activeId); const fotoInput=document.getElementById('input-alum-foto'); let fotoUrl=''; if(fotoInput.files[0]){const reader=new FileReader(); reader.onload=function(e){fotoUrl=e.target.result; m.alumnos.push({id:Date.now(), ape:document.getElementById('input-alum-ape').value, nom:document.getElementById('input-alum-nom').value, foto:fotoUrl, notas:{}}); saveData(); closeModal('modal-alumno'); renderAlum();}; reader.readAsDataURL(fotoInput.files[0]);} else {m.alumnos.push({id:Date.now(), ape:document.getElementById('input-alum-ape').value, nom:document.getElementById('input-alum-nom').value, foto:'', notas:{}}); saveData(); closeModal('modal-alumno'); renderAlum();}}
        function previewImage(input){if(input.files&&input.files[0]){const reader=new FileReader(); reader.onload=function(e){document.getElementById('preview-foto').src=e.target.result; document.getElementById('preview-foto').classList.remove('hidden'); document.getElementById('placeholder-foto').classList.add('hidden');}; reader.readAsDataURL(input.files[0]);}}
        function delAlum(i){const m=userData.materias.find(x=>x.id===activeId); m.alumnos.splice(i,1); saveData(); renderAlum();}
        function openAlumnoModal(idx=null){document.getElementById('edit-alum-idx').value=idx!==null?idx:''; document.getElementById('input-alum-ape').value=idx!==null?userData.materias.find(x=>x.id===activeId).alumnos[idx].ape:''; document.getElementById('input-alum-nom').value=idx!==null?userData.materias.find(x=>x.id===activeId).alumnos[idx].nom:''; document.getElementById('preview-foto').classList.add('hidden'); document.getElementById('placeholder-foto').classList.remove('hidden'); openModal('modal-alumno');}
        function openExamModal(idx=null){document.getElementById('edit-exam-id').value=idx!==null?idx:''; if(idx!==null){const e=userData.materias.find(x=>x.id===activeId).examenes[idx]; document.getElementById('input-exam-nom').value=e.nombre; document.getElementById('input-exam-date').value=e.fecha;}else{document.getElementById('input-exam-nom').value='';} openModal('modal-examen');}
        function renderNotas(){const m=userData.materias.find(x=>x.id===activeId), h=document.getElementById('head-notas'), b=document.getElementById('body-notas'); h.innerHTML='<th>Alumno</th>'; m.examenes.forEach((e,i)=>h.innerHTML+=`<th onclick="openExamModal(${i})" class="cursor-pointer hover:text-blue-500">${e.nombre}</th>`); h.innerHTML+='<th>+</th>'; b.innerHTML=''; m.alumnos.forEach((al,i)=>{let r=`<tr><td class="p-2 border-b text-sm">${al.ape}</td>`; m.examenes.forEach(e=>{ r+=`<td class="p-2 border-b"><input class="w-8 p-1 border rounded text-center" value="${al.notas[e.id]||''}" onchange="saveNota(${i},${e.id},this.value)"></td>`; }); r+='<td></td></tr>'; b.innerHTML+=r;});}
        function guardarExamen(){const m=userData.materias.find(x=>x.id===activeId); m.examenes.push({id:Date.now(), nombre:document.getElementById('input-exam-nom').value}); saveData(); closeModal('modal-examen'); renderNotas();}
        function saveNota(i,eid,v){const m=userData.materias.find(x=>x.id===activeId); m.alumnos[i].notas[eid]=v; saveData();}
        
        // EXPORTACION
        function openExportModal(type){ document.getElementById('export-type').value=type; openModal('modal-export'); }
       // ==========================================
// 📊 PARCHE EXPORTACIÓN DETALLADA (V46)
// ==========================================

function executeExport() {
    const type = document.getElementById('export-type').value;
    const incList = document.getElementById('exp-lista').checked;
    const incAsist = document.getElementById('exp-asist').checked;
    const incNotas = document.getElementById('exp-notas').checked;
    const incPlan = document.getElementById('exp-plan').checked;
    
    const m = userData.materias.find(x => x.id === activeId);
    if (!m) return;

    // Obtener TODAS las fechas donde se tomó lista, ordenadas
    const fechas = m.asistencias ? Object.keys(m.asistencias).sort() : [];

    // --- MODO EXCEL (CSV) ---
    if (type === 'xls') {
        let csv = "data:text/csv;charset=utf-8,";
        
        // Cabeceras
        if (incList) csv += "APELLIDO,NOMBRE";
        if (incAsist) {
            fechas.forEach(f => {
                // Formato dd/mm
                const d = f.split('-')[2] + '/' + f.split('-')[1];
                csv += `,${d}`;
            });
            csv += ",% FINAL";
        }
        if (incNotas) {
            m.examenes.forEach(e => csv += `,NOTA: ${e.nombre}`);
        }
        csv += "\n";

        // Filas
        m.alumnos.forEach(a => {
            if (incList) csv += `${a.ape},${a.nom}`;
            
            if (incAsist) {
                let presentes = 0;
                let total = 0;
                fechas.forEach(f => {
                    let st = m.asistencias[f][a.id] || '-';
                    // REGLA: Tarde cuenta como Presente en el reporte
                    if (st === 'T') st = 'P';
                    
                    csv += `,${st}`;
                    
                    if (st !== '-') total++;
                    if (st === 'P') presentes++;
                });
                const porc = total > 0 ? Math.round((presentes/total)*100) : 0;
                csv += `,${porc}%`;
            }

            if (incNotas) {
                m.examenes.forEach(e => csv += `,${a.notas[e.id]||''}`);
            }
            csv += "\n";
        });
        
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csv));
        link.setAttribute("download", `Reporte_${m.nombre}.csv`);
        document.body.appendChild(link);
        link.click();
        link.remove();
    } 
    // --- MODO PDF ---
    else {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l'); // Horizontal
        
        doc.setFontSize(18);
        doc.text(`Planilla: ${m.nombre}`, 14, 15);
        doc.setFontSize(10);
        doc.text(`Horario: ${m.horario || '-'}`, 14, 22);

        const head = [];
        const body = [];

        // Armar cabecera PDF
        const rowHead = [];
        if(incList) rowHead.push('Apellido y Nombre');
        if(incAsist) {
            fechas.forEach(f => rowHead.push(f.split('-')[2]+'/'+f.split('-')[1]));
            rowHead.push('%');
        }
        if(incNotas) m.examenes.forEach(e => rowHead.push(e.nombre));
        head.push(rowHead);

        // Armar cuerpo PDF
        m.alumnos.forEach(a => {
            const row = [];
            if(incList) row.push(`${a.ape}, ${a.nom}`);
            
            if(incAsist) {
                let presentes = 0, total = 0;
                fechas.forEach(f => {
                    let st = m.asistencias[f][a.id] || '-';
                    if (st === 'T') st = 'P'; // Regla T=P
                    row.push(st);
                    if(st!=='-') total++;
                    if(st==='P') presentes++;
                });
                row.push(total > 0 ? Math.round((presentes/total)*100)+'%' : '-');
            }
            
            if(incNotas) {
                m.examenes.forEach(e => row.push(a.notas[e.id]||'-'));
            }
            body.push(row);
        });

        if(incList || incAsist || incNotas) {
            doc.autoTable({
                startY: 25,
                head: head,
                body: body,
                styles: { fontSize: 8, cellPadding: 1 },
                headStyles: { fillColor: [20, 78, 126] }
            });
        }

        if(incPlan) {
            doc.addPage();
            doc.text("Planificación", 14, 15);
            const bodyPlan = Object.entries(m.planificacion || {}).sort().map(([k,v]) => {
                 return [k.split('-').reverse().join('/'), v.tema, v.actClase];
            });
            doc.autoTable({
                head: [['Fecha', 'Tema', 'Actividad']],
                body: bodyPlan,
                startY: 20
            });
        }
        
        doc.save(`Planilla_${m.nombre}.pdf`);
    }
    closeModal('modal-export');
}
        // ==========================================
// 📋 FUNCIONES DE ASISTENCIA (PEGAR AL FINAL DEL SCRIPT)
// ==========================================

function iniciarTomaLista() {
    // 1. Verificamos que haya una materia abierta
    if (!activeId) {
        alert("Error: No se ha seleccionado ninguna materia.");
        return;
    }

    // 2. Preparamos la fecha de hoy
    const hoy = new Date().toISOString().split('T')[0];
    
    // 3. Forzamos el valor en el input de fecha (si existe en el HTML)
    const inputFecha = document.getElementById('input-fecha-lista');
    if (inputFecha) {
        inputFecha.value = hoy;
    }

    // 4. Generamos la lista visual
    cambiarFechaLista(hoy);
    
    // 5. Cambiamos de pantalla a la vista "lista"
    nav('lista');
}

function cambiarFechaLista(iso) {
    activeDateISO = iso; // Guardamos la fecha seleccionada en la variable global
    
    // Buscamos la materia activa
    const m = userData.materias.find(x => x.id === activeId);
    if (!m) return;

    const container = document.getElementById('lista-check-container');
    container.innerHTML = ''; // Limpiamos la lista anterior

    // Si no hay alumnos, avisamos
    if (!m.alumnos || m.alumnos.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 mt-10">No hay alumnos inscriptos en esta materia.</div>';
        return;
    }

    // Si no existe el objeto de asistencias para esa fecha, usamos uno vacío
    const asistenciaDia = (m.asistencias && m.asistencias[iso]) ? m.asistencias[iso] : {};

    // Dibujamos la fila por cada alumno
    m.alumnos.forEach(al => {
        // Estado actual (o 'P' por defecto si no hay nada guardado)
        const estado = asistenciaDia[al.id] || 'P';
        
        // Definir colores según estado para que se vea lindo
        let colorClass = '';
        if(estado === 'P') colorClass = 'bg-green-100 text-green-700 border-green-200'; // Presente
        else if(estado === 'A') colorClass = 'bg-red-100 text-red-700 border-red-200';   // Ausente
        else if(estado === 'T') colorClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; // Tarde
        else colorClass = 'bg-blue-100 text-blue-700 border-blue-200'; // Justificado

        container.innerHTML += `
        <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm mb-2">
            <span class="font-bold text-gray-700 text-sm">${al.ape}, ${al.nom}</span>
            <button id="btn-as-${al.id}" onclick="cycleAsist(${al.id})" 
                class="w-10 h-10 rounded-full font-bold border-2 flex items-center justify-center transition-all ${colorClass}">
                ${estado}
            </button>
        </div>`;
    });
}

function cycleAsist(uid) {
    const btn = document.getElementById(`btn-as-${uid}`);
    const estados = ['P', 'A', 'T', 'J']; // Orden de rotación: Presente -> Ausente -> Tarde -> Justificado
    const actual = btn.innerText;
    const nuevo = estados[(estados.indexOf(actual) + 1) % estados.length];
    
    // Cambiamos el texto del botón
    btn.innerText = nuevo;
    
    // Actualizamos el color al instante según el nuevo estado
    let nuevaClase = "w-10 h-10 rounded-full font-bold border-2 flex items-center justify-center transition-all ";
    if(nuevo === 'P') nuevaClase += 'bg-green-100 text-green-700 border-green-200';
    else if(nuevo === 'A') nuevaClase += 'bg-red-100 text-red-700 border-red-200';
    else if(nuevo === 'T') nuevaClase += 'bg-yellow-100 text-yellow-700 border-yellow-200';
    else nuevaClase += 'bg-blue-100 text-blue-700 border-blue-200';
    
    btn.className = nuevaClase;
}

function guardarLista() {
    const m = userData.materias.find(x => x.id === activeId);
    
    // Asegurar que la estructura de datos existe en la materia
    if (!m.asistencias) m.asistencias = {};
    
    // Recolectar datos de los botones visuales
    const map = {};
    m.alumnos.forEach(al => {
        const btn = document.getElementById(`btn-as-${al.id}`);
        if(btn) {
            map[al.id] = btn.innerText;
        }
    });
    
    // Guardar en memoria bajo la fecha activa
    m.asistencias[activeDateISO] = map;
    saveData(); // Guardar en Firebase/LocalStorage
    
    alert('✅ Asistencia guardada correctamente.');
    nav('aula'); // Volver al aula
    setTab('alumnos'); // Mostrar la pestaña alumnos
}

function cancelarLista() {
    nav('aula');
}
        // --- INICIALIZACIÓN SEGURA ---

// Esta función asegura que los iconos se vean al cargar
window.onload = function() {
    console.log("App iniciada");
    lucide.createIcons();
    
    // Si quedó un login trabado, intentamos mostrar dashboard
    if(localStorage.getItem('nomade_local_data') && document.getElementById('auth-screen').classList.contains('hidden')) {
        renderMaterias();
        initDash();
        renderTareas();
    }
};

// Re-ejecutar iconos cada vez que tocamos la pantalla por si acaso
document.addEventListener('click', function() {
    setTimeout(() => lucide.createIcons(), 100);
});
        // Función para llamar en lugar de alert()
function showToast(message) {
    const x = document.getElementById("toast-notification");
    x.innerText = message;
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

// --- LÓGICA DEL TUTORIAL (WIZARD) ---
        let tutStep = 1;

        // --- TUTORIAL WIZARD ---
function showTutorial(){ 
    document.getElementById('modal-tutorial').classList.remove('hidden'); 
    tutStep = 1; updateTut(); 
}
function nextTutorial(){ 
    if(tutStep < 4) { tutStep++; updateTut(); }
    else { document.getElementById('modal-tutorial').classList.add('hidden'); } 
}
function updateTut(){
    for(let i=1; i<=4; i++) {
        document.getElementById(`tut-step-${i}`).classList.add('hidden');
        document.getElementById(`dot-${i}`).classList.remove('bg-nomade-green');
        document.getElementById(`dot-${i}`).classList.add('bg-white/30');
    }
    document.getElementById(`tut-step-${tutStep}`).classList.remove('hidden');
    document.getElementById(`dot-${tutStep}`).classList.remove('bg-white/30');
    document.getElementById(`dot-${tutStep}`).classList.add('bg-nomade-green');
    
    document.getElementById('btn-tut-next').innerText = tutStep === 4 ? '¡COMENZAR!' : 'SIGUIENTE ➝';
    lucide.createIcons();
}
        function updateTut(){
            // 1. Ocultar todos los pasos y resetear puntos
            [1,2,3].forEach(i => {
                const step = document.getElementById(`tut-step-${i}`);
                const dot = document.getElementById(`dot-${i}`);
                if(step) step.classList.add('hidden');
                if(dot) {
                    dot.classList.remove('bg-nomade-green'); // Sacar color activo
                    dot.classList.add('bg-white/30');      // Poner color inactivo
                }
            });
            
            // 2. Mostrar paso actual
            const currentStep = document.getElementById(`tut-step-${tutStep}`);
            const currentDot = document.getElementById(`dot-${tutStep}`);
            
            if(currentStep) currentStep.classList.remove('hidden');
            if(currentDot) {
                currentDot.classList.remove('bg-white/30');
                currentDot.classList.add('bg-nomade-green'); // Poner color activo
            }
            
            // 3. Actualizar texto del botón
            const btn = document.getElementById('btn-tut-next');
            if(btn) btn.innerText = tutStep === 3 ? '¡COMENZAR!' : 'SIGUIENTE ➝';
            
            // 4. Refrescar iconos por si acaso
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- NOTIFICACIONES TOAST ---
        function showToast(msg) { 
            const x = document.getElementById("toast-notification");
            if(x) {
                x.innerText = msg; 
                x.className = "show"; 
                setTimeout(() => x.className = x.className.replace("show", ""), 3000); 
            }
        }

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            console.log("Nómade App Lista");
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

    </script>
    
    <div id="toast-notification">Notificación</div>
</body>
</html>













