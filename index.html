<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raspanti Docente Cloud</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#800020">
    <link rel="apple-touch-icon" href="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        raspanti: { bordo: '#800020', crema: '#FFFDD0', dorado: '#C5B358' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; font-family: system-ui, sans-serif; overscroll-behavior: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .badge-transition { transition: all 0.2s ease; }
        .badge-transition:active { transform: scale(0.9); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        .task-check:checked + div { text-decoration: line-through; opacity: 0.5; }
        .input-nota { min-width: 40px; text-align: center; }
        
        .btn-asist { width: 35px; height: 35px; border-radius: 50%; font-weight: 900; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; transition: all 0.2s; }
        .st-P { background: #DCFCE7; color: #166534; border-color: #166534; }
        .st-T { background: #FEF9C3; color: #854D0E; border-color: #854D0E; }
        .st-J { background: #DBEAFE; color: #1E40AF; border-color: #1E40AF; }
        .st-A { background: #FEE2E2; color: #991B1B; border-color: #991B1B; }
        
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #e5e7eb; }
        .progress-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { background: white; border-radius: 8px; min-height: 70px; padding: 4px; font-size: 10px; position: relative; border: 1px solid #f1f5f9; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .calendar-day:active { background-color: #f8fafc; border-color: #C5B358; }
        .calendar-day.today { border: 2px solid #C5B358; background: #FFFBEB; }
        .day-number { font-weight: bold; font-size: 12px; color: #334155; }
        .dots-container { display: flex; gap: 2px; flex-wrap: wrap; content-visibility: auto; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; }
        
        #canvas-container { touch-action: none; background: white; border-radius: 10px; overflow: hidden; height: 60vh; position: relative; border: 1px solid #e5e7eb; cursor: crosshair; }
        
        /* Status Cloud */
        #cloud-status { position: fixed; top: 10px; right: 10px; z-index: 100; font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.5s; pointer-events: none;}
        .saving { color: #d97706; }
        .saved { color: #16a34a; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #800020; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos Formulario Retroalimentación */
        .retro-label { font-size: 9px; font-weight: 800; color: #800020; text-transform: uppercase; margin-bottom: 2px; display: block; margin-top: 6px; letter-spacing: 0.5px; }
        .retro-select { width: 100%; padding: 6px 8px; background-color: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; font-weight: 600; color: #334155; outline: none; }
        .retro-select:focus { border-color: #C5B358; background-color: #FFFBEB; }
        .section-title { font-size: 10px; font-weight: 900; background: #e2e8f0; color: #475569; padding: 3px 8px; border-radius: 4px; margin-top: 12px; margin-bottom: 2px; letter-spacing: 0.5px; text-transform: uppercase; }
        
        /* Debug Error Box */
        .debug-box { background: #fee2e2; border: 2px solid #ef4444; color: #991b1b; padding: 10px; border-radius: 8px; font-size: 10px; font-family: monospace; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 bg-slate-50">

    <div id="cloud-status"><i data-lucide="cloud" class="w-3 h-3"></i> <span id="cloud-text">Sincronizado</span></div>

    <div id="auth-screen" class="fixed inset-0 bg-raspanti-bordo z-50 flex flex-col items-center justify-center p-6 text-center text-white">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center border-4 border-raspanti-dorado mb-6 text-raspanti-bordo text-4xl font-black">R</div>
        <h1 class="text-2xl font-bold uppercase mb-8">Instituto Raspanti<br><span class="text-raspanti-dorado text-sm">Agenda Docente Cloud</span></h1>
        <button onclick="login()" class="bg-white text-raspanti-bordo w-full max-w-xs py-4 rounded-xl font-bold shadow-lg hover:bg-gray-100 transition">INGRESAR</button>
        <p class="mt-4 text-xs opacity-60">Sincronización activa</p>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden relative">
        <header class="bg-raspanti-bordo text-white p-4 flex justify-between items-center shadow-md z-20 pt-safe-top">
            <div class="flex items-center gap-3">
                <div class="bg-white text-raspanti-bordo font-black p-1 rounded">R</div>
                <span class="font-bold text-sm uppercase">Mi Agenda</span>
            </div>
            <button onclick="openSettings()" class="opacity-90 hover:opacity-100 transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24 max-w-md mx-auto w-full no-scrollbar relative">
            
            <div id="view-dashboard" class="fade-in space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold text-raspanti-bordo flex items-center gap-2 cursor-pointer" onclick="editProfileName()">
                                <span id="dash-name">Hola Profe</span> <i data-lucide="pencil" class="w-3 h-3 text-gray-300"></i>
                            </h2>
                            <p class="text-gray-500 text-sm" id="fecha-hoy">Cargando...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-raspanti-bordo text-white p-5 rounded-2xl shadow-lg">
                    <h3 class="font-bold mb-3 border-b border-white/20 pb-2">Tu Día Hoy</h3>
                    <div id="lista-hoy" class="text-sm space-y-2"></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4 text-raspanti-dorado"></i> Planificación Semanal</h3>
                    <div id="lista-semana" class="text-sm space-y-3"></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-700">Tareas</h3><button onclick="openModal('modal-tarea')" class="text-xs bg-raspanti-crema text-raspanti-bordo px-2 py-1 rounded font-bold">+ NUEVA</button></div>
                    <div id="lista-tareas" class="space-y-2"></div>
                    <p id="no-tareas" class="text-center text-xs text-gray-400 mt-2 hidden">Sin tareas pendientes.</p>
                </div>
            </div>

            <div id="view-calendario" class="hidden fade-in h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="cal-month-year" class="text-xl font-bold text-raspanti-bordo capitalize">Mes Año</h2>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-2 bg-white rounded-lg shadow-sm border active:bg-gray-100"><i data-lucide="chevron-left" class="w-4"></i></button>
                        <button onclick="changeMonth(1)" class="p-2 bg-white rounded-lg shadow-sm border active:bg-gray-100"><i data-lucide="chevron-right" class="w-4"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-gray-400"><div>D</div><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div></div>
                <div id="calendar-grid" class="calendar-grid flex-1"></div>
            </div>

            <div id="view-materias" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-raspanti-bordo">Mis Materias</h2><button onclick="openMateriaModal()" class="bg-raspanti-bordo text-white p-2 rounded-lg shadow"><i data-lucide="plus"></i></button></div>
                <div id="lista-materias" class="space-y-3"></div>
                <p id="no-materias" class="text-center text-gray-400 text-sm mt-10 hidden">No hay materias.</p>
            </div>

            <div id="view-retro" class="hidden fade-in space-y-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-3 mb-3 border-b border-gray-100 pb-2">
                        <div class="p-2 bg-raspanti-dorado rounded-full text-white"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                        <div><h2 class="font-bold text-raspanti-bordo text-md">Retroalimentación</h2><p class="text-[10px] text-gray-500">Evaluación pedagógica (Diagnóstico)</p></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="retro-label">ESTUDIANTE</label><input id="ia-nombre" class="retro-select" placeholder="Nombre"></div>
                        <div><label class="retro-label">FECHA</label><input id="ia-fecha" type="date" class="retro-select"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="retro-label">MATERIA</label><input id="ia-materia" class="retro-select" placeholder="Materia"></div>
                        <div>
                            <label class="retro-label">INSTANCIA</label>
                            <select id="ia-instancia" class="retro-select">
                                <option value="Parcial Domiciliario">Parcial Domiciliario</option>
                                <option value="Trabajo Práctico">Trabajo Práctico</option>
                                <option value="Parcial Presencial">Parcial Presencial</option>
                                <option value="Examen Final">Examen Final</option>
                                <option value="Entrega de Proceso">Entrega de Proceso</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title">1. DIMENSIÓN TEÓRICA Y PRÁCTICA</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="retro-label">Dominio Conceptual</label>
                            <select id="crit-contenidos" class="retro-select">
                                <option value="Excelente profundidad">Excelente profundidad</option>
                                <option value="Muy buena comprensión">Muy buena comprensión</option>
                                <option value="Comprensión correcta">Bueno / Correcto</option>
                                <option value="Confusiones a revisar">Regular / Confuso</option>
                                <option value="Contenidos insuficientes">Insuficiente</option>
                            </select>
                        </div>
                        <div>
                            <label class="retro-label">Vinculación Práctica</label>
                            <select id="crit-practica" class="retro-select">
                                <option value="Excelente articulación teoría-realidad">Excelente articulación</option>
                                <option value="Logra relacionar conceptos">Logra relacionar</option>
                                <option value="Relación escasa o forzada">Escasa / Forzada</option>
                                <option value="Sin vínculo con la práctica">Sin vínculo práctico</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="section-title">2. PENSAMIENTO CRÍTICO</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="retro-label">Mirada Crítica</label>
                            <select id="crit-critica" class="retro-select">
                                <option value="Problematiza con agudeza">Problematiza (Excelente)</option>
                                <option value="Articula opinión personal">Articula opinión (Muy Bien)</option>
                                <option value="Correcto pero descriptivo">Descriptivo (Bien)</option>
                                <option value="Sentido común / Repite">Sentido común</option>
                            </select>
                        </div>
                        <div>
                            <label class="retro-label">Indagación/Preguntas</label>
                            <select id="crit-preguntas" class="retro-select">
                                <option value="Abre nuevos interrogantes potentes">Abre interrogantes</option>
                                <option value="Formula preguntas pertinentes">Preguntas correctas</option>
                                <option value="Cierra sentidos, no pregunta">No abre preguntas</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title">3. ESCRITURA ACADÉMICA</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="retro-label">Redacción y Sintaxis</label>
                            <select id="crit-redaccion" class="retro-select">
                                <option value="Impecable y fluida">Impecable</option>
                                <option value="Clara">Clara</option>
                                <option value="Errores leves de cohesión">Errores leves</option>
                                <option value="Confusa / Dificulta lectura">Confusa</option>
                            </select>
                        </div>
                        <div>
                            <label class="retro-label">Vocabulario Técnico</label>
                            <select id="crit-vocabulario" class="retro-select">
                                <option value="Preciso y específico de la materia">Preciso y específico</option>
                                <option value="Uso correcto en general">Uso correcto</option>
                                <option value="Coloquial o impreciso">Coloquial / Impreciso</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="retro-label">Normas APA / Biblio</label>
                            <select id="crit-apa" class="retro-select">
                                <option value="Citas y referencias impecables">Citas impecables</option>
                                <option value="Cita correctamente la mayoría">Citas correctas</option>
                                <option value="Errores en formato de cita">Errores formato</option>
                                <option value="No cita fuentes / Plagio involuntario">No cita fuentes</option>
                            </select>
                        </div>
                        <div>
                            <label class="retro-label">Ortografía</label>
                            <select id="crit-ortografia" class="retro-select">
                                <option value="Sin errores">Sin errores</option>
                                <option value="Algunos errores menores">Errores menores</option>
                                <option value="Errores frecuentes">Errores frecuentes</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title">4. PROCESO Y PRESENTACIÓN</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="retro-label">Creatividad / Voz</label>
                            <select id="crit-creatividad" class="retro-select">
                                <option value="Muy original, marca personal">Muy original</option>
                                <option value="Buenas ideas propias">Buenas ideas</option>
                                <option value="Resolución estándar">Estándar</option>
                                <option value="Mecánico o estereotipado">Mecánico</option>
                            </select>
                        </div>
                        <div>
                            <label class="retro-label">Evolución Proceso</label>
                            <select id="crit-evolucion" class="retro-select">
                                <option value="Avance muy notable desde el inicio">Avance notable</option>
                                <option value="Se observa crecimiento">Crecimiento sostenido</option>
                                <option value="Mantiene el nivel (bueno)">Mantiene nivel</option>
                                <option value="Estancamiento o retroceso">Estancamiento</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="retro-label">Recursos/Soportes</label>
                            <select id="crit-recursos" class="retro-select">
                                <option value="Uso excelente de recursos (video/img)">Excelente uso recursos</option>
                                <option value="Buenos soportes complementarios">Buenos soportes</option>
                                <option value="Solo texto plano">Solo texto</option>
                                <option value="Fallo en soportes (links rotos)">Fallo soportes</option>
                            </select>
                        </div>
                        <div>
                            <label class="retro-label">Síntesis</label>
                            <select id="crit-sintesis" class="retro-select">
                                <option value="Poder de síntesis destacado">Gran síntesis</option>
                                <option value="Adecuada">Adecuada</option>
                                <option value="Reiterativo o extenso innecesariamente">Reiterativo</option>
                                <option value="Demasiado breve/incompleto">Incompleto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-2 mt-1">
                        <div>
                            <label class="retro-label">Entrega (Tiempo)</label>
                            <select id="crit-entrega" class="retro-select">
                                <option value="En tiempo y forma">En tiempo y forma</option>
                                <option value="Entrega fuera de término">Fuera de término</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="retro-label">OBSERVACIÓN ESPECÍFICA (Opcional)</label>
                        <textarea id="ia-obs-extra" class="retro-select h-12 resize-none" placeholder="Detalle puntual: video, punto 2, etc."></textarea>
                    </div>
                    
                    <button onclick="generarDevolucion()" id="btn-generar" class="w-full bg-raspanti-bordo text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 mt-4 hover:bg-red-900 transition"><i data-lucide="wand-2" class="w-5 h-5"></i> GENERAR DEVOLUCIÓN</button>
                    
                    <div id="debug-log" class="hidden debug-box"></div>
                </div>

                <div id="ia-resultado-container" class="hidden bg-white p-5 rounded-2xl shadow-lg border-2 border-raspanti-dorado relative">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700">Borrador (Editable):</h3>
                        <span class="text-[10px] text-gray-400">Tocá para editar</span>
                    </div>
                    
                    <textarea id="ia-output" class="w-full h-64 p-3 bg-yellow-50 text-gray-700 text-sm leading-relaxed border border-gray-200 rounded-lg outline-none focus:border-raspanti-dorado resize-none font-sans"></textarea>
                    
                    <button onclick="copiarIA()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold text-xs flex justify-center items-center gap-2 mt-3 hover:bg-black">
                        <i data-lucide="copy" class="w-4 h-4"></i> COPIAR TEXTO FINAL
                    </button>
                </div>
            </div>

            <div id="view-cuaderno" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-raspanti-bordo">Cuaderno</h2><button onclick="openModal('modal-new-nota')" class="bg-raspanti-bordo text-white p-2 rounded-lg shadow"><i data-lucide="plus"></i></button></div>
                <div id="lista-notas" class="grid grid-cols-2 gap-3"></div>
                <p id="no-notas" class="text-center text-gray-400 text-sm mt-10 hidden">Sin notas guardadas.</p>
                <div id="editor-nota" class="hidden fixed inset-0 bg-white z-50 flex flex-col">
                    <div class="p-4 bg-raspanti-bordo text-white flex justify-between items-center shadow">
                        <button onclick="closeEditor()" class="flex items-center gap-1 font-bold text-xs"><i data-lucide="arrow-left" class="w-4"></i> VOLVER</button>
                        <span id="editor-title" class="font-bold">Editar</span>
                        <button onclick="saveCurrentNote()" class="bg-white text-raspanti-bordo px-3 py-1 rounded font-bold text-xs">GUARDAR</button>
                    </div>
                    <div class="flex-1 p-4 overflow-y-auto">
                        <textarea id="editor-text" class="w-full h-full p-4 bg-yellow-50 text-gray-800 text-lg leading-relaxed outline-none resize-none hidden" placeholder="Escribe aquí..."></textarea>
                        <div id="editor-draw" class="hidden h-full flex flex-col">
                            <div class="flex justify-center gap-4 mb-2 p-2 bg-gray-50 rounded-lg"><button onclick="setTool('black')" class="w-6 h-6 rounded-full bg-black ring-1 ring-gray-300"></button><button onclick="setTool('blue')" class="w-6 h-6 rounded-full bg-blue-600 ring-1 ring-gray-300"></button><button onclick="setTool('red')" class="w-6 h-6 rounded-full bg-red-600 ring-1 ring-gray-300"></button><button onclick="setTool('eraser')" class="text-gray-500"><i data-lucide="eraser" class="w-5"></i></button><button onclick="clearCanvas()" class="text-red-500"><i data-lucide="trash-2" class="w-5"></i></button></div>
                            <div id="canvas-container"><canvas id="drawing-canvas"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-aula" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <button onclick="nav('materias')" class="text-gray-500 text-xs font-bold flex items-center gap-1"><i data-lucide="arrow-left" class="w-3"></i> VOLVER</button>
                    <div class="flex gap-2">
                        <button onclick="iniciarTomaLista()" class="bg-raspanti-bordo text-white px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="check-square" class="w-3 h-3"></i> ASIST</button>
                        <button onclick="exportarExcel()" class="bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> XLS</button>
                        <button onclick="generarPDF()" class="bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <span id="aula-modalidad" class="text-[10px] bg-raspanti-crema text-raspanti-bordo px-2 py-1 rounded font-bold uppercase">--</span>
                    <h2 id="aula-nombre" class="text-2xl font-black text-raspanti-bordo mt-2 leading-tight">Materia</h2>
                </div>
                <div class="flex bg-white p-1 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                    <button onclick="setTab('crono')" id="btn-crono" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg bg-raspanti-crema text-raspanti-bordo">CRONOGRAMA</button>
                    <button onclick="setTab('alumnos')" id="btn-alumnos" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400">ALUMNOS</button>
                    <button onclick="setTab('notas')" id="btn-notas" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400">NOTAS</button>
                </div>
                <div id="tab-crono" class="space-y-3">
                    <div class="flex justify-between items-center"><p class="text-xs text-gray-500 font-bold ml-1">Planificación</p><button onclick="openImportModal()" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200 font-bold flex items-center gap-1"><i data-lucide="file-spreadsheet" class="w-3 h-3"></i> IMPORTAR</button></div>
                    <div id="lista-cronograma" class="space-y-3"></div>
                </div>
                <div id="tab-alumnos" class="hidden space-y-3">
                    <div class="flex justify-between items-center px-1"><h3 class="font-bold text-gray-600 text-sm">Padrón</h3><button onclick="openAlumnoModal()" class="text-xs bg-raspanti-dorado text-white px-3 py-1 rounded shadow font-bold">AGREGAR</button></div>
                    <div id="lista-alumnos" class="space-y-2"></div>
                </div>
                <div id="tab-notas" class="hidden space-y-3">
                    <div class="flex justify-between items-center px-1"><h3 class="font-bold text-gray-600 text-sm">Libro de Notas</h3><button onclick="openExamModal()" class="text-xs bg-raspanti-bordo text-white px-3 py-1 rounded shadow font-bold">NUEVO EXAMEN</button></div>
                    <div class="overflow-x-auto bg-white rounded-xl border border-gray-100 shadow-sm"><table class="w-full text-sm"><thead><tr id="head-notas" class="bg-gray-50 text-gray-500 text-left"><th class="p-3">Alumno</th></tr></thead><tbody id="body-notas"></tbody></table></div>
                </div>
            </div>

            <div id="view-lista" class="hidden fade-in space-y-4">
                <button onclick="cancelarLista()" class="text-gray-500 text-xs font-bold flex items-center gap-1"><i data-lucide="x" class="w-3"></i> CANCELAR</button>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-end mb-2"><p class="text-[10px] font-bold text-gray-400 uppercase">FECHA</p><span id="lista-modalidad-badge" class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">--</span></div>
                    <input type="date" id="input-fecha-lista" onchange="cambiarFechaLista(this.value)" class="w-full p-2 bg-gray-50 rounded-lg border font-bold text-raspanti-bordo text-lg mb-2">
                    <div class="flex justify-center gap-3 text-[10px] font-bold text-gray-400 mb-2"><span><span class="text-green-700">P</span>resente</span><span><span class="text-yellow-700">T</span>arde</span><span><span class="text-blue-700">J</span>ustif</span><span><span class="text-red-700">A</span>usente</span></div>
                    <button onclick="guardarLista()" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-600 transition flex justify-center items-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> GUARDAR</button>
                </div>
                <div id="lista-check-container" class="space-y-2 pb-10"></div>
            </div>
        </main>

        <nav id="navbar" class="fixed bottom-0 w-full bg-white border-t border-gray-200 h-16 flex justify-around items-center z-30 pb-safe-bottom shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
            <button onclick="nav('dashboard')" id="nav-dash" class="flex flex-col items-center text-raspanti-bordo w-full justify-center"><i data-lucide="layout-dashboard" class="w-5 mb-1"></i><span class="text-[9px] font-bold">INICIO</span></button>
            <button onclick="nav('calendario')" id="nav-cal" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="calendar" class="w-5 mb-1"></i><span class="text-[9px] font-bold">CALENDARIO</span></button>
            <button onclick="nav('retro')" id="nav-ret" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="sparkles" class="w-5 mb-1"></i><span class="text-[9px] font-bold">RETRO</span></button>
            <button onclick="nav('materias')" id="nav-mat" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="book" class="w-5 mb-1"></i><span class="text-[9px] font-bold">MATERIAS</span></button>
            <button onclick="nav('cuaderno')" id="nav-cua" class="flex flex-col items-center text-gray-400 w-full justify-center"><i data-lucide="notebook" class="w-5 mb-1"></i><span class="text-[9px] font-bold">CUADERNO</span></button>
        </nav>
    </div>

    <div id="modal-new-nota" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4">Nueva Nota</h3><input id="new-nota-title" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Título"><label class="text-xs font-bold text-gray-500 mb-2 block">TIPO DE NOTA</label><div class="grid grid-cols-2 gap-3 mb-4"><button onclick="createNote('text')" class="p-4 bg-blue-50 rounded-xl border border-blue-100 flex flex-col items-center gap-2 hover:bg-blue-100"><i data-lucide="type" class="w-6 h-6 text-blue-600"></i><span class="text-xs font-bold text-blue-800">TEXTO</span></button><button onclick="createNote('draw')" class="p-4 bg-purple-50 rounded-xl border border-purple-100 flex flex-col items-center gap-2 hover:bg-purple-100"><i data-lucide="pen-tool" class="w-6 h-6 text-purple-600"></i><span class="text-xs font-bold text-purple-800">DIBUJO</span></button></div><button onclick="closeModal('modal-new-nota')" class="w-full text-gray-400 text-sm font-bold">Cancelar</button></div></div>
    <div id="modal-cal-event" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-2" id="event-date-title">--/--</h3><p class="text-xs text-gray-500 mb-4">Agenda del día:</p><div id="day-events-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div><div class="border-t pt-4"><input id="new-event-text" class="w-full p-2 bg-gray-50 rounded border mb-2" placeholder="Agregar evento..."><div class="flex gap-2"><button onclick="closeModal('modal-cal-event')" class="flex-1 py-2 text-gray-500 font-bold text-xs">CERRAR</button><button onclick="addCalendarEvent()" class="flex-1 py-2 bg-raspanti-bordo text-white rounded font-bold text-xs">AGREGAR</button></div></div></div></div>
    <div id="modal-tarea" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4">Nueva Tarea</h3><input id="input-tarea-txt" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Descripción"><div class="flex gap-2"><button onclick="closeModal('modal-tarea')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarTarea()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-materia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4" id="title-materia">Nueva Materia</h3><input type="hidden" id="edit-mat-id"><label class="text-xs font-bold text-gray-500 ml-1">NOMBRE</label><input id="input-mat-nombre" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold" placeholder="Ej: Matemática"><label class="text-xs font-bold text-gray-500 ml-1">INICIO CURSADA</label><input type="date" id="input-mat-inicio" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold"><div class="grid grid-cols-2 gap-2 mb-4"><div><label class="text-xs font-bold text-gray-500 ml-1">DÍA</label><select id="input-mat-dia" class="w-full p-3 bg-gray-50 rounded-lg border font-bold text-gray-700"><option value="Lunes">Lunes</option><option value="Martes">Martes</option><option value="Miércoles">Miércoles</option><option value="Jueves">Jueves</option><option value="Viernes">Viernes</option></select></div><div><label class="text-xs font-bold text-gray-500 ml-1">MODALIDAD</label><select id="input-mat-mod" class="w-full p-3 bg-gray-50 rounded-lg border font-bold text-gray-700"><option value="Hibrida">Mixta</option><option value="Presencial">Presencial</option><option value="Virtual">Virtual</option></select></div></div><div class="flex gap-2"><button onclick="closeModal('modal-materia')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarMateria()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-alumno" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4" id="title-alumno">Nuevo Alumno</h3><input type="hidden" id="edit-alum-idx"><div class="flex justify-center mb-4"><label for="input-alum-foto" class="avatar-upload group"><img id="preview-foto" src="" class="hidden"><div id="placeholder-foto" class="text-gray-400 text-center text-[10px] font-bold"><i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>Foto</div><input type="file" id="input-alum-foto" class="hidden" accept="image/*" onchange="previewImage(this)"></label></div><input id="input-alum-ape" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold" placeholder="Apellido"><input id="input-alum-nom" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Nombre"><div class="flex gap-2"><button onclick="closeModal('modal-alumno')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarAlumno()" class="flex-1 py-3 bg-raspanti-dorado text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-examen" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4" id="title-examen">Nuevo Examen/TP</h3><input type="hidden" id="edit-exam-id"><input id="input-exam-nom" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border font-bold" placeholder="Nombre"><label class="text-xs font-bold text-gray-500 ml-1">FECHA</label><input type="date" id="input-exam-date" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold"><div class="flex gap-2"><button onclick="closeModal('modal-examen')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarExamen()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-obs" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-2">Observación</h3><p id="obs-alum-name" class="text-sm font-bold text-gray-500 mb-3"></p><textarea id="input-obs-txt" class="w-full p-3 bg-gray-50 rounded-lg border h-32 mb-4" placeholder="Escribe una observación..."></textarea><div class="flex gap-2"><button onclick="closeModal('modal-obs')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarObs()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-settings" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center"><h3 class="text-lg font-black text-raspanti-bordo mb-6">Configuración</h3><div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-100"><i data-lucide="download" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i><h4 class="font-bold text-blue-800">Copia de Seguridad</h4><button onclick="downloadBackup()" class="bg-blue-600 text-white w-full py-2 rounded-lg font-bold text-sm shadow mt-2">DESCARGAR</button></div><div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-200"><i data-lucide="upload" class="w-8 h-8 text-gray-500 mx-auto mb-2"></i><h4 class="font-bold text-gray-700">Restaurar</h4><input type="file" id="file-restore" class="hidden" onchange="restoreBackup(this)"><button onclick="document.getElementById('file-restore').click()" class="bg-gray-200 text-gray-700 w-full py-2 rounded-lg font-bold text-sm mt-2">SELECCIONAR ARCHIVO</button></div><button onclick="closeModal('modal-settings')" class="block w-full mt-4 text-gray-400 text-sm font-bold">Cerrar</button></div></div>
    <div id="modal-import" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative"><button onclick="closeModal('modal-import')" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button><h3 class="text-lg font-black text-raspanti-bordo mb-2">Importar Planificación</h3><p class="text-xs text-gray-500 mb-4">Copia 4 columnas de tu Excel (Fecha, Contenido, Biblio, Actividad) y pega aquí.</p><textarea id="input-import-text" class="w-full p-3 bg-gray-50 rounded-lg border h-40 text-xs font-mono mb-4" placeholder="17/03/2025  Tema 1  Libro A  TP1..."></textarea><button onclick="processImport()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2"><i data-lucide="check" class="w-5 h-5"></i> PROCESAR</button></div></div>
    <div id="modal-clase-detail" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative max-h-[90vh] overflow-y-auto"><h3 class="text-lg font-black text-raspanti-bordo mb-1" id="detail-date">--/--</h3><input type="hidden" id="detail-iso"><div class="space-y-3 mt-4"><div><label class="text-xs font-bold text-gray-500">CONTENIDO / TEMA</label><textarea id="detail-tema" class="w-full p-2 bg-gray-50 rounded border text-sm font-medium h-20"></textarea></div><div><label class="text-xs font-bold text-gray-500">BIBLIOGRAFÍA</label><textarea id="detail-biblio" class="w-full p-2 bg-gray-50 rounded border text-sm text-gray-600 h-16"></textarea></div><div><label class="text-xs font-bold text-gray-500">ACTIVIDAD CLASE</label><input id="detail-act-clase" class="w-full p-2 bg-gray-50 rounded border text-sm"></div><div><label class="text-xs font-bold text-gray-500">TAREA</label><input id="detail-act-tarea" class="w-full p-2 bg-gray-50 rounded border text-sm"></div></div><div class="flex gap-2 mt-4"><button onclick="closeModal('modal-clase-detail')" class="flex-1 py-3 text-gray-500 font-bold">Cerrar</button><button onclick="saveClaseDetail()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    
    <div id="install-modal" class="fixed inset-0 z-[70] bg-black/60 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-[30px] sm:rounded-[30px] p-6 slide-up shadow-2xl relative">
            <button onclick="closeInstall()" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 bg-raspanti-bordo rounded-2xl flex items-center justify-center border-4 border-raspanti-dorado shadow-md text-white font-black text-2xl">R</div>
                <div><h3 class="font-bold text-lg leading-tight">Instalar App</h3><p class="text-xs text-gray-500">Mejor experiencia.</p></div>
            </div>
            <div id="install-ios" class="hidden space-y-3 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-100">
                <p>1. Toca <strong>Compartir</strong> <i data-lucide="share" class="w-4 h-4 text-blue-500"></i></p>
                <p>2. <strong>"Agregar a Inicio"</strong> <i data-lucide="plus-square" class="w-4 h-4 text-gray-800"></i></p>
            </div>
            <div id="install-android" class="hidden">
                <button onclick="triggerInstall()" class="w-full bg-raspanti-bordo text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i> INSTALAR
                </button>
            </div>
            <div id="install-guide-arrow" class="install-guide-arrow hidden"><i data-lucide="arrow-up" class="w-10 h-10 text-white drop-shadow-lg"></i></div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN (CLAVE 4IhE) ---
        const API_KEY = 'AIzaSyBOTt8wiuveaBsttTMpVwQBafxJ05P4IhE'; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyBpBjGm2jdqlearWnBiwn4jxjeby3nA0gk",
            authDomain: "raspanti-app.firebaseapp.com",
            projectId: "raspanti-app",
            storageBucket: "raspanti-app.firebasestorage.app",
            messagingSenderId: "898404256450",
            appId: "1:898404256450:web:8ba27e3350b8efb22c095b",
            measurementId: "G-QMMLBB5NJM"
        };

        // --- 2. INICIALIZACIÓN FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const dbCloud = firebase.firestore();
        const auth = firebase.auth();
        const CLOUD_DOC_ID = 'datos_profesor';
        
        auth.signInAnonymously().catch(error => console.error("Error Auth:", error));

        function showCloudStatus(msg, type='saving') {
            const el = document.getElementById('cloud-status');
            const txt = document.getElementById('cloud-text');
            el.style.opacity = '1'; txt.innerText = msg; txt.className = type;
            setTimeout(() => { el.style.opacity = '0'; }, 3000);
        }

        async function syncFromCloud() {
            try {
                showCloudStatus('Sincronizando...', 'saving');
                const doc = await dbCloud.collection('raspanti_data').doc(CLOUD_DOC_ID).get();
                if (doc.exists) {
                    const cloudData = doc.data();
                    const localData = JSON.parse(localStorage.getItem('raspanti_v18') || '{}');
                    if (!localData.lastMod || (cloudData.lastMod && cloudData.lastMod > localData.lastMod)) {
                        localStorage.setItem('raspanti_v18', JSON.stringify(cloudData));
                        location.reload();
                    }
                }
                showCloudStatus('Al día', 'saved');
            } catch (e) { console.error("Error sync:", e); }
        }

        function saveToCloud(data) {
            data.lastMod = Date.now();
            showCloudStatus('Guardando...', 'saving');
            dbCloud.collection('raspanti_data').doc(CLOUD_DOC_ID).set(data)
                .then(() => showCloudStatus('Guardado', 'saved'))
                .catch((e) => showCloudStatus('Error', 'saving'));
        }

        // --- 3. IA SYSTEM ---
        const SYSTEM_PROMPT = `
        Sos Lucía Snieg, Lic. Prof. en Educación Especial y docente de Nivel Superior.
        Tu objetivo es redactar retroalimentaciones pedagógicas completas, cálidas y constructivas.
        ESTILO:
        - Tono: Profesional pero cercano (Argentino: "podés", "tenés", "observé").
        - Estructura: Saludo, valoración general, desglose de los puntos fuertes y débiles, sugerencias de mejora y cierre motivador.
        - Firma: Al final, dejá dos espacios y poné tu firma: LUCIA SNIEG - Lic. Prof. Educación Especial.
        `;

        const DB={
            get:()=>JSON.parse(localStorage.getItem('raspanti_v18'))||{materias:[], tareas:[], eventos:{}, notas:[], profileName:'Hola Profe'}, 
            save:(d)=>{ localStorage.setItem('raspanti_v18',JSON.stringify(d)); saveToCloud(d); }
        };

        let activeId=null, activeDateISO=null, activeObsIdx=null, tempFoto='', activeCalISO=null, activeNoteId=null;
        let currentMonth=new Date().getMonth(), currentYear=new Date().getFullYear();

        lucide.createIcons();
        if(localStorage.getItem('raspanti_logged')){
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            initDash(); syncFromCloud();
        }

        function login(){localStorage.setItem('raspanti_logged','true');location.reload();}
        function logout(){localStorage.removeItem('raspanti_logged');location.reload();}
        
        function nav(v){
            ['dashboard','materias','aula','lista','calendario','cuaderno','retro'].forEach(id=>{ const el=document.getElementById('view-'+id); if(el) el.classList.add('hidden'); });
            document.getElementById('view-'+v).classList.remove('hidden');
            ['dash','cal','mat','cua','ret'].forEach(k=>{ 
                const el=document.getElementById('nav-'+k); 
                if(el) el.className = el.id===('nav-'+(v==='dashboard'?'dash':(v==='retro'?'ret':v.substring(0,3)))) ? 'flex flex-col items-center text-raspanti-bordo w-full justify-center' : 'flex flex-col items-center text-gray-400 w-full justify-center'; 
            });
            document.getElementById('navbar').style.display=(v==='aula'||v==='lista')?'none':'flex';
            if(v==='dashboard') initDash(); if(v==='materias') renderMaterias(); if(v==='calendario') renderCalendar(currentMonth, currentYear); if(v==='cuaderno') renderNotesList();
            if(v==='retro') document.getElementById('ia-fecha').value = new Date().toISOString().split('T')[0];
        }

        // --- IA LOGIC (DIAGNOSTIC MODE V8.0) ---
        async function generarDevolucion() {
            const nombre = document.getElementById('ia-nombre').value;
            const materia = document.getElementById('ia-materia').value;
            const fecha = document.getElementById('ia-fecha').value;
            const instancia = document.getElementById('ia-instancia').value;
            
            // Recolección de criterios...
            const cContenidos = document.getElementById('crit-contenidos').value;
            const cPractica = document.getElementById('crit-practica').value;
            const cCritica = document.getElementById('crit-critica').value;
            const cPreguntas = document.getElementById('crit-preguntas').value;
            const cRedaccion = document.getElementById('crit-redaccion').value;
            const cVocabulario = document.getElementById('crit-vocabulario').value;
            const cApa = document.getElementById('crit-apa').value;
            const cOrtografia = document.getElementById('crit-ortografia').value;
            const cCreatividad = document.getElementById('crit-creatividad').value;
            const cEvolucion = document.getElementById('crit-evolucion').value;
            const cRecursos = document.getElementById('crit-recursos').value;
            const cSintesis = document.getElementById('crit-sintesis').value;
            const cEntrega = document.getElementById('crit-entrega').value;
            const obsExtra = document.getElementById('ia-obs-extra').value;

            const btn = document.getElementById('btn-generar');
            const output = document.getElementById('ia-output');
            const container = document.getElementById('ia-resultado-container');
            const debugLog = document.getElementById('debug-log'); // Nuevo log

            if(!nombre) { alert('Por favor, ingresá al menos el nombre.'); return; }

            // LIMPIEZA DE CLAVE (quita espacios invisibles)
            const CLEAN_KEY = API_KEY.trim();

            btn.innerHTML = '<div class="loader"></div> Diagnosticando...';
            btn.disabled = true;
            debugLog.classList.add('hidden');
            debugLog.innerText = '';

            const fullPrompt = `
            ${SYSTEM_PROMPT}
            TAREA: Generá una devolución para: ${nombre}.
            Materia: ${materia}. Fecha: ${fecha}. Instancia: ${instancia}.
            CRITERIOS: ${cContenidos}, ${cPractica}, ${cCritica}, ${cPreguntas}, ${cRedaccion}, ${cVocabulario}, ${cApa}, ${cOrtografia}, ${cCreatividad}, ${cEvolucion}, ${cRecursos}, ${cSintesis}, ${cEntrega}.
            NOTA ADICIONAL: "${obsExtra}"
            `;

            // INTENTO SIMPLE CON EL MODELO MÁS ESTÁNDAR
            const modelUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CLEAN_KEY}`;

            try {
                const response = await fetch(modelUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });

                const data = await response.json();

                if (!response.ok) {
                    // SI FALLA, MOSTRAMOS EL ERROR EXACTO EN PANTALLA
                    throw new Error(`Error ${response.status}: ${data.error?.message || response.statusText}`);
                }

                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("Google respondió pero sin contenido (Blocked?).");
                }

                // ÉXITO
                output.value = data.candidates[0].content.parts[0].text; 
                container.classList.remove('hidden');
                container.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                // MOSTRAR EL ERROR EN ROJO PARA DIAGNÓSTICO
                debugLog.innerText = `FALLO TÉCNICO:\n${error.message}\n\nPor favor enviame una captura de este recuadro rojo.`;
                debugLog.classList.remove('hidden');
                alert('Ocurrió un error. Mirá el recuadro rojo abajo del botón.');
            } finally {
                btn.innerHTML = '<i data-lucide="wand-2" class="w-5 h-5"></i> GENERAR DEVOLUCIÓN'; 
                btn.disabled = false; 
                lucide.createIcons(); 
            }
        }

        function copiarIA() { 
            const text = document.getElementById('ia-output').value; 
            navigator.clipboard.writeText(text).then(() => alert('Copiado al portapapeles')); 
        }

        // --- DASHBOARD Y FUNCIONES EXISTENTES ---
        function initDash(){
            const d=new Date(), dias=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'], h=d.toISOString().split('T')[0];
            document.getElementById('fecha-hoy').innerText=`${dias[d.getDay()]}, ${d.getDate()}/${d.getMonth()+1}`;
            const db=DB.get(); document.getElementById('dash-name').innerText=db.profileName||'Hola Profe';
            const l=document.getElementById('lista-hoy'); l.innerHTML=''; let y=false;
            db.materias.forEach(m=>{
                let t=m.cronograma?.[h]; let plan = m.planificacion?.[h]; let planTema = plan ? (typeof plan === 'string' ? plan : plan.tema) : '';
                if(t && t!=='Sin Clase'){
                    y=true; let c='bg-gray-400',x=''; 
                    if(t.startsWith('Presenc')){c='bg-red-500';x='(Inst.)';}else if(t.startsWith('Virt')){c='bg-blue-400';x='(Zoom)';}else if(t.startsWith('Asinc')){c='bg-yellow-400';x='(Campus)';}
                    l.innerHTML+=`<div class="bg-white/10 p-3 rounded-lg flex items-center gap-3 mb-2"><div class="w-3 h-3 ${c} rounded-full border border-white/20 shrink-0"></div><div class="overflow-hidden"><strong class="block text-sm truncate">${m.nombre}</strong><div class="flex items-center gap-2"><span class="text-xs opacity-80 uppercase font-bold">${t} ${x}</span>${planTema?`<span class="text-[10px] bg-black/20 px-1.5 py-0.5 rounded text-white/90 truncate max-w-[150px]">${planTema}</span>`:''}</div></div></div>`;
                }
            });
            if(db.eventos?.[h]){ db.eventos[h].forEach(ev => { y=true; l.innerHTML += `<div class="bg-white/90 p-3 rounded-lg flex items-center gap-3 mb-2 border-l-4 border-purple-500 text-gray-800"><i data-lucide="calendar" class="w-4 h-4 text-purple-600"></i><span class="text-sm font-bold">${ev}</span></div>`; }); }
            if(!y)l.innerHTML='<span class="opacity-60 italic text-sm">Sin actividades hoy.</span>';
            const ls=document.getElementById('lista-semana'); ls.innerHTML=''; let ys=false; let current = new Date(); const first = current.getDate() - current.getDay() + 1; let monday = new Date(current.setDate(first));
            for(let i=0; i<5; i++){ let loopDate = new Date(monday); loopDate.setDate(monday.getDate() + i); let iso = loopDate.toISOString().split('T')[0]; let dayName = dias[loopDate.getDay()]; db.materias.forEach(m => { const plan = m.planificacion?.[iso]; const tema = plan ? (typeof plan === 'string' ? plan : plan.tema) : null; if(tema){ ys=true; ls.innerHTML += `<div class="border-l-2 border-raspanti-dorado pl-3 py-1"><span class="text-xs font-bold text-gray-400 uppercase block">${dayName} - ${m.nombre}</span><p class="text-sm font-medium text-gray-700 truncate">${tema}</p></div>`; } }); }
            if(!ys) ls.innerHTML = '<span class="text-xs text-gray-400 italic">Nada planificado esta semana.</span>';
            renderTareas(); lucide.createIcons();
        }
        function editProfileName(){const n = prompt("Nombre:", document.getElementById('dash-name').innerText); if(n){ const db=DB.get(); db.profileName=n; DB.save(db); initDash(); }}
        function renderTareas(){const db=DB.get(),l=document.getElementById('lista-tareas'); l.innerHTML=''; if(db.tareas.length===0){document.getElementById('no-tareas').classList.remove('hidden');return;} document.getElementById('no-tareas').classList.add('hidden'); db.tareas.forEach((t,i)=>{l.innerHTML+=`<div class="flex items-center gap-3 p-2 border-b border-gray-50 last:border-0"><input type="checkbox" class="task-check w-5 h-5 rounded border-gray-300 text-raspanti-bordo focus:ring-raspanti-bordo" ${t.done?'checked':''} onchange="toggleTarea(${i})"><div class="flex-1 text-sm font-medium text-gray-700">${t.text}</div><button onclick="borrarTarea(${i})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4"></i></button></div>`;}); lucide.createIcons();}
        function guardarTarea(){const db=DB.get(); db.tareas.push({text:document.getElementById('input-tarea-txt').value, done:false}); DB.save(db); closeModal('modal-tarea'); renderTareas();}
        function toggleTarea(i){const db=DB.get(); db.tareas[i].done=!db.tareas[i].done; DB.save(db); renderTareas();}
        function borrarTarea(i){const db=DB.get(); db.tareas.splice(i,1); DB.save(db); renderTareas();}

        // --- CALENDARIO ---
        function changeMonth(step){ currentMonth+=step; if(currentMonth>11){currentMonth=0;currentYear++;} else if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(currentMonth, currentYear); }
        function formatDate(d){ const year=d.getFullYear(), month=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${year}-${month}-${day}`; }
        function renderCalendar(month, year){
            const monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
            document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month+1, 0).getDate();
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = ''; const db = DB.get();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let day=1; day<=daysInMonth; day++){
                const date = new Date(year, month, day); const iso = formatDate(date); const dayName = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"][date.getDay()];
                const isToday = iso === formatDate(new Date());
                let html = `<div onclick="openDayEvents('${iso}')" class="calendar-day ${isToday?'today':''}"><span class="day-number">${day}</span><div class="dots-container">`;
                db.materias.forEach(m => { if(new Date(iso) >= new Date(m.fechaInicio) && m.dia === dayName){ const override = m.cronograma?.[iso]; if(override !== 'Sin Clase'){ let col='bg-gray-400'; const type=override||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase); if(type.startsWith('Presenc'))col='bg-red-500'; if(type.startsWith('Virt'))col='bg-blue-400'; if(type.startsWith('Asinc'))col='bg-yellow-400'; html += `<div class="event-dot ${col}"></div>`; } } });
                if(db.eventos?.[iso]) db.eventos[iso].forEach(ev => html += `<div class="event-dot bg-purple-500"></div>`);
                html += `</div></div>`; grid.innerHTML += html;
            }
        }
        function openDayEvents(iso){
            activeCalISO = iso; const db = DB.get(); const dParts = iso.split('-'); document.getElementById('event-date-title').innerText = `${dParts[2]}/${dParts[1]}`;
            const list = document.getElementById('day-events-list'); list.innerHTML = '';
            const dayName = ["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"][new Date(parseInt(dParts[0]), parseInt(dParts[1])-1, parseInt(dParts[2])).getDay()];
            db.materias.forEach(m => { if(new Date(iso) >= new Date(m.fechaInicio) && m.dia === dayName && m.cronograma?.[iso] !== 'Sin Clase'){ const st = m.cronograma?.[iso] || m.modalidadBase; list.innerHTML += `<div class="bg-gray-100 p-2 rounded text-xs font-bold text-gray-700 mb-1 border-l-4 border-raspanti-dorado">${m.nombre} (${st})</div>`; } });
            if(db.eventos?.[iso]) db.eventos[iso].forEach((ev, idx) => list.innerHTML += `<div class="bg-purple-50 p-2 rounded text-xs flex justify-between mb-1"><span>${ev}</span><button onclick="delEvent('${iso}',${idx})" class="text-red-500 font-bold">X</button></div>`);
            document.getElementById('modal-cal-event').classList.remove('hidden');
        }
        function addCalendarEvent(){ const txt=document.getElementById('new-event-text').value; if(!txt)return; const db=DB.get(); if(!db.eventos)db.eventos={}; if(!db.eventos[activeCalISO])db.eventos[activeCalISO]=[]; db.eventos[activeCalISO].push(txt); DB.save(db); document.getElementById('new-event-text').value=''; openDayEvents(activeCalISO); renderCalendar(currentMonth, currentYear); initDash(); }
        function delEvent(iso, idx){ const db=DB.get(); db.eventos[iso].splice(idx,1); DB.save(db); openDayEvents(iso); renderCalendar(currentMonth, currentYear); initDash(); }

        // --- CUADERNO ---
        function renderNotesList(){const db=DB.get();const l=document.getElementById('lista-notas');l.innerHTML='';if(!db.notas||db.notas.length===0){document.getElementById('no-notas').classList.remove('hidden');return;}document.getElementById('no-notas').classList.add('hidden');db.notas.forEach((n,i)=>{const icon=n.type==='text'?'file-text':'image';const c=n.type==='text'?'text-blue-500':'text-purple-500';l.innerHTML+=`<div onclick="openNoteEditor(${i})" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-32 relative group cursor-pointer"><div><i data-lucide="${icon}" class="w-6 h-6 ${c} mb-2"></i><h3 class="font-bold text-sm text-gray-800 leading-tight line-clamp-2">${n.title}</h3><p class="text-[10px] text-gray-400 mt-1">${new Date(n.id).toLocaleDateString()}</p></div><button onclick="event.stopPropagation();deleteNote(${i})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;});lucide.createIcons();}
        function createNote(t){const tl=document.getElementById('new-nota-title').value||'Sin Título';const db=DB.get();if(!db.notas)db.notas=[];db.notas.unshift({id:Date.now(),title:tl,type:t,content:t==='text'?'':null});DB.save(db);closeModal('modal-new-nota');document.getElementById('new-nota-title').value='';openNoteEditor(0);}
        function deleteNote(i){if(confirm('¿Borrar?')){const db=DB.get();db.notas.splice(i,1);DB.save(db);renderNotesList();}}
        let canvas, ctx, drawing=false, lastX=0, lastY=0, penColor='black';
        function openNoteEditor(i){const db=DB.get(), n=db.notas[i]; activeNoteId=n.id; document.getElementById('editor-title').innerText=n.title; const t=document.getElementById('editor-text'), d=document.getElementById('editor-draw'); document.getElementById('editor-nota').classList.remove('hidden'); if(n.type==='text'){t.classList.remove('hidden');d.classList.add('hidden');t.value=n.content||'';}else{t.classList.add('hidden');d.classList.remove('hidden');initCanvas(n.content);}}
        function closeEditor(){document.getElementById('editor-nota').classList.add('hidden');renderNotesList();}
        function saveCurrentNote(){const db=DB.get(), i=db.notas.findIndex(n=>n.id===activeNoteId); if(i===-1)return; if(db.notas[i].type==='text'){db.notas[i].content=document.getElementById('editor-text').value;}else{db.notas[i].content=canvas.toDataURL();} DB.save(db); alert('Guardado');}
        function initCanvas(src){canvas=document.getElementById('drawing-canvas');ctx=canvas.getContext('2d');const p=document.getElementById('canvas-container');canvas.width=p.clientWidth;canvas.height=p.clientHeight;ctx.fillStyle="white";ctx.fillRect(0,0,canvas.width,canvas.height);if(src){const i=new Image();i.onload=()=>ctx.drawImage(i,0,0);i.src=src;} canvas.onmousedown=startDraw;canvas.onmousemove=draw;canvas.onmouseup=stopDraw;canvas.ontouchstart=(e)=>{e.preventDefault();startDraw(e.touches[0]);};canvas.ontouchmove=(e)=>{e.preventDefault();draw(e.touches[0]);};canvas.ontouchend=stopDraw;}
        function startDraw(e){drawing=true;const r=canvas.getBoundingClientRect();lastX=e.clientX-r.left;lastY=e.clientY-r.top;}
        function draw(e){if(!drawing)return;const r=canvas.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(x,y);ctx.strokeStyle=penColor;ctx.lineWidth=(penColor==='white'?20:2);ctx.lineCap='round';ctx.stroke();lastX=x;lastY=y;}
        function stopDraw(){drawing=false;}
        function setTool(c){penColor=(c==='eraser'?'white':c);}
        function clearCanvas(){ctx.fillStyle="white";ctx.fillRect(0,0,canvas.width,canvas.height);}

        // --- MATERIAS & RESTO ---
        function openMateriaModal(id=null){document.getElementById('title-materia').innerText=id?'Editar Materia':'Nueva Materia'; document.getElementById('edit-mat-id').value=id||''; if(id){const m=DB.get().materias.find(x=>x.id==id); document.getElementById('input-mat-nombre').value=m.nombre; document.getElementById('input-mat-inicio').value=m.fechaInicio; document.getElementById('input-mat-dia').value=m.dia; document.getElementById('input-mat-mod').value=m.modalidadBase;} else{document.getElementById('input-mat-nombre').value='';} openModal('modal-materia');}
        function guardarMateria(){const db=DB.get(), eid=document.getElementById('edit-mat-id').value; const mat={nombre:document.getElementById('input-mat-nombre').value, modalidadBase:document.getElementById('input-mat-mod').value, dia:document.getElementById('input-mat-dia').value, fechaInicio:document.getElementById('input-mat-inicio').value||new Date().toISOString().split('T')[0]}; if(eid){const idx=db.materias.findIndex(x=>x.id==eid); db.materias[idx]={...db.materias[idx],...mat};} else{mat.id=Date.now(); mat.cronograma={}; mat.planificacion={}; mat.alumnos=[]; mat.examenes=[]; mat.asistencias={}; db.materias.push(mat);} DB.save(db); closeModal('modal-materia'); renderMaterias();}
        function renderMaterias(){const l=document.getElementById('lista-materias'); l.innerHTML=''; const db=DB.get(); document.getElementById('no-materias').classList.toggle('hidden',db.materias.length>0); db.materias.forEach(m=>{l.innerHTML+=`<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div onclick="abrirAula(${m.id})" class="flex-1"><h3 class="font-bold text-gray-800">${m.nombre}</h3><div class="text-xs text-gray-400 font-bold uppercase mt-1">${m.dia} • ${m.modalidadBase}</div></div><div class="flex gap-1"><button onclick="openMateriaModal(${m.id})" class="text-gray-400 hover:text-blue-500 p-2"><i data-lucide="pencil" class="w-4"></i></button><button onclick="borrarMateria(${m.id})" class="text-gray-400 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4"></i></button></div></div>`;}); lucide.createIcons();}
        function borrarMateria(id){if(confirm('¿Eliminar?')){const db=DB.get(); db.materias=db.materias.filter(m=>m.id!==id); DB.save(db); renderMaterias();}}
        function abrirAula(id){activeId=id; const m=DB.get().materias.find(x=>x.id===id); document.getElementById('aula-nombre').innerText=m.nombre; document.getElementById('aula-modalidad').innerText=m.modalidadBase; nav('aula'); setTab('crono');}
        function setTab(t){['crono','alumnos','notas'].forEach(x=>{document.getElementById('tab-'+x).classList.add('hidden'); document.getElementById('btn-'+x).className='flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400';}); document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('btn-'+t).className='flex-1 py-2 px-1 text-[10px] font-bold rounded-lg bg-raspanti-crema text-raspanti-bordo'; if(t==='crono')renderCrono(); if(t==='alumnos')renderAlum(); if(t==='notas')renderNotas();}
        function renderCrono(){const m=DB.get().materias.find(x=>x.id===activeId), l=document.getElementById('lista-cronograma'); l.innerHTML=''; const map={'Domingo':0,'Lunes':1,'Martes':2,'Miércoles':3,'Jueves':4,'Viernes':5,'Sábado':6}, t=map[m.dia]; let d=new Date(m.fechaInicio); while(d.getDay()!==t)d.setDate(d.getDate()+1); for(let i=0;i<16;i++){const iso=d.toISOString().split('T')[0], disp=`${d.getDate()}/${d.getMonth()+1}`; let st=m.cronograma?.[iso]||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase); if(m.modalidadBase==='Virtual')st='Virtual'; let b='bg-gray-100 text-gray-500', ic='help-circle'; if(st==='Presencial'){b='bg-red-100 text-red-700 border-red-200';ic='map-pin';}else if(st==='Virtual'){b='bg-blue-100 text-blue-700 border-blue-200';ic='video';}else if(st==='Asincronico'){b='bg-yellow-100 text-yellow-700 border-yellow-200';ic='book-open';}else if(st==='Sin Clase'){b='line-through opacity-50';ic='slash';} const plan = m.planificacion?.[iso] || {}; const temaVal = typeof plan === 'string' ? plan : (plan.tema || ''); const hasDetails = plan.biblio || plan.actClase || plan.actTarea; const infoIcon = hasDetails ? 'file-text' : 'plus-circle'; const infoColor = hasDetails ? 'text-blue-500' : 'text-gray-300'; l.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><div class="flex items-center justify-between mb-2"><span class="font-bold text-gray-700 text-sm w-12">${disp}</span><button onclick="cycle('${iso}')" class="flex-1 ml-4 py-1 px-3 rounded-lg font-bold text-[10px] uppercase flex items-center justify-center gap-2 ${b} badge-transition"><i data-lucide="${ic}" class="w-3 h-3"></i> ${st}</button></div><div class="flex gap-2 items-center"><input type="text" class="flex-1 text-sm bg-gray-50 p-2 rounded border border-transparent focus:bg-white focus:border-raspanti-dorado outline-none transition" placeholder="Tema..." value="${temaVal}" onchange="saveTemaSimple('${iso}', this.value)"><button onclick="openClaseDetail('${iso}')" class="p-2"><i data-lucide="${infoIcon}" class="w-5 h-5 ${infoColor}"></i></button></div></div>`; d.setDate(d.getDate()+7);} lucide.createIcons();}
        function cycle(iso){const db=DB.get(), m=db.materias.find(x=>x.id===activeId); if(!m.cronograma)m.cronograma={}; const sts=['Presencial','Virtual','Asincronico','Sin Clase'], c=m.cronograma[iso]||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase); m.cronograma[iso]=sts[(sts.indexOf(c)+1)%sts.length]; DB.save(db); renderCrono();}
        function saveTemaSimple(iso, val){const db=DB.get(), m=db.materias.find(x=>x.id===activeId); if(!m.planificacion) m.planificacion={}; if(!m.planificacion[iso]) m.planificacion[iso] = {}; if(typeof m.planificacion[iso] === 'string') m.planificacion[iso] = {tema: m.planificacion[iso]}; m.planificacion[iso].tema = val; DB.save(db);}
        function openClaseDetail(iso){activeDateISO = iso; const m=DB.get().materias.find(x=>x.id===activeId); const p = m.planificacion?.[iso] || {}; document.getElementById('detail-date').innerText = `Clase del ${iso.split('-').reverse().slice(0,2).join('/')}`; document.getElementById('detail-tema').value = p.tema || ''; document.getElementById('detail-biblio').value = p.biblio || ''; document.getElementById('detail-act-clase').value = p.actClase || ''; document.getElementById('detail-act-tarea').value = p.actTarea || ''; document.getElementById('modal-clase-detail').classList.remove('hidden');}
        function saveClaseDetail(){const db=DB.get(), m=db.materias.find(x=>x.id===activeId); if(!m.planificacion) m.planificacion={}; const p = {tema: document.getElementById('detail-tema').value, biblio: document.getElementById('detail-biblio').value, actClase: document.getElementById('detail-act-clase').value, actTarea: document.getElementById('detail-act-tarea').value}; m.planificacion[activeDateISO] = p; DB.save(db); closeModal('modal-clase-detail'); renderCrono();}
        function openImportModal() { document.getElementById('modal-import').classList.remove('hidden'); document.getElementById('input-import-text').value=''; }
        function processImport() { const raw = document.getElementById('input-import-text').value; if(!raw.trim()) { alert("Pega el contenido."); return; } const lines = raw.split('\n'); const db = DB.get(); const m = db.materias.find(x=>x.id===activeId); if(!m.planificacion) m.planificacion = {}; let count = 0; lines.forEach(line => { const parts = line.split('\t'); if(parts.length >= 1) { const dateRaw = parts[0].trim(); const match = dateRaw.match(/^(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/); if(match) { const day = match[1].padStart(2,'0'); const month = match[2].padStart(2,'0'); const year = match[3].length === 2 ? '20'+match[3] : match[3]; const isoDate = `${year}-${month}-${day}`; let idx = 1; if(parts[idx] && parts[idx].trim().length < 3 && !isNaN(parseInt(parts[idx]))) idx++; const tema = parts[idx] ? parts[idx].trim() : ""; const biblio = parts[idx+1] ? parts[idx+1].trim() : ""; const actClase = parts[idx+2] ? parts[idx+2].trim() : ""; const actTarea = parts[idx+3] ? parts[idx+3].trim() : ""; if(tema) { m.planificacion[isoDate] = { tema, biblio, actClase, actTarea }; count++; } } } }); DB.save(db); alert(`✅ Se importaron ${count} clases.`); closeModal('modal-import'); renderCrono(); }
        function iniciarTomaLista(){const h=new Date().toISOString().split('T')[0]; document.getElementById('input-fecha-lista').value=h; cambiarFechaLista(h); nav('lista');}
        function cambiarFechaLista(iso){activeDateISO=iso; const m=DB.get().materias.find(x=>x.id===activeId), c=document.getElementById('lista-check-container'); document.getElementById('lista-modalidad-badge').innerText=m.cronograma?.[iso]||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase); c.innerHTML=''; if(m.alumnos.length===0){c.innerHTML='<p class="text-center text-gray-400 mt-10">Sin alumnos.</p>';return;} let statusMap = m.asistencias?.[iso]; if(Array.isArray(statusMap)) { statusMap = null; } m.alumnos.forEach(al=>{const st = statusMap ? (statusMap[al.id] || 'A') : 'P'; const avatar = al.foto ? `<img src="${al.foto}" class="avatar-small">` : `<div class="avatar-small bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">${al.ape[0]}</div>`; c.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm"><div class="flex items-center gap-3">${avatar}<span class="font-bold text-gray-700 w-32 truncate">${al.ape}, ${al.nom}</span></div><button id="btn-as-${al.id}" onclick="cycleAsist(${al.id})" class="btn-asist st-${st}">${st}</button></div>`;});}
        function cycleAsist(uid){const btn=document.getElementById(`btn-as-${uid}`); const s=['P','T','J','A'], n=s[(s.indexOf(btn.innerText)+1)%s.length]; btn.className=`btn-asist st-${n}`; btn.innerText=n;}
        function guardarLista(){const db=DB.get(), m=db.materias.find(x=>x.id===activeId); if(!m.asistencias)m.asistencias={}; const map={}; m.alumnos.forEach(al=>{map[al.id]=document.getElementById(`btn-as-${al.id}`).innerText;}); m.asistencias[activeDateISO]=map; DB.save(db); alert('✅ Guardado'); nav('aula'); setTab('alumnos');}
        function cancelarLista(){nav('aula');}
        function previewImage(input){const file=input.files[0]; if(file){const reader=new FileReader(); reader.onload=function(e){const img=new Image(); img.src=e.target.result; img.onload=function(){const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); canvas.width=100; canvas.height=100; ctx.drawImage(img,0,0,100,100); tempFoto=canvas.toDataURL('image/jpeg',0.7); document.getElementById('preview-foto').src=tempFoto; document.getElementById('preview-foto').classList.remove('hidden'); document.getElementById('placeholder-foto').classList.add('hidden');}}; reader.readAsDataURL(file);}}
        function openAlumnoModal(idx=null){document.getElementById('title-alumno').innerText=idx!==null?'Editar Alumno':'Nuevo Alumno'; document.getElementById('edit-alum-idx').value=idx!==null?idx:''; tempFoto=''; document.getElementById('preview-foto').classList.add('hidden'); document.getElementById('placeholder-foto').classList.remove('hidden'); document.getElementById('input-alum-foto').value=''; if(idx!==null){const m=DB.get().materias.find(x=>x.id===activeId).alumnos[idx]; document.getElementById('input-alum-ape').value=m.ape; document.getElementById('input-alum-nom').value=m.nom; if(m.foto){tempFoto=m.foto; document.getElementById('preview-foto').src=m.foto; document.getElementById('preview-foto').classList.remove('hidden'); document.getElementById('placeholder-foto').classList.add('hidden');}} else{document.getElementById('input-alum-ape').value=''; document.getElementById('input-alum-nom').value='';} openModal('modal-alumno');}
        function guardarAlumno(){const db=DB.get(), m=db.materias.find(x=>x.id===activeId), idx=document.getElementById('edit-alum-idx').value, d={ape:document.getElementById('input-alum-ape').value, nom:document.getElementById('input-alum-nom').value, foto:tempFoto}; if(idx!==''){m.alumnos[idx]={...m.alumnos[idx],...d};}else{m.alumnos.push({id:Date.now(), ...d, notas:{}, obs:''});} m.alumnos.sort((a,b)=>a.ape.localeCompare(b.ape)); DB.save(db); closeModal('modal-alumno'); renderAlum();}
        function renderAlum(){const m=DB.get().materias.find(x=>x.id===activeId), l=document.getElementById('lista-alumnos'); l.innerHTML=''; const fs=m.asistencias?Object.keys(m.asistencias):[]; m.alumnos.forEach((al,i)=>{ let p=0; fs.forEach(f=>{ const s=m.asistencias[f][al.id]; if(s==='P'||s==='T')p++; }); const porc = fs.length>0 ? Math.round((p/fs.length)*100) : 100; const avatar = al.foto ? `<img src="${al.foto}" class="avatar-small">` : `<div class="avatar-small bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">${al.ape[0]}</div>`; const barColor = porc >= 75 ? 'bg-green-500' : (porc >= 60 ? 'bg-yellow-500' : 'bg-red-500'); l.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm"><div class="flex items-center gap-3 flex-1">${avatar}<div class="w-full pr-2"><span class="font-bold text-gray-700 text-sm block">${al.ape}, ${al.nom}</span><div class="flex justify-between items-center text-[10px] text-gray-400 mt-1"><span>Asistencia: ${porc}%</span></div><div class="progress-bar"><div class="progress-fill ${barColor}" style="width: ${porc}%"></div></div></div></div><div class="flex gap-1"><button onclick="openObs(${i})" class="text-gray-400 hover:text-blue-500 p-1"><i data-lucide="message-circle" class="w-4 ${al.obs?'text-blue-500 fill-blue-100':''}"></i></button><button onclick="openAlumnoModal(${i})" class="text-gray-400 hover:text-blue-500 p-1"><i data-lucide="pencil" class="w-4"></i></button><button onclick="delAlum(${i})" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4"></i></button></div></div>`; }); lucide.createIcons();}
        function delAlum(i){if(confirm('¿Quitar?')){const db=DB.get(); db.materias.find(x=>x.id===activeId).alumnos.splice(i,1); DB.save(db); renderAlum();}}
        function openObs(i){activeObsIdx=i; const m=DB.get().materias.find(x=>x.id===activeId).alumnos[i]; document.getElementById('obs-alum-name').innerText=`${m.ape}, ${m.nom}`; document.getElementById('input-obs-txt').value=m.obs||''; openModal('modal-obs');}
        function guardarObs(){const db=DB.get(); db.materias.find(x=>x.id===activeId).alumnos[activeObsIdx].obs=document.getElementById('input-obs-txt').value; DB.save(db); closeModal('modal-obs'); renderAlum();}
        function openExamModal(idx=null){document.getElementById('title-examen').innerText=idx!==null?'Editar':'Nuevo Examen'; document.getElementById('edit-exam-id').value=idx!==null?idx:''; if(idx!==null){const e=DB.get().materias.find(x=>x.id===activeId).examenes[idx]; document.getElementById('input-exam-nom').value=e.nombre; document.getElementById('input-exam-date').value=e.fecha;} else{document.getElementById('input-exam-nom').value='';} openModal('modal-examen');}
        function guardarExamen(){const db=DB.get(), m=db.materias.find(x=>x.id===activeId), idx=document.getElementById('edit-exam-id').value, d={nombre:document.getElementById('input-exam-nom').value, fecha:document.getElementById('input-exam-date').value}; if(idx!==''){m.examenes[idx]={...m.examenes[idx],...d};} else {m.examenes.push({id:Date.now(),...d});} DB.save(db); closeModal('modal-examen'); renderNotas();}
        function renderNotas(){const m=DB.get().materias.find(x=>x.id===activeId), h=document.getElementById('head-notas'), b=document.getElementById('body-notas'); h.innerHTML='<th class="p-3 sticky left-0 bg-gray-50 text-xs font-bold text-gray-500">ALUMNO</th>'; m.examenes.forEach((e,i)=>h.innerHTML+=`<th class="p-3 text-center min-w-[60px] text-xs font-bold text-gray-500 uppercase cursor-pointer hover:text-blue-600" onclick="openExamModal(${i})">${e.nombre} <i data-lucide="pencil" class="w-3 inline"></i></th>`); h.innerHTML+='<th class="p-3 text-center min-w-[60px] text-xs font-bold text-gray-700">PROM</th>'; b.innerHTML=''; m.alumnos.forEach((al,i)=>{let r=`<tr><td class="p-3 font-bold text-gray-700 sticky left-0 bg-white border-r text-sm truncate max-w-[120px]">${al.ape}, ${al.nom[0]}.</td>`; let s=0,c=0; m.examenes.forEach(e=>{const v=al.notas[e.id]||''; if(v){s+=parseFloat(v);c++;} const cl=(v&&v<4)?'text-red-500 bg-red-50':''; r+=`<td class="p-2 border-b"><input type="number" class="w-10 p-1 rounded border ${cl} input-nota" value="${v}" onchange="saveNota(${i},${e.id},this.value)"></td>`;}); const avg=c>0?(s/c).toFixed(2):'-', cl=avg!=='-'?(avg>=7?'text-green-600':(avg<4?'text-red-500':'text-gray-500')):'text-gray-300'; r+=`<td class="p-2 text-center border-b font-black ${cl}">${avg}</td></tr>`; b.innerHTML+=r;}); lucide.createIcons();}
        function saveNota(i,eid,v){const db=DB.get(); db.materias.find(x=>x.id===activeId).alumnos[i].notas[eid]=v; DB.save(db); renderNotas();}
        function exportarExcel(){const m=DB.get().materias.find(x=>x.id===activeId); if(!m)return; let c="data:text/csv;charset=utf-8,APELLIDO,NOMBRE"; const fs=m.asistencias?Object.keys(m.asistencias).sort():[]; fs.forEach(f=>{const [y,mm,d]=f.split('-'); c+=`,${d}/${mm}`;}); c+=",% ASIST"; m.examenes.forEach(e=>c+=","+e.nombre); c+=",PROMEDIO,OBSERVACIONES\n"; m.alumnos.forEach(a=>{c+=`${a.ape},${a.nom}`; let p=0; fs.forEach(f=>{const s=m.asistencias[f][a.id]||'A'; if(s==='P'||s==='T')p++; c+=`,${s}`;}); c+=`,${fs.length>0?Math.round((p/fs.length)*100):100}%`; let s=0,cnt=0; m.examenes.forEach(e=>{const v=a.notas[e.id]; c+=","+(v||"-"); if(v){s+=parseFloat(v);cnt++;}}); c+=`,${cnt>0?(s/cnt).toFixed(2):"-"},${(a.obs||"").replace(/,/g,' ')}\n`;}); const l=document.createElement("a"); l.setAttribute("href",encodeURI(c)); l.setAttribute("download",`Registro_${m.nombre}.csv`); document.body.appendChild(l); l.click(); l.remove();}
        function generarPDF(){const { jsPDF } = window.jspdf; const doc = new jsPDF(); const m = DB.get().materias.find(x => x.id === activeId); const prof = document.getElementById('dash-name').innerText; const fecha = new Date().toLocaleDateString(); doc.setFontSize(16); doc.setTextColor(128, 0, 32); doc.text("INSTITUTO RASPANTI", 105, 15, null, null, "center"); doc.setFontSize(12); doc.setTextColor(0); doc.text(`Planilla de Seguimiento - ${m.nombre}`, 105, 25, null, null, "center"); doc.setFontSize(10); doc.text(`Profesor: ${prof}  |  Fecha Impresión: ${fecha}`, 105, 32, null, null, "center"); doc.setFontSize(11); doc.setTextColor(128, 0, 32); doc.text("Registro de Asistencia", 14, 45); const headersAsist = [["Alumno", "% Asist", "Faltas"]]; const fs = m.asistencias ? Object.keys(m.asistencias) : []; const dataAsist = m.alumnos.map(a => { let p = 0; fs.forEach(f => { const s = m.asistencias[f][a.id] || 'A'; if (s === 'P' || s === 'T') p++; }); const porc = fs.length > 0 ? Math.round((p / fs.length) * 100) : 100; return [`${a.ape}, ${a.nom}`, `${porc}%`, `${fs.length - p}`]; }); doc.autoTable({ startY: 50, head: headersAsist, body: dataAsist, theme: 'grid', headStyles: { fillColor: [128, 0, 32] } }); let finalY = doc.lastAutoTable.finalY + 10; doc.text("Calificaciones", 14, finalY); const headersNotas = ["Alumno", ...m.examenes.map(e => e.nombre), "Promedio"]; const dataNotas = m.alumnos.map(a => { let s = 0, c = 0; const row = [`${a.ape}, ${a.nom}`]; m.examenes.forEach(e => { const v = a.notas[e.id]; row.push(v || "-"); if (v) { s += parseFloat(v); c++; } }); row.push(c > 0 ? (s / c).toFixed(2) : "-"); return row; }); doc.autoTable({ startY: finalY + 5, head: [headersNotas], body: dataNotas, theme: 'grid', headStyles: { fillColor: [50, 50, 50] } }); finalY = doc.lastAutoTable.finalY + 10; doc.text("Temas Dictados", 14, finalY); const headersPlan = [["Fecha", "Tema", "Actividad"]]; const sortedDates = Object.keys(m.planificacion || {}).sort(); const dataPlan = sortedDates.map(iso => { const p = m.planificacion[iso]; const t = typeof p === 'string' ? p : (p.tema || ''); const act = typeof p === 'object' ? (p.actClase || '') : ''; return [iso.split('-').reverse().join('/'), t, act]; }); doc.autoTable({ startY: finalY + 5, head: headersPlan, body: dataPlan, theme: 'striped' }); finalY = doc.lastAutoTable.finalY + 40; doc.line(120, finalY, 190, finalY); doc.setFontSize(9); doc.text("Firma del Docente", 155, finalY + 5, null, null, "center"); doc.save(`Planilla_${m.nombre}.pdf`); }
        function openSettings(){document.getElementById('modal-settings').classList.remove('hidden');}
        function downloadBackup(){ const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(DB.get())); const n=document.createElement('a'); n.setAttribute("href",s); n.setAttribute("download","raspanti_backup.json"); document.body.appendChild(n); n.click(); n.remove(); }
        function restoreBackup(i){ const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){try{const d=JSON.parse(e.target.result); if(!d.materias)throw new Error(); DB.save(d); alert("✅ Datos restaurados!"); location.reload();}catch(e){alert("❌ Archivo inválido.");}}; r.readAsText(f); }
        function openModal(id){document.getElementById(id).classList.remove('hidden');} function closeModal(id){document.getElementById(id).classList.add('hidden');}
        let deferredPrompt; const isIos=/iPhone|iPad|iPod/.test(navigator.userAgent), isPwa=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;
        window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;showInstallModal();});
        window.addEventListener('load',()=>{if(!isPwa&&!sessionStorage.getItem('install_closed'))setTimeout(showInstallModal,2000);});
        function showInstallModal(){document.getElementById('install-modal').classList.remove('hidden'); if(isIos)document.getElementById('install-ios').classList.remove('hidden'); else document.getElementById('install-android').classList.remove('hidden');}
        function closeInstall(){document.getElementById('install-modal').classList.add('hidden'); sessionStorage.setItem('install_closed','true');}
        async function triggerInstall(){if(deferredPrompt){deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;deferredPrompt=null;if(outcome==='accepted')closeInstall();}else{
            document.getElementById('install-guide-arrow').classList.remove('hidden');
            setTimeout(() => document.getElementById('install-guide-arrow').classList.add('hidden'), 5000);
        }}
    </script>
</body>
</html>
