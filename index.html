<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raspanti Docente</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#800020">
    <link rel="apple-touch-icon" href="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        raspanti: { bordo: '#800020', crema: '#FFFDD0', dorado: '#C5B358' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; font-family: system-ui, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .badge-transition { transition: all 0.2s ease; }
        .badge-transition:active { transform: scale(0.9); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        .task-check:checked + div { text-decoration: line-through; opacity: 0.5; }
        .input-nota { min-width: 40px; text-align: center; }
        
        /* Botones Asistencia */
        .btn-asist { width: 35px; height: 35px; border-radius: 50%; font-weight: 900; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; transition: all 0.2s; }
        .st-P { background: #DCFCE7; color: #166534; border-color: #166534; }
        .st-T { background: #FEF9C3; color: #854D0E; border-color: #854D0E; }
        .st-J { background: #DBEAFE; color: #1E40AF; border-color: #1E40AF; }
        .st-A { background: #FEE2E2; color: #991B1B; border-color: #991B1B; }
        
        /* Avatar & Progress */
        .avatar-upload { width: 80px; height: 80px; border-radius: 50%; background: #f3f4f6; border: 2px dashed #d1d5db; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #e5e7eb; }
        .progress-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 bg-slate-50">

    <div id="auth-screen" class="fixed inset-0 bg-raspanti-bordo z-40 flex flex-col items-center justify-center p-6 text-center text-white">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center border-4 border-raspanti-dorado mb-6 text-raspanti-bordo text-4xl font-black">R</div>
        <h1 class="text-2xl font-bold uppercase mb-8">Instituto Raspanti<br><span class="text-raspanti-dorado text-sm">Agenda Docente</span></h1>
        <button onclick="login()" class="bg-white text-raspanti-bordo w-full max-w-xs py-4 rounded-xl font-bold shadow-lg hover:bg-gray-100 transition">INGRESAR</button>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden relative">
        
        <header class="bg-raspanti-bordo text-white p-4 flex justify-between items-center shadow-md z-20 pt-safe-top">
            <div class="flex items-center gap-3">
                <div class="bg-white text-raspanti-bordo font-black p-1 rounded">R</div>
                <span class="font-bold text-sm uppercase">Mi Agenda</span>
            </div>
            <button onclick="openSettings()" class="opacity-90 hover:opacity-100 transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24 max-w-md mx-auto w-full no-scrollbar">
            
            <div id="view-dashboard" class="fade-in space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold text-raspanti-bordo flex items-center gap-2 cursor-pointer" onclick="editProfileName()">
                                <span id="dash-name">Hola Profe</span> <i data-lucide="pencil" class="w-3 h-3 text-gray-300"></i>
                            </h2>
                            <p class="text-gray-500 text-sm" id="fecha-hoy">Cargando...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-raspanti-bordo text-white p-5 rounded-2xl shadow-lg">
                    <h3 class="font-bold mb-3 border-b border-white/20 pb-2">Clases de Hoy</h3>
                    <div id="lista-hoy" class="text-sm space-y-2"></div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4 text-raspanti-dorado"></i> Planificación Semanal</h3>
                    <div id="lista-semana" class="text-sm space-y-3">
                        </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-700">Tareas</h3><button onclick="openModal('modal-tarea')" class="text-xs bg-raspanti-crema text-raspanti-bordo px-2 py-1 rounded font-bold hover:bg-raspanti-dorado transition">+ NUEVA</button></div>
                    <div id="lista-tareas" class="space-y-2"></div>
                    <p id="no-tareas" class="text-center text-xs text-gray-400 mt-2 hidden">Sin tareas pendientes.</p>
                </div>
            </div>

            <div id="view-materias" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-raspanti-bordo">Mis Materias</h2><button onclick="openMateriaModal()" class="bg-raspanti-bordo text-white p-2 rounded-lg shadow"><i data-lucide="plus"></i></button></div>
                <div id="lista-materias" class="space-y-3"></div>
                <p id="no-materias" class="text-center text-gray-400 text-sm mt-10 hidden">No hay materias.</p>
            </div>

            <div id="view-aula" class="hidden fade-in space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <button onclick="nav('materias')" class="text-gray-500 text-xs font-bold flex items-center gap-1"><i data-lucide="arrow-left" class="w-3"></i> VOLVER</button>
                    <div class="flex gap-2">
                        <button onclick="iniciarTomaLista()" class="bg-raspanti-bordo text-white px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="check-square" class="w-3 h-3"></i> ASISTENCIA</button>
                        <button onclick="exportarExcel()" class="bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm"><i data-lucide="download" class="w-3 h-3"></i> EXCEL</button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <span id="aula-modalidad" class="text-[10px] bg-raspanti-crema text-raspanti-bordo px-2 py-1 rounded font-bold uppercase">--</span>
                    <h2 id="aula-nombre" class="text-2xl font-black text-raspanti-bordo mt-2 leading-tight">Materia</h2>
                </div>
                <div class="flex bg-white p-1 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                    <button onclick="setTab('crono')" id="btn-crono" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg bg-raspanti-crema text-raspanti-bordo">CRONOGRAMA</button>
                    <button onclick="setTab('alumnos')" id="btn-alumnos" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400">ALUMNOS</button>
                    <button onclick="setTab('notas')" id="btn-notas" class="flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400">NOTAS</button>
                </div>
                
                <div id="tab-crono" class="space-y-3">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-800 flex gap-2"><i data-lucide="info" class="w-4 h-4 shrink-0"></i><p>Toca el botón para cambiar modalidad. Escribe abajo el tema del día.</p></div>
                    <div id="lista-cronograma" class="space-y-3"></div>
                </div>

                <div id="tab-alumnos" class="hidden space-y-3">
                    <div class="flex justify-between items-center px-1"><h3 class="font-bold text-gray-600 text-sm">Padrón</h3><button onclick="openAlumnoModal()" class="text-xs bg-raspanti-dorado text-white px-3 py-1 rounded shadow font-bold">AGREGAR</button></div>
                    <div id="lista-alumnos" class="space-y-2"></div>
                </div>
                <div id="tab-notas" class="hidden space-y-3">
                    <div class="flex justify-between items-center px-1"><h3 class="font-bold text-gray-600 text-sm">Libro de Notas</h3><button onclick="openExamModal()" class="text-xs bg-raspanti-bordo text-white px-3 py-1 rounded shadow font-bold">NUEVO EXAMEN</button></div>
                    <div class="overflow-x-auto bg-white rounded-xl border border-gray-100 shadow-sm"><table class="w-full text-sm"><thead><tr id="head-notas" class="bg-gray-50 text-gray-500 text-left"><th class="p-3">Alumno</th></tr></thead><tbody id="body-notas"></tbody></table></div>
                </div>
            </div>

            <div id="view-lista" class="hidden fade-in space-y-4">
                <button onclick="cancelarLista()" class="text-gray-500 text-xs font-bold flex items-center gap-1"><i data-lucide="x" class="w-3"></i> CANCELAR</button>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-end mb-2">
                         <p class="text-[10px] font-bold text-gray-400 uppercase">FECHA</p>
                         <span id="lista-modalidad-badge" class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">--</span>
                    </div>
                    <input type="date" id="input-fecha-lista" onchange="cambiarFechaLista(this.value)" class="w-full p-2 bg-gray-50 rounded-lg border font-bold text-raspanti-bordo text-lg mb-2">
                    <div class="flex justify-center gap-3 text-[10px] font-bold text-gray-400 mb-2">
                        <span><span class="text-green-700">P</span>resente</span>
                        <span><span class="text-yellow-700">T</span>arde</span>
                        <span><span class="text-blue-700">J</span>ustif</span>
                        <span><span class="text-red-700">A</span>usente</span>
                    </div>
                    <button onclick="guardarLista()" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-600 transition flex justify-center items-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> GUARDAR</button>
                </div>
                <div id="lista-check-container" class="space-y-2 pb-10"></div>
            </div>
        </main>

        <nav id="navbar" class="fixed bottom-0 w-full bg-white border-t border-gray-200 h-16 flex justify-around items-center z-30 pb-safe-bottom">
            <button onclick="nav('dashboard')" id="nav-dash" class="flex flex-col items-center text-raspanti-bordo w-full h-full justify-center">
                <i data-lucide="layout-dashboard" class="w-5 mb-1"></i><span class="text-[10px] font-bold">Inicio</span>
            </button>
            <button onclick="nav('materias')" id="nav-mat" class="flex flex-col items-center text-gray-400 w-full h-full justify-center">
                <i data-lucide="book" class="w-5 mb-1"></i><span class="text-[10px] font-bold">Materias</span>
            </button>
        </nav>
    </div>

    <div id="modal-tarea" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4">Nueva Tarea</h3><input id="input-tarea-txt" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Descripción"><div class="flex gap-2"><button onclick="closeModal('modal-tarea')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarTarea()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    
    <div id="modal-materia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4" id="title-materia">Nueva Materia</h3><input type="hidden" id="edit-mat-id"><label class="text-xs font-bold text-gray-500 ml-1">NOMBRE</label><input id="input-mat-nombre" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold" placeholder="Ej: Matemática"><label class="text-xs font-bold text-gray-500 ml-1">INICIO CURSADA</label><input type="date" id="input-mat-inicio" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold"><div class="grid grid-cols-2 gap-2 mb-4"><div><label class="text-xs font-bold text-gray-500 ml-1">DÍA</label><select id="input-mat-dia" class="w-full p-3 bg-gray-50 rounded-lg border font-bold text-gray-700"><option value="Lunes">Lunes</option><option value="Martes">Martes</option><option value="Miércoles">Miércoles</option><option value="Jueves">Jueves</option><option value="Viernes">Viernes</option></select></div><div><label class="text-xs font-bold text-gray-500 ml-1">MODALIDAD</label><select id="input-mat-mod" class="w-full p-3 bg-gray-50 rounded-lg border font-bold text-gray-700"><option value="Hibrida">Mixta</option><option value="Presencial">Presencial</option><option value="Virtual">Virtual</option></select></div></div><div class="flex gap-2"><button onclick="closeModal('modal-materia')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarMateria()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    
    <div id="modal-alumno" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-black text-raspanti-bordo mb-4" id="title-alumno">Nuevo Alumno</h3>
            <input type="hidden" id="edit-alum-idx">
            <div class="flex justify-center mb-4"><label for="input-alum-foto" class="avatar-upload group"><img id="preview-foto" src="" class="hidden"><div id="placeholder-foto" class="text-gray-400 text-center text-[10px] font-bold"><i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>Foto</div><input type="file" id="input-alum-foto" class="hidden" accept="image/*" onchange="previewImage(this)"></label></div>
            <input id="input-alum-ape" class="w-full p-3 bg-gray-50 rounded-lg mb-2 border font-bold" placeholder="Apellido"><input id="input-alum-nom" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold" placeholder="Nombre">
            <div class="flex gap-2"><button onclick="closeModal('modal-alumno')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarAlumno()" class="flex-1 py-3 bg-raspanti-dorado text-white rounded-lg font-bold shadow">Guardar</button></div>
        </div>
    </div>
    
    <div id="modal-examen" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-4" id="title-examen">Nuevo Examen/TP</h3><input type="hidden" id="edit-exam-id"><input id="input-exam-nom" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border font-bold" placeholder="Nombre"><label class="text-xs font-bold text-gray-500 ml-1">FECHA</label><input type="date" id="input-exam-date" class="w-full p-3 bg-gray-50 rounded-lg mb-4 border font-bold"><div class="flex gap-2"><button onclick="closeModal('modal-examen')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarExamen()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-obs" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="text-lg font-black text-raspanti-bordo mb-2">Observación</h3><p id="obs-alum-name" class="text-sm font-bold text-gray-500 mb-3"></p><textarea id="input-obs-txt" class="w-full p-3 bg-gray-50 rounded-lg border h-32 mb-4" placeholder="Escribe una observación..."></textarea><div class="flex gap-2"><button onclick="closeModal('modal-obs')" class="flex-1 py-3 text-gray-500 font-bold">Cancelar</button><button onclick="guardarObs()" class="flex-1 py-3 bg-raspanti-bordo text-white rounded-lg font-bold shadow">Guardar</button></div></div></div>
    <div id="modal-settings" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center"><h3 class="text-lg font-black text-raspanti-bordo mb-6">Configuración</h3><div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-100"><i data-lucide="download" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i><h4 class="font-bold text-blue-800">Copia de Seguridad</h4><button onclick="downloadBackup()" class="bg-blue-600 text-white w-full py-2 rounded-lg font-bold text-sm shadow mt-2">DESCARGAR</button></div><div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-200"><i data-lucide="upload" class="w-8 h-8 text-gray-500 mx-auto mb-2"></i><h4 class="font-bold text-gray-700">Restaurar</h4><input type="file" id="file-restore" class="hidden" onchange="restoreBackup(this)"><button onclick="document.getElementById('file-restore').click()" class="bg-gray-200 text-gray-700 w-full py-2 rounded-lg font-bold text-sm mt-2">SELECCIONAR ARCHIVO</button></div><button onclick="closeModal('modal-settings')" class="block w-full mt-4 text-gray-400 text-sm font-bold">Cerrar</button></div></div>
    
    <div id="install-modal" class="fixed inset-0 z-[70] bg-black/60 hidden flex items-end sm:items-center justify-center backdrop-blur-sm"><div class="bg-white w-full sm:max-w-md rounded-t-[30px] sm:rounded-[30px] p-6 slide-up shadow-2xl relative"><button onclick="closeInstall()" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button><div class="flex items-center gap-4 mb-4"><div class="w-16 h-16 bg-raspanti-bordo rounded-2xl flex items-center justify-center border-4 border-raspanti-dorado shadow-md text-white font-black text-2xl">R</div><div><h3 class="font-bold text-lg leading-tight">Instalar App</h3><p class="text-xs text-gray-500">Mejor experiencia.</p></div></div><div id="install-ios" class="hidden space-y-3 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl border border-gray-100"><p>1. Toca <strong>Compartir</strong> <i data-lucide="share" class="w-4 h-4 text-blue-500"></i></p><p>2. <strong>"Agregar a Inicio"</strong> <i data-lucide="plus-square" class="w-4 h-4 text-gray-800"></i></p></div><div id="install-android" class="hidden"><button onclick="triggerInstall()" class="w-full bg-raspanti-bordo text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2"><i data-lucide="download" class="w-5 h-5"></i> INSTALAR</button></div></div></div>

    <script>
        // --- DB ---
        const DB={get:()=>JSON.parse(localStorage.getItem('raspanti_v10'))||{materias:[], tareas:[], profileName:'Hola Profe'}, save:(d)=>localStorage.setItem('raspanti_v10',JSON.stringify(d))};
        let activeId=null, activeDateISO=null, activeObsIdx=null, tempFoto=''; 

        // --- CORE ---
        lucide.createIcons();
        if(localStorage.getItem('raspanti_logged')){document.getElementById('auth-screen').classList.add('hidden');document.getElementById('app-content').classList.remove('hidden');initDash();}
        function login(){localStorage.setItem('raspanti_logged','true');location.reload();}
        function logout(){localStorage.removeItem('raspanti_logged');location.reload();}
        function nav(v){ ['dashboard','materias','aula','lista'].forEach(id=>document.getElementById('view-'+id).classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); const d=document.getElementById('nav-dash'),m=document.getElementById('nav-mat'); if(v==='dashboard'){d.classList.replace('text-gray-400','text-raspanti-bordo');m.classList.replace('text-raspanti-bordo','text-gray-400');initDash();}else{m.classList.replace('text-gray-400','text-raspanti-bordo');d.classList.replace('text-raspanti-bordo','text-gray-400');if(v==='materias')renderMaterias();} document.getElementById('navbar').style.display=(v==='aula'||v==='lista')?'none':'flex'; }
        
        // --- BACKUP ---
        function openSettings(){document.getElementById('modal-settings').classList.remove('hidden');}
        function downloadBackup(){ const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(DB.get())); const n=document.createElement('a'); n.setAttribute("href",s); n.setAttribute("download","raspanti_backup.json"); document.body.appendChild(n); n.click(); n.remove(); }
        function restoreBackup(i){ const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){try{const d=JSON.parse(e.target.result); if(!d.materias)throw new Error(); DB.save(d); alert("✅ Datos restaurados!"); location.reload();}catch(e){alert("❌ Archivo inválido.");}}; r.readAsText(f); }

        // --- DASHBOARD (PLANNER INTEGRADO) ---
        function initDash(){
            const d=new Date(), dias=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'], h=d.toISOString().split('T')[0];
            document.getElementById('fecha-hoy').innerText=`${dias[d.getDay()]}, ${d.getDate()}/${d.getMonth()+1}`;
            const db=DB.get(); document.getElementById('dash-name').innerText=db.profileName||'Hola Profe';
            
            // Hoy
            const l=document.getElementById('lista-hoy'); l.innerHTML=''; let y=false;
            db.materias.forEach(m=>{ let t=m.cronograma?.[h]; if(t&&t!=='Sin Clase'){y=true; let c='bg-gray-400',x=''; if(t==='Presencial'){c='bg-red-500';x='(Inst.)';}else if(t==='Virtual'){c='bg-blue-400';x='(Zoom)';}else if(t==='Asincronico'){c='bg-yellow-400';x='(Campus)';} l.innerHTML+=`<div class="bg-white/10 p-3 rounded-lg flex items-center gap-3"><div class="w-3 h-3 ${c} rounded-full border border-white/20"></div><div><strong class="block text-sm">${m.nombre}</strong><span class="text-xs opacity-80 uppercase font-bold">${t} ${x}</span></div></div>`; } });
            if(!y)l.innerHTML='<span class="opacity-60 italic text-sm">Sin clases hoy.</span>';
            
            // Planificación Semanal (NEW)
            const ls=document.getElementById('lista-semana'); ls.innerHTML=''; let ys=false;
            // Calcular Lunes a Viernes de esta semana
            let current = new Date(); 
            const first = current.getDate() - current.getDay() + 1; // Lunes
            let monday = new Date(current.setDate(first));
            
            for(let i=0; i<5; i++){ // Lun a Vie
                let loopDate = new Date(monday); 
                loopDate.setDate(monday.getDate() + i);
                let iso = loopDate.toISOString().split('T')[0];
                let dayName = dias[loopDate.getDay()];
                
                db.materias.forEach(m => {
                    // Check si hay planificacion (temas)
                    if(m.temas && m.temas[iso]){
                        ys=true;
                        ls.innerHTML += `
                        <div class="border-l-2 border-raspanti-dorado pl-3 py-1">
                            <span class="text-xs font-bold text-gray-400 uppercase block">${dayName} - ${m.nombre}</span>
                            <p class="text-sm font-medium text-gray-700">${m.temas[iso]}</p>
                        </div>`;
                    }
                });
            }
            if(!ys) ls.innerHTML = '<span class="text-xs text-gray-400 italic">Nada planificado esta semana.</span>';

            renderTareas();
        }
        function editProfileName(){const n = prompt("Ingresa tu nombre:", document.getElementById('dash-name').innerText); if(n){ const db=DB.get(); db.profileName=n; DB.save(db); initDash(); }}
        function renderTareas(){const db=DB.get(),l=document.getElementById('lista-tareas'); l.innerHTML=''; if(db.tareas.length===0){document.getElementById('no-tareas').classList.remove('hidden');return;} document.getElementById('no-tareas').classList.add('hidden'); db.tareas.forEach((t,i)=>{l.innerHTML+=`<div class="flex items-center gap-3 p-2 border-b border-gray-50 last:border-0"><input type="checkbox" class="task-check w-5 h-5 rounded border-gray-300 text-raspanti-bordo focus:ring-raspanti-bordo" ${t.done?'checked':''} onchange="toggleTarea(${i})"><div class="flex-1 text-sm font-medium text-gray-700">${t.text}</div><button onclick="borrarTarea(${i})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4"></i></button></div>`;}); lucide.createIcons();}
        function guardarTarea(){const db=DB.get(); db.tareas.push({text:document.getElementById('input-tarea-txt').value, done:false}); DB.save(db); closeModal('modal-tarea'); renderTareas();}
        function toggleTarea(i){const db=DB.get(); db.tareas[i].done=!db.tareas[i].done; DB.save(db); renderTareas();}
        function borrarTarea(i){const db=DB.get(); db.tareas.splice(i,1); DB.save(db); renderTareas();}

        // --- MATERIAS ---
        function openMateriaModal(id=null){
            document.getElementById('title-materia').innerText=id?'Editar Materia':'Nueva Materia'; document.getElementById('edit-mat-id').value=id||'';
            if(id){const m=DB.get().materias.find(x=>x.id==id); document.getElementById('input-mat-nombre').value=m.nombre; document.getElementById('input-mat-inicio').value=m.fechaInicio; document.getElementById('input-mat-dia').value=m.dia; document.getElementById('input-mat-mod').value=m.modalidadBase;}
            else{document.getElementById('input-mat-nombre').value='';} openModal('modal-materia');
        }
        function guardarMateria(){
            const db=DB.get(), eid=document.getElementById('edit-mat-id').value;
            const mat={nombre:document.getElementById('input-mat-nombre').value, modalidadBase:document.getElementById('input-mat-mod').value, dia:document.getElementById('input-mat-dia').value, fechaInicio:document.getElementById('input-mat-inicio').value||new Date().toISOString().split('T')[0]};
            if(eid){const idx=db.materias.findIndex(x=>x.id==eid); db.materias[idx]={...db.materias[idx],...mat};}
            else{mat.id=Date.now(); mat.cronograma={}; mat.temas={}; mat.alumnos=[]; mat.examenes=[]; mat.asistencias={}; db.materias.push(mat);}
            DB.save(db); closeModal('modal-materia'); renderMaterias();
        }
        function renderMaterias(){const l=document.getElementById('lista-materias'); l.innerHTML=''; const db=DB.get(); document.getElementById('no-materias').classList.toggle('hidden',db.materias.length>0); db.materias.forEach(m=>{l.innerHTML+=`<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div onclick="abrirAula(${m.id})" class="flex-1"><h3 class="font-bold text-gray-800">${m.nombre}</h3><div class="text-xs text-gray-400 font-bold uppercase mt-1">${m.dia} • ${m.modalidadBase}</div></div><div class="flex gap-1"><button onclick="openMateriaModal(${m.id})" class="text-gray-400 hover:text-blue-500 p-2"><i data-lucide="pencil" class="w-4"></i></button><button onclick="borrarMateria(${m.id})" class="text-gray-400 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4"></i></button></div></div>`;}); lucide.createIcons();}
        function borrarMateria(id){if(confirm('¿Eliminar?')){const db=DB.get(); db.materias=db.materias.filter(m=>m.id!==id); DB.save(db); renderMaterias();}}

        // --- AULA & PLANNER ---
        function abrirAula(id){activeId=id; const m=DB.get().materias.find(x=>x.id===id); document.getElementById('aula-nombre').innerText=m.nombre; document.getElementById('aula-modalidad').innerText=m.modalidadBase; nav('aula'); setTab('crono');}
        function setTab(t){['crono','alumnos','notas'].forEach(x=>{document.getElementById('tab-'+x).classList.add('hidden'); document.getElementById('btn-'+x).className='flex-1 py-2 px-1 text-[10px] font-bold rounded-lg text-gray-400';}); document.getElementById('tab-'+t).classList.remove('hidden'); document.getElementById('btn-'+t).className='flex-1 py-2 px-1 text-[10px] font-bold rounded-lg bg-raspanti-crema text-raspanti-bordo'; if(t==='crono')renderCrono(); if(t==='alumnos')renderAlum(); if(t==='notas')renderNotas();}
        
        function renderCrono(){
            const m=DB.get().materias.find(x=>x.id===activeId), l=document.getElementById('lista-cronograma'); l.innerHTML='';
            const map={'Domingo':0,'Lunes':1,'Martes':2,'Miércoles':3,'Jueves':4,'Viernes':5,'Sábado':6}, t=map[m.dia];
            let d=new Date(m.fechaInicio); while(d.getDay()!==t)d.setDate(d.getDate()+1);
            for(let i=0;i<16;i++){const iso=d.toISOString().split('T')[0], disp=`${d.getDate()}/${d.getMonth()+1}`; let st=m.cronograma?.[iso]||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase); if(m.modalidadBase==='Virtual')st='Virtual';
                let b='bg-gray-100 text-gray-500', ic='help-circle';
                if(st==='Presencial'){b='bg-red-100 text-red-700 border-red-200';ic='map-pin';}else if(st==='Virtual'){b='bg-blue-100 text-blue-700 border-blue-200';ic='video';}else if(st==='Asincronico'){b='bg-yellow-100 text-yellow-700 border-yellow-200';ic='book-open';}else if(st==='Sin Clase'){b='line-through opacity-50';ic='slash';}
                
                // PLANNER INPUT
                const temaVal = (m.temas && m.temas[iso]) ? m.temas[iso] : '';
                
                l.innerHTML+=`
                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-bold text-gray-700 text-sm w-12">${disp}</span>
                        <button onclick="cycle('${iso}')" class="flex-1 ml-4 py-1 px-3 rounded-lg font-bold text-[10px] uppercase flex items-center justify-center gap-2 ${b} badge-transition"><i data-lucide="${ic}" class="w-3 h-3"></i> ${st}</button>
                    </div>
                    <input type="text" class="w-full text-sm bg-gray-50 p-2 rounded border border-transparent focus:bg-white focus:border-raspanti-dorado outline-none transition" placeholder="Escribe el tema..." value="${temaVal}" onchange="saveTema('${iso}', this.value)">
                </div>`;
                d.setDate(d.getDate()+7);
            } lucide.createIcons();
        }
        function cycle(iso){const db=DB.get(), m=db.materias.find(x=>x.id===activeId); if(!m.cronograma)m.cronograma={}; const sts=['Presencial','Virtual','Asincronico','Sin Clase'], c=m.cronograma[iso]||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase); m.cronograma[iso]=sts[(sts.indexOf(c)+1)%sts.length]; DB.save(db); renderCrono();}
        
        // SAVE TEMA (PLANNER)
        function saveTema(iso, val){
            const db=DB.get(), m=db.materias.find(x=>x.id===activeId);
            if(!m.temas) m.temas={};
            m.temas[iso] = val;
            DB.save(db);
        }

        // --- TOMAR LISTA ---
        function iniciarTomaLista(){const h=new Date().toISOString().split('T')[0]; document.getElementById('input-fecha-lista').value=h; cambiarFechaLista(h); nav('lista');}
        function cambiarFechaLista(iso){
            activeDateISO=iso; const m=DB.get().materias.find(x=>x.id===activeId), c=document.getElementById('lista-check-container');
            document.getElementById('lista-modalidad-badge').innerText=m.cronograma?.[iso]||((m.modalidadBase==='Hibrida')?'Presencial':m.modalidadBase);
            c.innerHTML=''; if(m.alumnos.length===0){c.innerHTML='<p class="text-center text-gray-400 mt-10">Sin alumnos.</p>';return;}
            let statusMap = m.asistencias?.[iso]; if(Array.isArray(statusMap)) { statusMap = null; } 
            m.alumnos.forEach(al=>{
                const st = statusMap ? (statusMap[al.id] || 'A') : 'P';
                const avatar = al.foto ? `<img src="${al.foto}" class="avatar-small">` : `<div class="avatar-small bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">${al.ape[0]}</div>`;
                c.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3">${avatar}<span class="font-bold text-gray-700 w-32 truncate">${al.ape}, ${al.nom}</span></div>
                    <button id="btn-as-${al.id}" onclick="cycleAsist(${al.id})" class="btn-asist st-${st}">${st}</button>
                </div>`;
            });
        }
        function cycleAsist(uid){const btn=document.getElementById(`btn-as-${uid}`); const s=['P','T','J','A'], n=s[(s.indexOf(btn.innerText)+1)%s.length]; btn.className=`btn-asist st-${n}`; btn.innerText=n;}
        function guardarLista(){const db=DB.get(), m=db.materias.find(x=>x.id===activeId); if(!m.asistencias)m.asistencias={}; const map={}; m.alumnos.forEach(al=>{map[al.id]=document.getElementById(`btn-as-${al.id}`).innerText;}); m.asistencias[activeDateISO]=map; DB.save(db); alert('✅ Guardado'); nav('aula'); setTab('alumnos');}
        function cancelarLista(){nav('aula');}

        // --- ALUMNOS (FOTOS + PROGRESO) ---
        function previewImage(input){const file=input.files[0]; if(file){const reader=new FileReader(); reader.onload=function(e){const img=new Image(); img.src=e.target.result; img.onload=function(){const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); canvas.width=100; canvas.height=100; ctx.drawImage(img,0,0,100,100); tempFoto=canvas.toDataURL('image/jpeg',0.7); document.getElementById('preview-foto').src=tempFoto; document.getElementById('preview-foto').classList.remove('hidden'); document.getElementById('placeholder-foto').classList.add('hidden');}}; reader.readAsDataURL(file);}}
        function openAlumnoModal(idx=null){
            document.getElementById('title-alumno').innerText=idx!==null?'Editar Alumno':'Nuevo Alumno'; document.getElementById('edit-alum-idx').value=idx!==null?idx:''; tempFoto=''; document.getElementById('preview-foto').classList.add('hidden'); document.getElementById('placeholder-foto').classList.remove('hidden'); document.getElementById('input-alum-foto').value='';
            if(idx!==null){const m=DB.get().materias.find(x=>x.id===activeId).alumnos[idx]; document.getElementById('input-alum-ape').value=m.ape; document.getElementById('input-alum-nom').value=m.nom; if(m.foto){tempFoto=m.foto; document.getElementById('preview-foto').src=m.foto; document.getElementById('preview-foto').classList.remove('hidden'); document.getElementById('placeholder-foto').classList.add('hidden');}}
            else{document.getElementById('input-alum-ape').value=''; document.getElementById('input-alum-nom').value='';} openModal('modal-alumno');
        }
        function guardarAlumno(){
            const db=DB.get(), m=db.materias.find(x=>x.id===activeId), idx=document.getElementById('edit-alum-idx').value, d={ape:document.getElementById('input-alum-ape').value, nom:document.getElementById('input-alum-nom').value, foto:tempFoto};
            if(idx!==''){m.alumnos[idx]={...m.alumnos[idx],...d};}else{m.alumnos.push({id:Date.now(), ...d, notas:{}, obs:''});} m.alumnos.sort((a,b)=>a.ape.localeCompare(b.ape)); DB.save(db); closeModal('modal-alumno'); renderAlum();
        }
        function renderAlum(){
            const m=DB.get().materias.find(x=>x.id===activeId), l=document.getElementById('lista-alumnos'); l.innerHTML='';
            const fs=m.asistencias?Object.keys(m.asistencias):[];
            m.alumnos.forEach((al,i)=>{
                let p=0; fs.forEach(f=>{ const s=m.asistencias[f][al.id]; if(s==='P'||s==='T')p++; });
                const porc = fs.length>0 ? Math.round((p/fs.length)*100) : 100;
                const avatar = al.foto ? `<img src="${al.foto}" class="avatar-small">` : `<div class="avatar-small bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">${al.ape[0]}</div>`;
                const barColor = porc >= 75 ? 'bg-green-500' : (porc >= 60 ? 'bg-yellow-500' : 'bg-red-500');
                const riskLabel = porc < 60 ? '<span class="text-red-500 text-[9px] font-black uppercase ml-1">RIESGO</span>' : '';
                l.innerHTML+=`<div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm">
                    <div class="flex items-center gap-3 flex-1">${avatar}<div class="w-full pr-2"><span class="font-bold text-gray-700 text-sm block">${al.ape}, ${al.nom}</span><div class="flex justify-between items-center text-[10px] text-gray-400 mt-1"><span>Asistencia: ${porc}% ${riskLabel}</span></div><div class="progress-bar"><div class="progress-fill ${barColor}" style="width: ${porc}%"></div></div></div></div>
                    <div class="flex gap-1"><button onclick="openObs(${i})" class="text-gray-400 hover:text-blue-500 p-1"><i data-lucide="message-circle" class="w-4 ${al.obs?'text-blue-500 fill-blue-100':''}"></i></button><button onclick="openAlumnoModal(${i})" class="text-gray-400 hover:text-blue-500 p-1"><i data-lucide="pencil" class="w-4"></i></button><button onclick="delAlum(${i})" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4"></i></button></div></div>`;
            }); lucide.createIcons();
        }
        function delAlum(i){if(confirm('¿Quitar?')){const db=DB.get(); db.materias.find(x=>x.id===activeId).alumnos.splice(i,1); DB.save(db); renderAlum();}}
        function openObs(i){activeObsIdx=i; const m=DB.get().materias.find(x=>x.id===activeId).alumnos[i]; document.getElementById('obs-alum-name').innerText=`${m.ape}, ${m.nom}`; document.getElementById('input-obs-txt').value=m.obs||''; openModal('modal-obs');}
        function guardarObs(){const db=DB.get(); db.materias.find(x=>x.id===activeId).alumnos[activeObsIdx].obs=document.getElementById('input-obs-txt').value; DB.save(db); closeModal('modal-obs'); renderAlum();}

        // --- NOTAS (EDIT) ---
        function openExamModal(idx=null){document.getElementById('title-examen').innerText=idx!==null?'Editar':'Nuevo Examen'; document.getElementById('edit-exam-id').value=idx!==null?idx:''; if(idx!==null){const e=DB.get().materias.find(x=>x.id===activeId).examenes[idx]; document.getElementById('input-exam-nom').value=e.nombre; document.getElementById('input-exam-date').value=e.fecha;} else{document.getElementById('input-exam-nom').value='';} openModal('modal-examen');}
        function guardarExamen(){const db=DB.get(), m=db.materias.find(x=>x.id===activeId), idx=document.getElementById('edit-exam-id').value, d={nombre:document.getElementById('input-exam-nom').value, fecha:document.getElementById('input-exam-date').value}; if(idx!==''){m.examenes[idx]={...m.examenes[idx],...d};} else {m.examenes.push({id:Date.now(),...d});} DB.save(db); closeModal('modal-examen'); renderNotas();}
        function renderNotas(){const m=DB.get().materias.find(x=>x.id===activeId), h=document.getElementById('head-notas'), b=document.getElementById('body-notas'); h.innerHTML='<th class="p-3 sticky left-0 bg-gray-50 text-xs font-bold text-gray-500">ALUMNO</th>'; m.examenes.forEach((e,i)=>h.innerHTML+=`<th class="p-3 text-center min-w-[60px] text-xs font-bold text-gray-500 uppercase cursor-pointer hover:text-blue-600" onclick="openExamModal(${i})">${e.nombre} <i data-lucide="pencil" class="w-3 inline"></i></th>`); h.innerHTML+='<th class="p-3 text-center min-w-[60px] text-xs font-bold text-gray-700">PROM</th>'; b.innerHTML=''; m.alumnos.forEach((al,i)=>{let r=`<tr><td class="p-3 font-bold text-gray-700 sticky left-0 bg-white border-r text-sm truncate max-w-[120px]">${al.ape}, ${al.nom[0]}.</td>`; let s=0,c=0; m.examenes.forEach(e=>{const v=al.notas[e.id]||''; if(v){s+=parseFloat(v);c++;} const cl=(v&&v<4)?'text-red-500 bg-red-50':''; r+=`<td class="p-2 border-b"><input type="number" class="w-10 p-1 rounded border ${cl} input-nota" value="${v}" onchange="saveNota(${i},${e.id},this.value)"></td>`;}); const avg=c>0?(s/c).toFixed(2):'-', cl=avg!=='-'?(avg>=7?'text-green-600':(avg<4?'text-red-500':'text-gray-500')):'text-gray-300'; r+=`<td class="p-2 text-center border-b font-black ${cl}">${avg}</td></tr>`; b.innerHTML+=r;}); lucide.createIcons();}
        function saveNota(i,eid,v){const db=DB.get(); db.materias.find(x=>x.id===activeId).alumnos[i].notas[eid]=v; DB.save(db); renderNotas();}
        function exportarExcel(){const m=DB.get().materias.find(x=>x.id===activeId); if(!m)return; let c="data:text/csv;charset=utf-8,APELLIDO,NOMBRE"; const fs=m.asistencias?Object.keys(m.asistencias).sort():[]; fs.forEach(f=>{const [y,mm,d]=f.split('-'); c+=`,${d}/${mm}`;}); c+=",% ASIST"; m.examenes.forEach(e=>c+=","+e.nombre); c+=",PROMEDIO,OBSERVACIONES\n"; m.alumnos.forEach(a=>{c+=`${a.ape},${a.nom}`; let p=0; fs.forEach(f=>{const s=m.asistencias[f][a.id]||'A'; if(s==='P'||s==='T')p++; c+=`,${s}`;}); c+=`,${fs.length>0?Math.round((p/fs.length)*100):100}%`; let s=0,cnt=0; m.examenes.forEach(e=>{const v=a.notas[e.id]; c+=","+(v||"-"); if(v){s+=parseFloat(v);cnt++;}}); c+=`,${cnt>0?(s/cnt).toFixed(2):"-"},${(a.obs||"").replace(/,/g,' ')}\n`;}); const l=document.createElement("a"); l.setAttribute("href",encodeURI(c)); l.setAttribute("download",`Registro_${m.nombre}.csv`); document.body.appendChild(l); l.click(); l.remove();}

        // --- UTILS & PWA ---
        function openModal(id){document.getElementById(id).classList.remove('hidden');} function closeModal(id){document.getElementById(id).classList.add('hidden');}
        let deferredPrompt; const isIos=/iPhone|iPad|iPod/.test(navigator.userAgent), isPwa=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;
        window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;showInstallModal();});
        window.addEventListener('load',()=>{if(!isPwa&&!sessionStorage.getItem('install_closed'))setTimeout(showInstallModal,2000);});
        function showInstallModal(){document.getElementById('install-modal').classList.remove('hidden'); if(isIos)document.getElementById('install-ios').classList.remove('hidden'); else document.getElementById('install-android').classList.remove('hidden');}
        function closeInstall(){document.getElementById('install-modal').classList.add('hidden'); sessionStorage.setItem('install_closed','true');}
        async function triggerInstall(){if(deferredPrompt){deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;deferredPrompt=null;if(outcome==='accepted')closeInstall();}else{alert('Usa el menú del navegador para instalar.');}}
    </script>
</body>
</html>
